function formatDate(e,t){if(e){switch(t||(t="yyyy-MM-dd"),typeof e){case"string":e=new Date(e.replace(/-/g,"/"));break;case"number":e=new Date(e)}if(!(!e instanceof Date)){var s={yyyy:e.getFullYear(),M:e.getMonth()+1,d:e.getDate(),H:e.getHours(),m:e.getMinutes(),s:e.getSeconds(),MM:(""+(e.getMonth()+101)).substr(1),dd:(""+(e.getDate()+100)).substr(1),HH:(""+(e.getHours()+100)).substr(1),mm:(""+(e.getMinutes()+100)).substr(1),ss:(""+(e.getSeconds()+100)).substr(1)};return t.replace(/(yyyy|MM?|dd?|HH?|ss?|mm?)/g,function(){return s[arguments[0]]})}}}function appRouteConfig(e){e.when("/shops",{templateUrl:"admin/shops/index.html",controller:"ShopsCtr"}).when("/shops/add",{templateUrl:"admin/shops/add.html",controller:"ShopsAddCtr"}).when("/shops/add/:shopId",{templateUrl:"admin/shops/add.html",controller:"ShopsAddreturnCtr"}).when("/shops/add2/:shopId",{templateUrl:"admin/shops/add2.html",controller:"ShopsAdd2Ctr"}).when("/shops/add3/:shopId",{templateUrl:"admin/shops/add3.html",controller:"ShopsAdd3Ctr"}).when("/shops/show/:shopId",{templateUrl:"admin/shops/show.html",controller:"ShopsShowCtr"}).when("/staff",{templateUrl:"admin/Staff/index.html",controller:"StaffCtr"}).when("/staff/:shopId",{templateUrl:"admin/Staff/index.html",controller:"StaffCtr"}).when("/staff/show/:shopId",{templateUrl:"admin/Staff/show.html",controller:"StaffShowCtr"}).when("/staff/staffadd/:shopId",{templateUrl:"admin/Staff/staffadd.html",controller:"StaffaddCtr"}).when("/staff/staffedit/:guestid",{templateUrl:"admin/Staff/staffedit.html",controller:"StaffeditCtr"}).when("/staff/keeperedit/:guestid",{templateUrl:"admin/Staff/keeperedit.html",controller:"StaffeditCtr"}).when("/staff/keeperadd/:shopId",{templateUrl:"admin/Staff/keeperadd.html",controller:"StaffaddCtr"}).when("/staff/password/:guestid",{templateUrl:"admin/Staff/password.html",controller:"passwordCtr"}).when("/password",{templateUrl:"my/password.html",controller:"edit_passwordCtr"}).when("/rule",{templateUrl:"admin/rule/index.html",controller:"RuleCtr"}).when("/rule/add",{templateUrl:"admin/rule/add.html",controller:"RuleAddCtr"}).when("/rule/add2/:activityid",{templateUrl:"admin/rule/add2.html",controller:"RuleAdd2Ctr"}).when("/rule/edit/:activityid",{templateUrl:"admin/rule/ruleedit.html",controller:"RuleAddCtr"}).when("/rule/edit2/:activityid",{templateUrl:"admin/rule/ruleedit2.html",controller:"RuleAdd2Ctr"}).when("/rule/edit3/:activityid",{templateUrl:"admin/rule/ruleedit3.html",controller:"RuleAdd3Ctr"}).when("/rule/member",{templateUrl:"admin/rule/member.html",controller:"RuleMemberCtr"}).when("/rule/coupon",{templateUrl:"admin/rule/coupon.html",controller:"RuleCouponCtr"}).when("/customer/charge/:userId",{templateUrl:"admin/customer/charge.html",controller:"CustomerChargeCtr"}).when("/customer/point/:userId",{templateUrl:"admin/customer/point.html",controller:"CustomerPoicustomerntCtr"}).when("/customer/coupon/:userId",{templateUrl:"admin/customer/coupon.html",controller:"CustomerCouponCtr"}).when("/customer/add",{templateUrl:"admin/customer/add.html",controller:"CustomerAddCtr"}).when("/customer/detail/:userId",{templateUrl:"admin/customer/detail.html",controller:"CustomerDetailCtr"}).when("/customer",{templateUrl:"admin/customer/index.html",controller:"CustomerCtr"}).when("/test",{templateUrl:"test.html",controller:"TestCtr"}).when("/devices",{templateUrl:"admin/devices/index.html",controller:"DevicesCtr"}).when("/dish/add",{templateUrl:"admin/dish/add.html",controller:"DishAddCtr"}).when("/dish",{templateUrl:"admin/dish/index.html",controller:"DishCtr"}).when("/dish/edit/:dishId",{templateUrl:"admin/dish/add.html",controller:"DishEditCtr"}).when("/doc",{templateUrl:"admin/doc/index.html",controller:"DocCtr"}).when("/finance",{templateUrl:"admin/finance/index.html",controller:"FinanceCtr"}).when("/notice",{templateUrl:"admin/notice/index.html",controller:"NoticeCtr"}).when("/notice/validate",{templateUrl:"admin/notice/validate.html",controller:"NoticeValidateCtr"}).when("/notice/expired",{templateUrl:"admin/notice/expired.html",controller:"NoticeExpiredCtr"}).otherwise({redirectTo:"/shops"})}function getObjectURL(e){var t=null;return void 0!=window.createObjectURL?t=window.createObjectURL(e):void 0!=window.URL?t=window.URL.createObjectURL(e):void 0!=window.webkitURL&&(t=window.webkitURL.createObjectURL(e)),t}appRouteConfig.$inject=["$routeProvider"];var notNull=function(e){return null!=e&&e&&""!=e},uniqArr=function(e){if(e)return e.filter(function(e,t,s){return s.indexOf(e)==t})},getSubtimes=function(e,t){var s={};return angular.forEach(e,function(e,s){t[e]&&(this[e]=t[e])},s),s},isEmptyObject=function(e){for(var t in e)return!1;return!0},objectCount=function(e){var t=0;return angular.forEach(e,function(e,s){t++}),t};getShareCategory=function(e){for(var t=[],s=sharedActivitys[e],a=0;s&&a<s.length;a++){var o={};o.id=s[a],o.name=allRuleCategory[s[a]],t.push(o)}return t},objectKeys=function(e){var t=[];return angular.forEach(e,function(e,t){this.push(t)},t),t},arrayMap=function(e,t){var s=[];return"function"==typeof t?angular.forEach(e,function(e,s){var a=e;a=t(e),this.push(a)},s):s=e,s},arrayFilter=function(e,t){var s=[];return"function"==typeof t?angular.forEach(e,function(e,s){t(e)&&this.push(e)},s):s=e,s},mapFilter=function(e,t){var s={};return"function"==typeof t?angular.forEach(e,function(e,s){t(e)&&(this[s]=e)},s):s=e,s},formatDatas=function(e){if(e)if(e.constructor===Array){var t={};angular.forEach(e,function(e,t){this[e]=!0},t)}else t=e;else t={};return t},angular.module("app").config(appRouteConfig),app.controller("ShopsCtr",["$scope","$location","$http",function(e,t,s){e.config.breadset=[{name:"门店管理",href:indexUrl+"/admin.html#/shops"},{name:"门店列表"}],e.bussniessTime={1001:"早市",1002:"午市",1003:"下午茶",1004:"晚市",1005:"宵夜"},e.text={1001:"",1002:"提交认证时间：",1003:"认证通过时间：",1004:"提交关闭时间",1005:"停用时间"},e.detailShow=-1;var a=ajaxSendFn({count:10},"/shops/shops","GET");200!=a.code&&t.path("/shops/add"),e.shops=a.result,e.select=function(){var t={};e.active&&(t.state=e.active),e.shops=ajaxSendFn(t,"/shops/shops","GET").result},e.$watch("shops.page",function(t,s){if(t&&s&&t!==s){var a={page:e.shops.page,count:e.shops.count};e.active&&(a.state=e.active),e.shops=ajaxSendFn(a,"/shops/shops","GET").result}}),e.send=function(){e.shops=ajaxSendFn({name:e.name},"/shops/shops","GET").result},e.detail=function(t,s){e.shop=ajaxSendFn({},"/shops/shop/"+t,"GET",1).result,e.detailShow=s},e.deleteShopFn=function(){if(confirm("是否确定申请关闭?")){var t=ajaxSendFn({},"/shops/shop/"+e.shop.id,"POST");200==t.code?alert("申请关闭成功！"):errorMsg(t)}}}]),app.controller("ShopsAddCtr",["$scope","$location",function(e,t){e.config.breadset=[{name:"门店管理",href:indexUrl+"/admin.html#/shops"},{name:"添加门店"}],e.posts={},e.shopType=[{code:1001,text:"支持桌边付"},{code:1002,text:"不支持桌边付"}],e.posts.shopType=e.shopType[0].code,e.areaJson1=ajaxSendFn({},"/dict/area","GET").result,e.area1change=function(){e.areaJson2=ajaxSendFn({code:e.area.area1},"/dict/area","GET").result||[],e.area.area2=e.areaJson2[0]&&e.areaJson2[0].code,e.areaJson3=!!e.area.area2&&(ajaxSendFn({code:e.area.area2},"/dict/area","GET").result||[]),e.posts.area=e.areaJson3[0]&&e.areaJson3[0].code||e.areaJson2[0]&&e.areaJson2[0].code||e.areaJson1[0]&&e.areaJson1[0].code},e.area2change=function(){e.areaJson3=ajaxSendFn({code:e.area.area2},"/dict/area","GET").result||[],e.posts.area=e.areaJson3[0]&&e.areaJson3[0].code||e.area.area2},e.postSend=function(){if(/[(())]/.test(e.posts.name))return e.config.modalContent="请不要输入带括弧的名称",void $(".modal").modal("show");var s=ajaxSendFn(e.posts,"/shops/shop","POST",1);return 200!=s.code?(e.config.modalContent=s.message,void $(".modal").modal("show")):void t.path("/shops/add2/"+s.result.id)}}]),app.controller("ShopsAddreturnCtr",["$scope","$location","$routeParams",function(e,t,s){e.config.breadset=[{name:"门店管理",href:indexUrl+"/admin.html#/shops"},{name:"添加门店"}],shopTypes=ajaxSendFn({},"/dict/SHOP_TYPE/item","GET").result,e.shopget=ajaxSendFn({},"/shops/shop/"+s.shopId,"GET").result.shop,e.shopType=shopTypes,e.posts={id:e.shopget.id,area:e.shopget.area,name:e.shopget.name,shopCode:e.shopget.shopCode,shopType:e.shopget.shopType,tel:e.shopget.tel}}]),app.controller("ShopsAdd2Ctr",["$scope","$location","$routeParams",function(e,t,s){e.config.breadset=[{name:"门店管理",href:indexUrl+"/admin.html#/shops"},{name:"添加店长"}],e.posts={},e.postSend=function(){sendJsons={name:e.posts.name,nickname:e.posts.nickname,password:hex_md5(e.posts.password),shopId:s.shopId,roleType:"K"};for(var a in sendJsons)""!=sendJsons[a]&&sendJsons[a]&&null!=sendJsons||delete sendJsons[a];return sendJson=JSON.stringify(sendJsons),postsend=ajaxSendFn(sendJson,constUrlDict.staff,"POST",1),200!=postsend.code?void alert(postsend.message):void t.path("/shops/add3/"+s.shopId)},e.reshpwd=function(){console.log(e.staffadd_form),e.repassword==e.posts.password?e.staffadd_form.repassword.$error.pattern=!1:e.staffadd_form.repassword.$error.pattern=!0}}]),app.controller("ShopsAdd3Ctr",["$scope","$location","$routeParams",function(e,t,s){e.config.breadset=[{name:"门店管理",href:indexUrl+"/admin.html#/shops"},{name:"添加完成"}],shopsget=ajaxSendFn({},"/shops/shop/"+s.shopId,"GET"),e.shopshow=200==shopsget.code&&shopsget.result}]),app.controller("ShopsShowCtr",["$scope","$routeParams","$http",function(e,t,s){e.shopId=t.shopId,e.config.breadset=[{name:"门店管理",href:indexUrl+"/admin.html#/shops"},{name:"门店状态"}],e.shopshow={result:{businesstime:{}}},e.bussniessTime={1001:"早市",1002:"午市",1003:"下午茶",1004:"晚市",1005:"宵夜"};var a=ajaxSendFn({},"/shops/shop/"+t.shopId,"GET",1);e.shopshow.result=a.result||{},e.shopshow.result.shopType=shopTypeJson[e.shopshow.result.shopType],e.shopshow.result.latitude&&e.shopshow.result.longitude&&(e.shopshow.map="http://restapi.amap.com/v3/staticmap?zoom=16&size=180*120&markers=-1,http://api.amap.com/Public/imgbox/static/8.png,0:"+e.shopshow.result.longitude+","+e.shopshow.result.latitude+"&key=ee95e52bf08006f63fd29bcfbcf21df0",e.deleteShopFn=function(){if(confirm("是否确定申请关闭?")){ajaxSendFn({},"/shops/shop/"+t.shopId,"POST");e.shopshow.result.state="1004",200==a.code?alert("申请关闭成功！"):errorMsg(a)}})}]),app.controller("StaffCtr",["$scope","$routeParams",function(e,t){e.config.breadset=[{name:"员工管理",href:indexUrl+"/admin.html#/staff"},{name:"员工列表"}];var s=ajaxSendFn({count:10},constUrlDict["staffs-base"],"GET");if(e.staffs=s.result||[],e.$watch("staffs.page",function(t,s){if(t&&s&&t!==s){var a={page:e.staffs.page,count:e.staffs.count};e.staffs=ajaxSendFn(a,constUrlDict["staffs-base"],"GET").result}}),e.detail=function(t,s){e.staff=ajaxSendFn({shopId:t},constUrlDict["staffs-shop"],"GET",1).result,e.detailShow=s},e.modal=function(t,s){e.staffget=ajaxSendFn({},constUrlDict.staff+"/"+t,"GET").result,$("#"+s).modal("show")},e.delete=function(t){if(!confirm("一旦删除将不可恢复，是否确认删除？"))return!1;var s=ajaxSendFn({},constUrlDict["staffs-base"]+"/"+t,"POST");200==s.code?(alert("删除成功"),e.staff=ajaxSendFn({shopId:e.staffs.items[e.detailShow].id},constUrlDict["staffs-shop"],"GET").result):errorMsg(s)},e.postSend=function(){var t=e.staffget.id;delete e.staffget.id,result=ajaxSendFn(JSON.stringify(e.staffget),"/staffs/staff/"+t,"POST",1),200==result.code?($("#edit").modal("hide"),e.staff=ajaxSendFn({shopId:e.staffget.shopId},constUrlDict["staffs-shop"],"GET",1).result):errorMsg(result)},e.resetPassword=function(){if(!e.staffadd_form.$valid)return void(e.staffadd_form.submitted=!0);var t={};angular.extend(t,e.posts),t.password=hex_md5(e.posts.password),result=ajaxSendFn(t,constUrlDict["staffs-password"]+"/"+e.staffget.id,"POST"),200==result.code?($("#password").modal("hide"),alert("修改成功")):errorMsg(result)},t.shopId)for(var a=0;a<e.staffs.items.length;a++)t.shopId==e.staffs.items[a].id&&e.detail(t.shopId,a)}]),app.controller("StaffShowCtr",["$scope","$location","$routeParams",function(e,t,s){e.user={},e.user.list={keeper:[],staffs:[]},e.user.shopId=s.shopId,e.config.breadset=[{name:"员工管理",href:indexUrl+"/admin.html#/staff"},{name:"员工列表"}],e.shopget=ajaxSendFn({},"/shops/shop/"+s.shopId,"GET").result;var a=ajaxSendFn({shopId:s.shopId},constUrlDict["staffs-shop"],"GET").result;e.user.get=a?a.items:[],e.user.get=e.user.get?e.user.get:"";for(var o=0;o<e.user.get.length;o++)"K"==e.user.get[o].roleType?e.user.list.keeper=e.user.get[o]:e.user.list.staffs.push(e.user.get[o]);e.staffDelFn=function(t){return!!confirm("一旦删除将不可恢复，是否确认删除？")&&(staffDelRe=ajaxSendFn({},constUrlDict["staffs-base"]+"/"+e.user.list.staffs[t].id,"POST"),void(200==staffDelRe.code?(e.user.list.staffs.splice(t,1),alert("删除成功")):errorMsg(staffDelRe)))},e.keepperDelFn=function(){return!!confirm("一旦删除将不可恢复，是否确认删除？")&&(staffDelRe=ajaxSendFn({},constUrlDict["staffs-base"]+"/"+e.user.list.keeper.id,"POST"),void(200==staffDelRe.code?e.user.list.keeper=null:errorMsg(staffDelRe)))}}]),app.controller("StaffaddCtr",["$scope","$location","$routeParams",function(e,t,s){e.show={},e.posts={},e.staffadd_form={},e.config.breadset=[{name:"员工管理",href:indexUrl+"/admin.html#/staff"},{name:"添加员工"}],e.shopsget=ajaxSendFn({},"/shops/shop/"+s.shopId,"GET").result,e.textCheckJson=textCheckJson,e.textCheckErrorJson=textCheckErrorJson,e.staffadd_form.submitted=!1,e.posts.gender=0,e.shopId=s.shopId,e.staffaddsend=function(a){var o={};o=e.posts,o.shopId=s.shopId,o.roleType="keeper"==a?"K":"S",result=ajaxSendFn(JSON.stringify(o),constUrlDict.staff,"POST",1),200==result.code?(alert("添加成功"),t.path("/staff/show/"+s.shopId)):errorMsg(result)}}]),app.controller("StaffeditCtr",["$scope","$location","$routeParams","$http",function(e,t,s,a){e.posts={},e.staffadd_form={},e.config.breadset=[{name:"员工管理",href:indexUrl+"/admin.html#/staff"},{name:"编辑员工"}],e.staffget=ajaxSendFn({},constUrlDict.staff+"/"+s.guestid,"GET").result,e.staffadd_form.submitted=!1,e.posts.gender=e.staffget.gender,e.posts.nickname=e.staffget.nickname,e.posts.shopId=e.staffget.shopId,e.show={};var o=ajaxSendFn({},"/shops/shop/"+e.staffget.shopId,"GET",1);console.log(o),200==o.code&&(e.show.shopname=o.result.name),e.staffaddsend=function(){e.posts.shopId=e.staffget.shopId;var s=JSON.stringify(e.posts);result=ajaxSendFn(s,constUrlDict.staff+"/"+e.staffget.id,"POST",1),200==result.code?(alert("修改成功"),t.path("/staff/show/"+e.staffget.shopId)):errorMsg(result)}}]),app.controller("passwordCtr",["$scope","$location","$routeParams",function(e,t,s){e.show={},e.posts={},e.staffadd_form={},e.config.breadset=[{name:"员工管理",href:indexUrl+"/admin.html#/Staff"},{name:"重设密码"}],e.staffget=ajaxSendFn({},constUrlDict.staff+"/"+s.guestid,"GET").result,e.textCheckJson=textCheckJson,e.textCheckErrorJson=textCheckErrorJson,e.staffadd_form.submitted=!1,e.staffget.shopname=ajaxSendFn({},"/shops/shop/"+e.staffget.shopId,"GET").result.name,e.staffaddsend=function(){if(!e.staffadd_form.$valid)return void(e.staffadd_form.submitted=!0);var s={};angular.extend(s,e.posts),s.password=hex_md5(e.posts.password),result=ajaxSendFn(s,constUrlDict["staffs-password"]+"/"+e.staffget.id,"POST"),200==result.code?(alert("修改成功"),t.path("/staff/show/"+e.staffget.shopId)):errorMsg(result)}}]),app.controller("RuleCtr",["$rootScope","$scope","$location","$filter",function(e,t,s,a){t.config.breadset=[{name:"活动管理",href:indexUrl+"/admin.html#/rule"},{name:"活动列表"}];var o=ajaxSendFn({},"/activity","GET").result||[],n=e.lastShow;t.ruleDic={nonParticipations:"不参与活动商品",periods:"有效时段",time:"时间",shops:"分店"},t.view={},t.view.rule=a("orderBy")(o,"createTime",!0),null!=n&&(t.view.rule[n].show=1),t.pannel=function(s){if(null!=n&&n>=0&&s===n)t.view.rule[s].show=0,n=-1,delete e.lastShow;else{var a=t.view.rule[s]._id;t.view.rule[s].rulesget||(tem=ajaxSendFn({},"/activity/"+a+"/rules","GET"),200==tem.code&&(t.view.rule[s].rulesget=tem.result)),$.each(t.view.rule,function(e){t.view.rule[e].show=0}),t.view.rule[s].show=1,n=s,e.lastShow=n}},t.activityOn=function(e,s){re=ajaxSendFn({},"/activity/"+e+"/on","POST"),200==re.code?t.view.rule[s].on=!0:errorMsg(re)},t.activityOff=function(e,s){re=ajaxSendFn({},"/activity/"+e+"/off","POST"),200==re.code?t.view.rule[s].on=!1:console.error(re)},t.activityDel=function(e,s){re=ajaxSendFn({},"/activity/"+e,"DELETE"),200==re.code?t.view.rule.splice(s,1):alert(re.message)},t.activeFn=function(e,s){if(re=ajaxSendFn({},"/activity/"+e+"/"+s,"POST"),200==re.code){var o=ajaxSendFn({},"/activity","GET").result||[];t.view.rule=a("orderBy")(o,"createTime",!0)}else alert(re.message)}}]),app.controller("RuleAddCtr",["$scope","$location","$filter","$routeParams",function(e,t,s,a){e.config.breadset=[{name:"活动管理",href:indexUrl+"/admin.html#/rule"},{name:"设置活动范围"}],e.checkshop={},e.set={times:ajaxSendFn({},"/businesstimes/all","GET").result,list:ajaxSendFn({state:1002},"/shops","GET").result,list2:[],timeType:{1001:"早市",1002:"午市",1003:"下午茶",1004:"晚市",1005:"宵夜"},periods:[]},e.set.time=getSubtimes(e.set.times,e.set.timeType),e.set.list||(alert("目前还没有添加门店"),t.path("/shops")),e.set.nonParticipation=ajaxSendFn({},"/nonParticipation","GET").result,e.checkallstr=0,e.posts={periods:[],excludeWeekend:!1,excludeHoliday:!1,shared:[],shops:[]},e.view={data:{},effectDates:{},periods:[],zhiding:e.config.time},a.activityid?e.view.isEdit=!0:e.view.isEdit=!1,e.ruleCategory=ruleCategory,e.$watch("posts.activityCategory",function(t,s){t&&t!==s&&(e.shareRuleCategory=getShareCategory(t))}),e.filterShared=function(){return arrayFilter(e.posts.shared,function(e){return!!e})},e.checkAllCatagory=function(){e.posts.catagoryAll?angular.forEach(e.shareRuleCategory,function(e,t){this[t]=e.id},e.posts.shared):e.posts.shared=[]},e.categoryName=function(t){var s={};if(t){t.split("_")[0];angular.forEach(e.ruleCategory,function(e,s){e.id===t&&(this.name=e.name)},s)}return s.name||"类型错误"},e.$watch("set.shopAll",function(t,s){t!==s&&(t?angular.forEach(e.set.list,function(e,t){this[t]=e.id},e.posts.shops):e.posts.shops=[])}),e.settime=function(t,s){e.view.periods[t]=e.view.periods[t]?null:s},e.sendJsons=function(){sendtype=a.activityid?"EDIT":"ADD",sendid=a.activityid?a.activityid:"",e.posts.shops=arrRemoveNullFN(e.posts.shops),e.posts.periods=arrRemoveNullFN(e.view.periods);var o={dateRange:{}};if(o.nonParticipationId=e.posts.nonParticipationId,o.shared=uniqArr(arrRemoveNullFN(e.posts.shared)),o.name=e.posts.name,o.activityCategory=e.posts.activityCategory,o.shops=e.posts.shops,o.periods=e.posts.periods,o.excludeAmount=e.posts.excludeAmount,o.dateRangeCategory=e.view.data.dateType,"BIRTHDAY"===e.view.data.dateType&&e.view.data.subType&&(o.dateRangeCategory=e.view.data.subType),"CONTINUOUS"===e.view.data.dateType){if(!e.view.dateRange.startDate||!e.view.dateRange.endDate)return void alert("请填写开始和结束日期!");if(e.view.dateRange.endDate<e.view.dateRange.startDate)return void alert("结束日期不能小于开始日期!");o.dateRange.startDate=s("date")(e.view.dateRange.startDate,"yyyy-MM-dd 00:00:00"),o.dateRange.endDate=s("date")(e.view.dateRange.endDate,"yyyy-MM-dd 23:59:59")}else"BIRTHDAY"===e.view.data.dateType&&"AROUND_FIX_DATE"===e.view.data.subType&&(o.dateRange.beforeDays=e.view.dateRange.beforeDays||0,o.dateRange.afterDays=e.view.dateRange.afterDays||0);if(o.dateRange.selectCategory=e.view.dateRange.selectCategory||"NONE","MANUAL_SELECT"===e.view.dateRange.subType){var n=arrayMap(objectKeys(e.view.dateRange.selectDates),function(e){return e+" 00:00:00"});isEmptyObject(n)||(o.dateRange.selectDates=n)}else if("MONTH_DAYS"===e.view.dateRange.subType){var n=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectDays,notNull)),parseInt);isEmptyObject(n)||(o.dateRange.selectDays=n)}else if("WEEKLY_DAY"===e.view.dateRange.subType){var n=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectWeekDays,notNull)),parseInt);isEmptyObject(n)||(o.dateRange.selectWeekDays=n)}return"SELECTED_DATES"!==o.dateRangeCategory&&"EXCLUDE"===o.dateRange.selectCategory&&1==objectCount(o.dateRange)?void alert("没有指定排除日期！"):"SELECTED_DATES"===o.dateRangeCategory&&1==objectCount(o.dateRange)&&o.dateRange.selectCategory?void alert("没有指定日期！"):(sendJson=JSON.stringify(o),postsend=ajaxSendFn(sendJson,concatUrl(constUrlDict.activity,sendid),"POST",1),void(200==postsend.code?"ADD"==sendtype?t.path("/rule/add2/"+postsend.result.id):(alert("保存成功"),history.back()):errorMsg(postsend)))},e.addNonParticipation=function(){e.goods="",$("#NonParticipation").modal("show")},e.NonParticipationSend=function(){send=ajaxSendFn({items:e.goods.name},"/nonParticipation","POST",2),200==send.code&&(e.set.nonParticipation||(e.set.nonParticipation={}),e.set.nonParticipation._id=send.result,e.set.nonParticipation.items=e.goods.name,$("#NonParticipation").modal("hide"))},e.oldFN=function(){var t=ajaxSendFn({},concatUrl(constUrlDict.activity,a.activityid)+"/detail","GET").result;if(t){e.posts.name=t.name,e.posts.hasRules=t.rules&&t.rules.length>0||!1,e.posts.activityCategory=t.activityCategory,e.view.data.dateType=t.dateRangeCategory,"AROUND_FIX_DATE"!==t.dateRangeCategory&&"MONTH_EFFECTIVE"!==t.dateRangeCategory||(e.view.data.dateType="AROUND_FIX_DATE",e.view.data.subType=t.dateRangeCategory),e.view.data[e.view.data.dateType]={dateRange:t.dateRange},e.view.dateRange=e.view.data[e.view.data.dateType].dateRange,t.dateRange&&(t.dateRange.selectDates?(e.view.dateRange.subType="MANUAL_SELECT",e.view.dateRange.selectDates=arrayMap(e.view.dateRange.selectDates,function(e){return e.split(/\s+/)[0]})):t.dateRange.selectDays?e.view.dateRange.subType="MONTH_DAYS":e.view.dateRange.subType="WEEKLY_DAY"),e.posts.activityCategory&&(e.shareRuleCategory=getShareCategory(e.posts.activityCategory)),e.posts.excludeAmount=t.excludeAmount,e.posts.nonParticipationId=t.nonParticipationId;var s={};if(t.shops)for(var o=0,n=t.shops.length||0;o<n;o++)s[t.shops[o]]=1;for(var o=0,n=e.set.list.length||0;o<n;o++)e.set.list[o].id in s&&(e.posts.shops[o]=e.set.list[o].id);angular.forEach(e.set.time,function(e,t){this.push(t)},e.view.periods),angular.forEach(e.view.periods,function(e,s){t.periods&&t.periods.indexOf(e)!=-1||(this[s]=null)},e.view.periods),angular.forEach(e.shareRuleCategory,function(e,s){t.shared&&t.shared.indexOf(e.id)!=-1?this[s]=e.id:this[s]=!1},e.posts.shared)}},a.activityid&&e.oldFN()}]),app.controller("RuleDISCOUNTCtr",["$scope",function(e){e.DISCOUNT.posts={type:"DISCOUNT"},e.DISCOUNT.posts.detail=[],e.DISCOUNT.addFn=function(){e.DISCOUNT.posts.detail.push({member:e.view.member[0].id})},e.DISCOUNT.removeFn=function(t){e.DISCOUNT.posts.detail.splice(t,1)},e.DISCOUNT.addFn()}]),app.controller("RuleLIMITCtr",["$scope","$location",function(e,t){e.LIMIT.posts={type:"LIMIT_PREMENT"},e.LIMIT.posts.detail=[],e.LIMIT.addFn=function(){console.log(e.LIMIT.posts),e.LIMIT.posts.detail.push({member:e.view.member[0].id})},e.LIMIT.removeFn=function(t){e.LIMIT.posts.detail.splice(t,1)},e.LIMIT.addFn()}]),app.controller("RulEspendasCtr",["$scope","$location",function(e,t){e.SPEND.posts={type:"SPEND"},e.SPEND.posts.detail=[],e.SPEND.addFn=function(){console.log(e.SPEND.posts),e.SPEND.posts.detail.push({member:e.view.member[0].id})},e.SPEND.removeFn=function(t){e.SPEND.posts.detail.splice(t,1)},e.SPEND.addFn()}]),app.controller("RulSpecialpriceCtr",["$scope","$location",function(e,t){e.SPECIAL.posts={type:"SPECIAL"},e.SPECIAL.posts.detail=[],e.SPECIAL.addFn=function(){console.log(e.SPECIAL.posts),e.SPECIAL.posts.detail.push({member:e.view.member[0].id})},e.SPECIAL.removeFn=function(t){e.SPECIAL.posts.detail.splice(t,1)},e.SPECIAL.addFn()}]),app.controller("RulCHARGECtr",["$scope","$location",function(e,t){e.CHARGE.check=[],e.CHARGE.addFn=function(t){e.CHARGE[t].posts.detail.push({member:e.view.member[0].id})},e.CHARGE.removeFn=function(t,s){e.CHARGE[t].posts.detail.splice(s,1)};for(var s=["CHARGE_PREMENT","CHARGE_POINT","CHARGE_COUPON","CHARGE_GIFT"],a=0;a<s.length;a++)e.CHARGE[a]={posts:{detail:[],type:s[a]}},e.CHARGE.addFn(a)}]),app.controller("RulPointCtr",["$scope","$location",function(e,t){e.POINT.posts={type:"POINT",detail:[]},e.POINT_CONSUME.posts={type:"POINT_CONSUME",detail:[]},e.POINT_GIFT.posts={type:"POINT_GIFT",detail:[]},e.POINT_COUPON.posts={type:"POINT_COUPON",detail:[]},e.POINT.addFn=function(t){e[t].posts.detail.push({member:e.view.member[0].id})},e.POINT.removeFn=function(t,s){e[t].posts.detail.splice(s,1)},e.POINT.addFn("POINT"),e.POINT.addFn("POINT_CONSUME"),e.POINT.addFn("POINT_GIFT"),e.POINT.addFn("POINT_COUPON")}]),app.controller("RuleMemberCtr",["$scope","$filter",function(e,t){e.config.breadset=[{name:"活动管理",href:indexUrl+"/admin.html#/rule"},{name:"会员规则管理"}],e.plan={add:0},e.upgradeType={CUSTOMER:"CUSTOMER",MEMBER:"MEMBER"};var s=ajaxSendFn({},"/memberUpgrade","GET").result||[];e.view={member:t("orderBy")(s.strategy,"grade",!1)||[],state:s.on,plan:{},isUpdate:!1,maxGrades:6},e.posts=[],e.check={},e.closeModal=function(){e.view.member[e.view.plan.level-1].name=e.oldGradeName,e.view.isUpdate=!1,$("#memberadd").modal("hide")},e.handleClick=function(t){e.view.isUpdate?e.updatePlan(t):e.addplan(t)},e.validateName=function(t,s){var a=!1;return angular.forEach(e.view.member,function(e,o){a||o!=t-1&&s===e.toName&&(a=!0)}),a},e.addnewFn=function(t){e.tem={},e.planform.memberName.$touched=!1,e.view.plan.level=e.view.member.length+1,$("#memberadd").modal("show")},e.updateFn=function(t){e.tem=e.view.member[t-1],e.oldGradeName=e.tem.name,e.view.isUpdate=!0,e.view.plan.level=t,$("#memberadd").modal("show")},e.switchStatus=function(t){var s=t===!0?"on":"off",a=ajaxSendFn({},"/memberUpgrade/"+s,"POST");if(200!=a.code)errorMsg(a);else{e.view.state=t;var o="on"===s?"启用":"停用";$("#turnon").modal("hide"),$("#turnoff").modal("hide"),alert("您已成功"+o+"会员计划")}},e.addplan=function(t){send=ajaxSendFn({name:e.tem.name},"/memberGrade","POST"),200==send.code?(e.tem.id=send.result,!e.view.member,e.view.member[e.view.member.length]={toName:e.tem.name,toId:e.tem.id,toGrade:e.view.member.length+1},e.view.show={toName:e.tem.name,toGrade:e.view.member.length-1},e.posts=[],$("#memberadd").modal("hide"),e.showFn(e.view.member.length)):errorMsg(send),e.plan={add:1}},e.updatePlan=function(t){return e.validateName(t,e.tem.name)||e.tem.name===e.oldGradeName?void alert("会员名称已被占用"):(send=ajaxSendFn({name:e.tem.name},"/memberGrade/"+e.tem.id,"POST"),void(200==send.code?(e.view.member[t-1].name=e.tem.name,$("#memberadd").modal("hide"),e.view.isUpdate=!1):(e.view.member[t-1].name=e.oldGradeName,errorMsg(send))))},e.closeFn=function(t){e.plan[t]=0},e.showFn=function(t){e.view.show=e.view.member[t-1],e.view.member[t-1].Upgrade||(e.view.member[t-1].Upgrade=ajaxSendFn({},"/memberUpgrade/toId/"+e.view.member[t-1].toId,"GET").result||[]),e.posts={},e.check={};for(x in e.view.member[t-1].Upgrade)type=e.view.member[t-1].Upgrade[x].type,e.posts[type]||(e.posts[type]={}),fromid=e.view.member[t-1].Upgrade[x].fromId,fromid===e.upgradeType.CUSTOMER&&1===t?e.posts[type].value=e.view.member[t-1].Upgrade[x].value:fromid===e.upgradeType.CUSTOMER&&t>1?(e.posts[type].special_value={id:e.view.member[t-1].Upgrade[x]._id,value:e.view.member[t-1].Upgrade[x].value},"POINT"===type&&(e.posts[type].value=e.view.member[t-1].Upgrade[x].value)):(e.posts[type]._id=e.view.member[t-1].Upgrade[x]._id,e.posts[type].value=e.view.member[t-1].Upgrade[x].value),e.check[type]=!0;$("#memberedit").modal("show")},e.postSend=function(){var t={},s=[];if(toid=e.view.member[e.view.show.toGrade-1].toId,e.validateName(e.view.show.toGrade,e.view.show.toName))return void alert("会员名称已被占用");for(var a in e.posts)if(e.check[a]||"BUY"===a){if(_id=e.posts[a]._id,null!=e.posts[a].value||"FREE"==a){var o={};_id&&(o._id=_id),o.type=a,o.toId=toid;var n;n=e.view.show.toGrade<=1?e.upgradeType.CUSTOMER:e.view.member[e.view.show.toGrade-2].toId,o.fromId=n,"FREE"!=a&&(o.value=e.posts[a].value),s.push(o)}if(e.posts[a].special_value&&null!=e.posts[a].special_value.value){var o={};e.posts[a].special_value.id&&(o._id=e.posts[a].special_value.id),o.type=a,o.toId=toid,o.fromId=e.upgradeType.CUSTOMER,o.value=e.posts[a].special_value.value,s.push(o)}}t.toId=toid,t.toName=e.view.show.toName,t.strategies=s,re=ajaxSendFn(JSON.stringify(t),"/memberUpgrade","POST",1),200==re.code?(e.view.member=ajaxSendFn({},"/memberUpgrade","GET").result.strategy||[],e.view.state=!1,$("#memberedit").modal("hide"),e.plan.add=0):errorMsg(re)}}]),app.controller("RuleCouponOFFSETCASHCtr",["$scope",function(e){}]),app.controller("CustomerCtr",["$scope","tyFnFactory","$http","$location",function(e,t,s,a){e.config.breadset=[{name:"顾客管理",href:indexUrl+"/admin.html#/customer"},{name:"顾客列表"}],e.dict={consumptionQuotas:[{name:"消费额度=0",value:"=0"},{name:"消费额度>0",value:">0"},{name:"消费额度>=100",value:">=100"},{name:"消费额度>=300",value:">=300"},{name:"消费额度>=500",value:">=500"},{name:"消费额度>=1000",value:">=1000"}],consumptionTimes:[{name:"消费次数=0",value:"=0"},{name:"消费次数>0",value:">0"},{name:"消费次数>=5",value:">=5"},{name:"消费次数>=10",value:">=10"},{name:"消费次数>=20",value:">=20"},{name:"消费次数>=50",value:">=50"},{name:"消费次数>=100",value:">=100"}]},e.view={interest:{},attention:ajaxSendFn({},"/customer/subscribe","GET").result||{alipay:!0}},e.view.customer=ajaxSendFn({},"/customer","GET").result||[],e.view.member=[],e.search={},e.postSend=function(){e.search.param?(e.view.customer.total=0,e.view.customer.items=ajaxSendFn(e.search,"/customer/search","GET").result||[]):e.view.customer=ajaxSendFn({},"/customer","GET").result||[]},e.sendSubscribe=function(){var t=ajaxSendFn(e.attention,"/customer/subscribe","POST");200==t.code&&alert("修改成功")},e.sendExcel=function(){var e=new FormData($("#uploadForm")[0]);$.ajax({url:basicUrl+"/customer/import?"+sortUrl(),type:"POST",data:e,async:!1,cache:!1,contentType:!1,processData:!1,success:function(e){alert(e)},error:function(e){alert(e)}})},e.interestGetFn=function(t){e.customer=ajaxSendFn({userId:t},constUrlDict.benefit,"GET").result||[]},e.pageChange=function(){var t={page:e.view.customer.page,count:e.view.customer.count};e.view.customer=ajaxSendFn(t,"/customer","GET").result||[]},e.viewDetail=function(e){a.path("/customer/detail/"+e)}}]),app.controller("CustomerChargeCtr",["$scope","$routeParams","$filter","$http",function(e,t,s,a){e.config.breadset=[{name:"顾客管理",href:indexUrl+"/admin.html#/customer"},{name:"顾客充值"}],e.view={},e.posts={type:"PUT"},e.reason={PUT:"使用",POST:"充值"},e.view.user=ajaxSendFn({},constUrlDict.customer+"/"+t.userId,"GET").result||[],e.view.interest=ajaxSendFn({userId:t.userId},"/interest","GET").result||[],e.send=function(){json={},json.users=t.userId,json.charge=e.posts.charge,json.reason="GIVE_FREE",reason=e.reason[e.posts.type],re=ajaxSendFn(JSON.stringify(json),"/interest",e.posts.type,1),200==re.code?(e.view.interest=ajaxSendFn({},"/interest?userId="+t.userId,"GET").result||[],e.posts.charge=0,alert(reason+"成功")):errorMsg(re)}}]),app.controller("CustomerPoicustomerntCtr",["$scope","$routeParams",function(e,t){e.view={user:ajaxSendFn({},constUrlDict.customer+"/"+t.userId,"GET").result||[]},e.posts={type:"PUT"},e.reason={PUT:"使用",POST:"发放"},e.view.interest=ajaxSendFn({},"/interest?userId="+t.userId,"GET").result||[],e.send=function(){console.log(e.posts),json={},json.users=t.userId,json.point=e.posts.point,json.reason="GIVE_FREE",reason=e.reason[e.posts.type],re=ajaxSendFn(JSON.stringify(json),"/interest",e.posts.type,1),200==re.code?(e.view.interest=ajaxSendFn({userId:t.userId},"/interest","GET").result||[],e.posts.point=0,alert(reason+"成功")):errorMsg(re)}}]),app.controller("CustomerCouponCtr",["$scope","$routeParams",function(e,t){e.view={user:ajaxSendFn({},constUrlDict.customer+"/"+t.userId,"GET").result||[]},e.view.coupons=ajaxSendFn({},constUrlDict.coupon,"GET").result||[],e.posts.coupons=[e.view.coupons[0]._id],e.add=function(){e.posts.coupons.push(e.view.coupons[0]._id)},e.remove=function(t){e.posts.coupons.splice(t,1)},e.send=function(){json={},json.users=t.userId,json.coupons=e.posts.coupons.join(),console.log(e.posts.coupons),json.reason="GIVE_FREE",json.couponCount=e.posts.count,console.log(json),re=ajaxSendFn(JSON.stringify(json),"/interest","POST",1),200==re.code?(e.view.interest=ajaxSendFn({},"/interest?userId="+t.userId,"POST",1).result||[],e.posts.point=0,alert("赠券成功")):errorMsg(re)}}]),app.controller("CustomerAddCtr",["$scope",function(e){
e.view={member:ajaxSendFn({},"/memberGrade","GET").result||[]},e.posts={gender:e.view.member[0].gender},e.send=function(){re=ajaxSendFn(JSON.stringify(e.posts),"/customer/guest/GIVE","POST",1),200==re.code?alert("添加成功"):errorMsg(re)}}]),app.controller("CustomerDetailCtr",["$scope","$routeParams",function(e,t){var s=t.userId;e.dict={},e.dict.relationSourceType=relationSourceType,e.view={},e.view.user=ajaxSendFn({},"/customer/"+t.userId,"GET").result||[],e.view.benefit=ajaxSendFn({userId:s},constUrlDict.benefit,"GET").result||[],e.view.relation=ajaxSendFn({},"/customerrelationmessage/firstshop/"+e.view.user.relationId,"GET").result||[],e.view.statrelation=ajaxSendFn({userId:s},"/customerrelationmessage/statrelation/"+e.view.user.relationId,"GET").result||[],e.view.statcomment=ajaxSendFn({},"/customerrelationmessage/statcomment/"+s,"GET").result||[],e.view.charts={show:!1,title:{text:""},options:{credits:{enabled:!1},chart:{type:"line"},tooltip:{},xAxis:{},yAxis:{}},series:[]},e.view.coupon={},e.view.consume={},e.showCouponList=function(){var t=e.view.user.relationId;e.view.coupon.list=ajaxSendFn({},"/coupon/usablecouponlist/"+t,"GET").result||[],e.view.coupon.show=!0,layer.open({title:"用户可用的优惠券",type:1,content:$("#coupon"),area:["600px","480px"]})},e.consumeList=function(){e.view.consume.list=ajaxSendFn({},"/customerrelationmessage/consumelist/"+s,"GET").result||[],e.view.consume.show=!0,layer.open({title:"消费明细(最近100条)",type:1,content:$("#consume"),area:["600px","480px"]})},e.consumeCharts=function(){var t=ajaxSendFn({},"/customerrelationmessage/consumptionlist/"+s,"GET").result||[],a=[],o=[];for(d in t)a.push(t[d].consumptionTime),o.push(t[d].amount);e.view.charts.show=!0,e.view.charts.title.text="顾客近3个月消费记录",e.view.charts.options.xAxis={title:{text:"消费日期"},labels:{formatter:function(){return formatDate(this.value,"yyyy-MM-dd")}},categories:a},e.view.charts.options.yAxis={title:{text:"消费额度"},labels:{formatter:function(){return this.value}}},e.view.charts.series=[{name:"消费",color:"#FF9655",data:o}],layer.open({title:"顾客消费数据挖掘",type:1,content:$("#charts"),area:["600px","480px"]})}}]),app.controller("RuleAdd2Ctr",["$scope","$location","$filter","$routeParams","CouponFactory",function(e,t,s,a,o){e.config.breadset=[{name:"活动管理",href:indexUrl+"/admin.html#/rule"},{name:"修改活动详情"}],e.btnDisable=0,e.today=s("date")(new Date,"yyyy-MM-dd"),e.tem={rules:{}},e.coupon={shared:[],shops:[]},e.posts={coupons:{}},e.transferMap={POINT_CONSUME:"POINTCONSUME",COUPON_FREE:"COUPONFREE",CHARGE_CONSUME:"CHARGECONSUME",SPECIAL_PRICE:"SPECIALPRICE"},e.transferMapRev={POINTCONSUME:"POINT_CONSUME",COUPONFREE:"COUPON_FREE",CHARGECONSUME:"CHARGE_CONSUME",SPECIALPRICE:"SPECIAL_PRICE"},e.view={},e.temcoupons2={},e.temcoupons=[],e.obtainRepeatCategory=obtainRepeatCategory,e.ruleFn={openOrClose:function(){e.isOpenOrClose=!e.isOpenOrClose},testAddOk:function(){console.log("OK"),e.isOpenOrClose=!1},testAddFail:function(e){console.log("错误编号:"+e.code+", 错误信息:"+e.message),errorMsg(e)},getCpouponFn:function(){e.view.coupons=ajaxSendFn({},"/coupon/usable","GET").result||[]},getCouponType:function(t){for(var s=0;e.view.coupons&&s<e.view.coupons.length;s++)if(e.view.coupons[s].id===t)return e.view.coupons[s].category},changeCoupon:function(t,s){if(s.id){s.count=1;for(var a=0;a<e.view.coupons.length;a++)if(e.view.coupons[a].id===s.id){s.name=e.view.coupons[a].name;break}}},oldRuleFn:function(){var t=ajaxSendFn({},"/activity/"+a.activityid+"/detail","GET").result;switch(e.view={counponType:{OFFSETCASH:"代金券",DISCOUNT:"折扣券",PHYSICAL:"实物券",GIFT:"礼券",new:"新增券"}},e.ruleFn.getCpouponFn(),t.activityCategory&&(e.tem.activityCategory=t.activityCategory.split("_")[0]),e.tem.activityCategory){case"DISCOUNT":e.view.rules={DISCOUNT:{name:"打折",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addFn,postFunc:e.ruleFn.sendFn,content:{DISCOUNT:[]}}};break;case"SPECIALPRICE":e.view.rules={SPECIALPRICE:{name:"特价",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addCouponFn,dishes:ajaxSendFn({},"/dishes","GET").result||[],postFunc:e.ruleFn.sendFn,content:{SPECIALPRICE:[]}}};break;case"POINT":e.view.rules={POINT:{name:"消费积分",state:"",show:0,addFunc:e.ruleFn.addFn,postFunc:e.ruleFn.sendFn,content:{POINT:[]}}};break;case"POINTCONSUME":e.view.rules={POINTCONSUME:{name:"积分抵现",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addFn,postFunc:e.ruleFn.sendFn,content:{POINTCONSUME:[]}}};break;case"CHARGE":e.view.rules={CHARGE:{name:"充值",state:"",show:0,addFunc:e.ruleFn.addCouponFn,postFunc:e.ruleFn.sendCouponFn,content:{CHARGE_PREMENT:[],CHARGE_POINT:[],CHARGE_GIFT:[],CHARGE_COUPON:[]}}};break;case"CHARGECONSUME":e.view.rules={CHARGECONSUME:{name:"使用充值卡",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addFn,postFunc:e.ruleFn.sendChargeConsumeFn,content:{CHARGECONSUME:[]}}};break;case"COUPON":e.view.rules={COUPON:{name:"返券活动",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addCouponFn,postFunc:e.ruleFn.sendCouponFn,content:{COUPON:[]}}};break;case"COUPONFREE":e.view.rules={COUPONFREE:{name:"送券活动",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addCouponFn,postFunc:e.ruleFn.sendCouponFn,content:{COUPONFREE:[]}}};break;case"EXCHANGE":e.view.rules={EXCHANGE:{name:"积分兑换",state:"",show:0,addFunc:e.ruleFn.addCouponFn,postFunc:e.ruleFn.sendCouponFn,content:{EXCHANGE_GIFT:[],EXCHANGE_COUPON:[]}}};break;case"FOLLOW":e.view.rules={FOLLOW:{name:"关注有礼",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addCouponFn,postFunc:e.ruleFn.sendCouponFn,content:{FOLLOW_COUPON:[]}}}}e.view.shop=ajaxSendFn({state:"1002"},"/shops","GET").result||[],e.tem.shops=[];for(var s in e.view.shop)e.tem.shops.push(e.view.shop[s].id);if(t&&t.rules){e.tem.rules=arrToObj(t.rules,"type","id");var o=ajaxSendFn({ids:obj2Array(t.rules,"id").join()},"/activity/rule/ids","GET").result||null;if(o)for(e.btnDisable=1,i=0,j=o.length;i<j;i++){var n=o[i].type;e.transferMap.hasOwnProperty(n)&&(o[i].type=e.transferMap[n]),e.ruleFn.stateFn(o[i].type,"show",1,o[i])}}},stateFn:function(t,s,a,o){"SPECIAL_PRICE"==t&&(t="SPECIALPRICE");var n=t.split("_")[0];if(n in e.view.rules&&(e.view.rules[n].state=s,e.view.rules[n].show=a),"add"==s&&e.ruleFn.buttonFn(t),!o)return void(e.btnDisable=1);var r=o.type;"SPECIAL_PRICE"==r&&(r="SPECIALPRICE"),a&&(e.view.rules[n].content[r]=o)},closeFn:function(t){"edit"==e.view.rules[t].state?e.view.rules[t].state="show":"add"==e.view.rules[t].state&&(e.view.rules[t].state="show")},buttonFn:function(s){if("show"==e.view.rules[s].state)e.ruleFn.postFn(s),e.view.rules[s].state="edit";else if("edit"==e.view.rules[s].state){var a=e.view.rules[s].postFunc(s);a&&(t.path("/rule"),e.view.rules[s].state="show")}else if("add"==e.view.rules[s].state){for(x in e.view.rules[s].content)e.view.rules[s].addFunc(x);e.view.rules[s].state="edit",$("#showadd").modal("hide")}},memberFn:function(){e.view.member=ajaxSendFn({},"/memberGrade","GET").result||[],e.view.member=s("orderBy")(e.view.member,"grade"),e.view.member.length&&e.view.member.push({id:"MEMBER",name:"所有会员"}),e.view.member.push({id:"CUSTOMER",name:"全员"})},postFn:function(t){var s=e.view.rules[t].content;e.posts[t]={};for(x in s){var a=!0;e.posts[t][x]=s[x],s[x]instanceof Array&&(a=!1),e.posts[t][x].check=a,s[x].detail&&Object.keys(s[x].detail).length||e.view.rules[t].addFunc(x)}},addCouponFn:function(t){e.ruleFn.addFn(t,function(s,a){if("COUPON"===s||"GAME"===s||"COUPON"===a||"COUPONFREE"===t||"SPECIALPRICE"===t){var o=e.posts[s][t].detail.CUSTOMER;if(o&&o.length>0&&!isEmptyObject(o[0])){var n={};n.value=[{}],e.posts[s][t].detail.CUSTOMER.push(n)}else{var n=e.posts[s][t].detail.CUSTOMER[0];n.value=[{}]}}})},addFn:function(t,s){var a,o,n=t.split("_");if(n&&n.length>0&&(a=n[0]),n&&n.length>1&&(o=n[1]),!e.posts[a]||!e.posts[a][t]||!e.posts[a][t].detail||isEmptyObject(e.posts[a][t].detail))return e.posts[a]||(e.posts[a]={}),e.posts[a][t]=e.view.rules[a].content[t],e.posts[a][t].detail={CUSTOMER:[{}]},void(s&&s(a,o));if(e.posts[a][t].detail.CUSTOMER){var r={};s?s(a,o):e.posts[a][t].detail.CUSTOMER.push(r)}else e.posts[a][t].detail.CUSTOMER=[{}],s&&s(a,o)},removeFn:function(t,s,a){var o=t.split("_")[0];e.posts[o][t].detail[s][a]&&e.posts[o][t].detail[s].splice(a,1)},checkCouponList:function(t){for(var s=0;t&&s<t.length-1;s++)for(var a=s+1;a<t.length;a++)if(t[s].id===t[a].id)return!0;for(var s=0;t&&s<t.length-1;s++)for(var o=e.ruleFn.getCouponType(t[s].id),a=1;a<t.length;a++){var n=e.ruleFn.getCouponType(t[a].id);if(o===n)return!0}return!1},sendChargeConsumeFn:function(t){return e.ruleFn.sendFn(t,void 0,void 0,function(e){var t=e.detail.CUSTOMER[0];t.value?t.value=!1:t.value=!0,t.amount=1,t.currentAmount=t.count=0})},sendCouponFn:function(t){return e.ruleFn.sendFn(t,function(t,s){if("COUPON"===t)for(var a in s)if(s[a]&&s[a].length>0&&e.ruleFn.checkCouponList(s[a][0].value))return{message:"券或券类型不能重复"}},function(e,t){if(e&&"COUPON"===e)for(var s in t.detail){var a={};for(var o in t.detail[s]){if(a[s]===t.detail[s][o].value[0].id)return{message:"注意：券不能重复"};a[s]=t.detail[s][o].value[0].id}}})},sendFn:function(t,s,o,n){var r=e.posts[t];for(var i in r)e.view.rules[t].uncheck||r[i].check||(e.tem.rules&&e.tem.rules[i]&&delete e.tem.rules[i],e.view.rules[t].content[i]&&(e.view.rules[t].content[i].detail=[],e.view.rules[t].content[i].check=!1));var d=[];for(var i in r)if(e.view.rules[t].uncheck||r[i].check){var l={};e.transferMapRev.hasOwnProperty(i)?l.type=e.transferMapRev[i]:l.type=i,l.detail={},r[i]._id&&(l._id=r[i]._id),r[i].amountLimit&&(l.amountLimit=r[i].amountLimit),r[i].celling&&(l.celling=r[i].celling),r[i].countLimit&&(l.countLimit=r[i].countLimit),r[i].timesLimit&&(l.timesLimit=r[i].timesLimit),r[i].obtainCategory&&(l.obtainCategory=r[i].obtainCategory),"SPECIALPRICE"==l.type&&(r[i].currentAmount&&(l.currentAmount=r[i].currentAmount),l.type="SPECIAL_PRICE");var c=r[i].detail;if(s&&"function"==typeof s){var p=s(i,c);if(p)return alert(p.message),!1}var u,m=i.split("_");m&&m.length>1&&(u=m[1]);for(z in c)for(w in c[z]){var f=c[z][w],h={};f.amount&&(h.amount=f.amount),f.score&&(h.score=f.score),f.value&&(h.value=f.value),f.count&&(h.count=f.count),f.currentAmount&&(h.currentAmount=f.currentAmount),l.detail[f.id]?l.detail[f.id].push(h):l.detail[f.id]=[h]}if(o&&"function"==typeof o&&(p=o(u,l)))return alert(p.message),!1;n&&"function"==typeof n&&n(l),d.push(l)}var v=ajaxSendFn(angular.toJson(d),"/activity/"+a.activityid+"/rules","POST",1);if(200!=v.code)return errorMsg(v),!1;var g=ajaxSendFn({ids:v.result[0]},"/activity/rule/ids","GET").result||null;return e.view.rules[t].content[i]=g[1],!0},addCouponPlanFn:function(t){"new"==t&&e.ruleFn.showCouponPlanFn()},addRuleFn:function(){e.view.modal={title:"添加活动内容",html:"addrule"},$("#showadd").modal("show")},showCouponPlanFn:function(t){e.view.modal={title:"添加券",html:"couponNew"},$("#showadd").modal("show")},put:function(e,t){e.value||(e.value=[]),t={},e.value.push(t)},resetCouponCntFn:function(e,t){angular.forEach(e.value,function(e,s){e&&e.id===t.id&&this.splice(s,1)},e.value)},containsCoupon:function(e,t){for(var s=-1,a=0;e.value&&a<e.value.length;a++)if(e.value[a].id===t){s=a;break}return s}},e.ruleFn.oldRuleFn(),"FOLLOW"==e.tem.activityCategory?e.view.member=[{id:"FOLLOWING",name:"新关注用户"}]:e.ruleFn.memberFn(),e.ruleFn.getCpouponFn(),e.tem&&e.tem.activityCategory&&isEmptyObject(e.tem.rules)&&e.ruleFn.stateFn(e.tem.activityCategory,"add",1),e.check_all=function(){e.checkallstr=!e.checkallstr,e.checkallstr?e.coupon.shops=e.tem.shops:e.coupon.shops=[]}}]),app.controller("edit_passwordCtr",["$scope","$location",function(e,t){e.show={},e.posts={},e.staffadd_form={},e.config.breadset=[{name:"修改密码"}],e.staffaddsend=function(){if(!e.staffadd_form.$valid)return void(e.staffadd_form.submitted=!0);if(e.posts.oldPassword===e.posts.password)return void alert("原密码和新密码不能相同");var s={};angular.extend(s,e.posts),s.old=hex_md5(e.posts.oldPassword),s.password=hex_md5(e.posts.password),delete s.oldPassword,result=ajaxSendFn(JSON.stringify(s),constUrlDict["staffs-password"],"POST"),200==result.code?(alert("修改成功"),t.path("/")):errorMsg(result)}}]),app.controller("RuleCouponCtr",["$scope","$http","CouponFactory",function(e,t,s){e.config.breadset=[{name:"活动管理",href:indexUrl+"/admin.html#/rule"},{name:"券管理"}],e.view={coupons:ajaxSendFn({},"/coupon","GET").result||[],type:{901:"代金券",902:"实物券",903:"折扣券",904:"礼品券"},state:{4001:"未使用",4002:"已核销",4003:"过期"}},e.openOrClose=function(){$("#add").modal("show")},e.testAddOk=function(){$("#add").modal("hide"),alert("添加成功"),e.view.coupons=ajaxSendFn({},"/coupon","GET").result||[]},e.testAddFail=function(e){errorMsg(e)},e.detailFn=function(t){e.coupon=ajaxSendFn({},"/coupon/"+t,"GET").result,$("#show").modal("show")},e.couponDelFn=function(t){if(!confirm("一旦删除将不可恢复，是否确认删除？"))return!1;var s=ajaxSendFn({},"/coupon/"+e.view.coupons.items[t].id,"DELETE");200==s.code?(e.view.coupons.items.splice(t,1),alert("删除成功")):alert(s.message)},e.pageChange=function(){var t={page:e.view.coupons.page,count:e.view.coupons.count};e.view.coupons=ajaxSendFn(t,"/coupon","GET").result||[]}}]),app.controller("DevicesCtr",["$scope","$http","deviceFactory",function(e,t,s,a){e.config.breadset=[{name:"设备管理",href:indexUrl+"/admin.html#/devices"},{name:"设备列表"}],e.search={count:10},e.getDevices=function(){e.view={devices:s.getAllDevices(e.search)}},e.jihuo=function(){s.jihuo(function(t){e.getDevices()})},e.pageChange=function(){e.search.page=e.view.devices.page,e.getDevices()},e.getDevices()}]),app.controller("DishCtr",["$scope","$location","$http",function(e,t,s){e.config.breadset=[{name:"菜品管理",href:indexUrl+"/admin.html#/dish"},{name:"菜品列表"}];var a=ajaxSendFn({},"/dishes","GET");200!=a.code&&t.path("/dish/add"),e.posts={dishes:[]},e.dishes={list:a.result},e.remove=function(t){if(!confirm("一旦删除将不可恢复，是否确认删除？"))return!1;var s=ajaxSendFn({},"/dishes/"+e.dishes.list[t].id,"DELETE");200==s.code?(e.dishes.list.splice(t,1),alert("删除成功")):alert(s.message)},e.removeAll=function(){if(!e.posts.dishes.length)return void alert("请先选择要删除的菜品！");var t=ajaxSendFn(e.posts.dishes,"/dishes/ids","DELETE");200==t.code?(e.posts.dishes=[],e.dishes.list=ajaxSendFn({},"/dishes","GET").result):alert(t.message)},e.checkAllDishes=function(){e.dishesAll?e.posts.dishes=[]:angular.forEach(e.dishes.list,function(e,t){this[t]=e.id},e.posts.dishes)}}]),app.controller("DishEditCtr",["$scope","$location","$http","$routeParams",function(e,t,s,a){e.config.breadset=[{name:"菜品管理",href:indexUrl+"/admin.html#/dish"},{name:"菜品编辑"}];var o=ajaxSendFn({},"/dishes/"+a.dishId,"GET");200!=o.code&&t.path("/dish"),e.posts=o.result,e.addpic=function(){e.tempic="",$("#addpic").modal("show")},e.temimgshow=function(t){var s=getObjectURL(t.files[0]);s&&(e.tempic=s)},e.sendimg=function(t){POSTurl=basicUrl+"/pic?",options={url:POSTurl+sortUrl(),type:"POST",success:function(t){200===t.code?(e.posts.picUrl=t.result.url,$("#addpic").modal("hide")):alert("图片上传失败")}},$("#iimgform").ajaxSubmit(options)},e.send=function(s){return sendJson=JSON.stringify(e.posts),postsend=ajaxSendFn(sendJson,"/dishes/"+e.posts.id,"POST",1),200!=postsend.code?void alert("重试"):(alert("保存成功"),void t.path("/dish"))}}]),app.controller("DishAddCtr",["$scope","$location","$http",function(e,t,s){e.config.breadset=[{name:"菜品管理",href:indexUrl+"/admin.html#/dish"},{name:"菜品列表"}],e.tem={uploadTitle:"选择图片"},e.posts={},e.addpic=function(){e.tempic="",$("#addpic").modal("show")},e.temimgshow=function(t){var s=getObjectURL(t.files[0]);s&&(e.tempic=s,e.tem={uploadTitle:"已选择"})},e.sendimg=function(t){POSTurl=basicUrl+"/pic?",options={url:POSTurl+sortUrl(),type:"POST",success:function(t){200===t.code?(e.posts.picUrl=t.result.url,$("#addpic").modal("hide")):alert("图片上传失败")}},$("#iimgform").ajaxSubmit(options)},e.send=function(s){sendJson=JSON.stringify(e.posts),postsend=ajaxSendFn(sendJson,"/dishes","POST",1),200==postsend.code?(alert("保存成功"),t.path("/dish")):alert("重试")}}]),app.controller("DocCtr",["$rootScope","$scope","$location","shopFactory",function(e,t,s,a){t.config.class="doc",t.posts={},t.view={shops:a.getAllShops(),STATISTICS_TEXT:["当前总余额（元）","当前总余量（分）","当前总余量（张）","当前会员总人数（人）","历史总计（条）","当前总消费数（笔）","当前总消费数（笔）"],TYPE:["recharge","point","coupon","upgrade","shortmessage","consumption","receivables"],buttons:["充值报表","积分报表","优惠券报表","顾客升级情况报表","短信使用情况报表","上宾消费报表","其他收费报表"],coupons:ajaxSendFn({},"/statistics/coupons","GET").result||[]},t.sendOrder=function(){window.open("admin.html#/doc/detail/"+t.posts.order,"_blank")}}]),app.controller("FinanceCtr",["$rootScope","$scope","$location","shopFactory",function(e,t,s,a){t.config.class="doc",t.posts={},t.view={shops:a.getAllShops(),buttons:["全部报表","支付宝收款报表","微信支付收款报表","现金收款报表","刷卡收款报表"],TYPE:["recharge","point","coupon","upgrade","shortmessage","consumption","receivables"],projects:[{id:"901",name:"消费"},{id:"902",name:"充值"},{id:"904",name:"升级"},{id:"909",name:"收款"}]},t.sendOrder=function(){window.open("admin.html#/doc/detail/"+t.posts.order,"_blank")}}]),app.controller("NoticeCtr",["$rootScope","$scope","$location","shopFactory",function(e,t,s,a){t.config.class="notice",t.view=ajaxSendFn({},"/remind/message","GET").result||[],t.post=[],t.posts={101:{category:"101",path:"",enabled:!1},102:{category:"102",path:"",enabled:!1},103:{category:"103",path:"",enabled:!1},104:{category:"104",path:"",enabled:!1},105:{category:"105",path:"",enabled:!1},106:{category:"106",path:"",enabled:!1},107:{category:"107",path:"",enabled:!1},108:{category:"108",path:"",enabled:!1},109:{category:"109",path:"",enabled:!1},110:{category:"110",path:"",enabled:!1},111:{category:"111",path:"",enabled:!1},120:{category:"120",path:"",enabled:!1}},t.init=function(){for(var e=0;e<t.view.length;e++)t.posts[t.view[e].category]=t.view[e]},t.init(),t.reverse=function(){var e=[];for(var s in t.posts)t.posts[s].path&&(t.posts[s].enabled=!0,e.push(t.posts[s]));return e},t.postSend=function(){var e=ajaxSendFn(t.reverse(),"/remind/message","POST");200==e.code?alert("保存成功"):alert(e.message)}}]),app.controller("NoticeValidateCtr",["$rootScope","$scope","$location","shopFactory",function(e,t,s,a){t.config.class="notice",t.posts={};var o=ajaxSendFn({},"/remind/short","GET");200==o.code&&(t.posts=o.result),t.postSend=function(){var e=t.posts;for(var s in e)e[s]||delete e[s];var a=ajaxSendFn(e,"/remind/short","POST");200==a.code?alert("保存成功"):alert(a.message)}}]),app.controller("NoticeExpiredCtr",["$rootScope","$scope","$location","shopFactory",function(e,t,s,a){t.config.class="notice";var o=ajaxSendFn({},"/remind/expired","GET");if(200==o.code)switch(t.post=o.result,t.post.path){case"102":t.hand_click=!0,t.message=!0,t.wx=!0;break;case"104":t.hand_click=!0,t.message=!0;break;case"103":t.hand_click=!0,t.wx=!0}else t.post={category:"120",path:"",enabled:!1,times:""};t.postSend=function(){if(t.post.path){if(!t.post.times)return void alert("请先选择天数！");t.post.enabled=!0}var e=ajaxSendFn(t.post,"/remind/expired","POST");200==e.code?alert("保存成功"):alert(e.message)},t.change=function(){t.message&&t.wx?t.post.path="102":t.message?t.post.path="104":t.wx?t.post.path="103":t.post.path=""},t.$watch("post.path",function(){"101"==t.post.path&&(t.hand_click="")})}]);