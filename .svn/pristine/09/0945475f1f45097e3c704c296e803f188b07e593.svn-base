function appRouteConfig(e){e.when("/shops",{templateUrl:"admin/shops/index.html",controller:"ShopsCtr"}).when("/brand",{templateUrl:"admin/brand/index.html",controller:"BrandCtr"}).when("/brand/add",{templateUrl:"admin/brand/add.html",controller:"BrandAddCtr"}).when("/shops/add",{templateUrl:"admin/shops/add.html",controller:"ShopsAddCtr"}).when("/shops/add2/:shopId",{templateUrl:"admin/shops/add2.html",controller:"ShopsAdd2Ctr"}).when("/shops/add3/:shopId",{templateUrl:"admin/shops/add3.html",controller:"ShopsAdd3Ctr"}).when("/staff",{templateUrl:"admin/Staff/index.html",controller:"StaffCtr"}).when("/staff/:shopId",{templateUrl:"admin/Staff/index.html",controller:"StaffCtr"}).when("/staff/staffadd/:shopId",{templateUrl:"admin/Staff/staffadd.html",controller:"StaffAddCtr"}).when("/staff/keeperadd/:shopId",{templateUrl:"admin/Staff/keeperadd.html",controller:"StaffAddCtr"}).when("/staff/staffoperation/:guestid",{templateUrl:"admin/Staff/staffoperation.html",controller:"Staffoperation"}).when("/password",{templateUrl:"my/password.html",controller:"passwordCtr"}).when("/rule",{templateUrl:"admin/rule/index.html",controller:"RuleCtr"}).when("/ruleconsume",{templateUrl:"admin/rule/index.html",controller:"RuleCtr"}).when("/rule/add",{templateUrl:"admin/rule/add.html",controller:"RuleAddCtr"}).when("/rule/addconsume",{templateUrl:"admin/rule/addConsume.html",controller:"RuleAddCtr"}).when("/rule/add2/:activityid",{templateUrl:"admin/rule/add2.html",controller:"RuleAdd2Ctr"}).when("/rule/edit/:activityid",{templateUrl:"admin/rule/ruleedit.html",controller:"RuleAddCtr"}).when("/rule/edit2/:activityid",{templateUrl:"admin/rule/ruleedit2.html",controller:"RuleAdd2Ctr"}).when("/rule/exhibition/add",{templateUrl:"admin/rule/exhibition/add.html",controller:"RuleExhibitionAddCtr"}).when("/rule/exhibition/:activityid",{templateUrl:"admin/rule/exhibition/add.html",controller:"RuleExhibitionAddCtr"}).when("/rule/exhibition",{templateUrl:"admin/rule/exhibition/index.html",controller:"RuleExhibitionShowCtr"}).when("/rule/member",{templateUrl:"admin/rule/member.html",controller:"RuleMemberCtr"}).when("/rule/coupon",{templateUrl:"admin/rule/coupon.html",controller:"RuleCouponCtr"}).when("/rule/cards",{templateUrl:"admin/rule/cards.html",controller:"RuleCardsCtr"}).when("/rule/allocate",{templateUrl:"admin/rule/allocate.html",controller:"RuleAllocateCtr"}).when("/rule/reward",{templateUrl:"admin/rule/reward.html",controller:"RuleRewardCtr"}).when("/rule/bargain",{templateUrl:"admin/rule/bargain.html",controller:"RuleBargainCtr"}).when("/rule/grouponadd",{templateUrl:"admin/rule/groupon/add.html",controller:"RuleGrouponAddCtr"}).when("/rule/groupon/:id",{templateUrl:"admin/rule/groupon/add.html",controller:"RuleGrouponAddCtr"}).when("/rule/groupon",{templateUrl:"admin/rule/groupon/index.html",controller:"RuleGrouponCtr"}).when("/rule/comment",{templateUrl:"admin/rule/comment/index.html",controller:"RuleCommentCtr"}).when("/rule/comment/:id",{templateUrl:"admin/rule/comment/add.html?v=131",controller:"RuleCommentAddCtr"}).when("/rule/commentadd",{templateUrl:"admin/rule/comment/add.html",controller:"RuleCommentAddCtr"}).when("/rule/lottery",{templateUrl:"admin/rule/lottery/index.html",controller:"RuleLotteryCtr"}).when("/rule/lottery/:id",{templateUrl:"admin/rule/lottery/add.html",controller:"RuleLotteryAddCtr"}).when("/rule/lotteryadd",{templateUrl:"admin/rule/lottery/add.html",controller:"RuleLotteryAddCtr"}).when("/rule/ads",{templateUrl:"admin/rule/poster/index.html",controller:"RuleAdsCtr"}).when("/ads/edit/:id",{templateUrl:"admin/rule/poster/add.html",controller:"RuleAdsAddCtr"}).when("/rule/ads/add",{templateUrl:"admin/rule/poster/add.html",controller:"RuleAdsAddCtr"}).when("/rule/gratuities",{templateUrl:"admin/rule/gratuities/index.html",controller:"RuleGratuitiesCtr"}).when("/rule/gratuity",{templateUrl:"admin/rule/gratuity/index.html",controller:"RuleGratuityCtr"}).when("/rule/gratuity/add",{templateUrl:"admin/rule/gratuity/add.html",controller:"RuleGratuityAddCtr"}).when("/rule/gratuity/:id",{templateUrl:"admin/rule/gratuity/add.html",controller:"RuleGratuityAddCtr"}).when("/rule/tags",{templateUrl:"admin/rule/tags/index.html",controller:"RuleTagsCtr"}).when("/rule/tasks",{templateUrl:"admin/rule/tasks/index.html",controller:"tasksCtr"}).when("/rule/nonParticipation",{templateUrl:"admin/rule/nonParticipation/index.html",controller:"RuleNonParticipationCtr"}).when("/rule/front",{templateUrl:"admin/rule/front/index.html",controller:"RuleFrontCtr"}).when("/rule/material",{templateUrl:"admin/rule/material/index.html",controller:"RuleMaterialCtr"}).when("/rule/reserve",{templateUrl:"admin/rule/reserve/index.html",controller:"ReserveCtr"}).when("/rule/reserve/add",{templateUrl:"admin/rule/reserve/add.html",controller:"ReserveAddCtr"}).when("/rule/reserve/add/:activityId",{templateUrl:"admin/rule/reserve/add.html",controller:"ReserveAddCtr"}).when("/rule/redpackets",{templateUrl:"admin/rule/redpackets/index.html",controller:"redpacketsCtr"}).when("/rule/source",{templateUrl:"admin/rule/source/index.html",controller:"sourceCtr"}).when("/rule/addsource",{templateUrl:"admin/rule/source/addsource.html",controller:"addsourceCtr"}).when("/rule/video",{templateUrl:"admin/rule/video/index.html",controller:"videoCtr"}).when("/rule/addpackets",{templateUrl:"admin/rule/redpackets/addpackets.html",controller:"addpacketsCtr"}).when("/rule/editpackets/:id",{templateUrl:"admin/rule/redpackets/editpackets.html",controller:"editpacketsCtr"}).when("/rule/referral",{templateUrl:"admin/rule/referral/index.html",controller:"referralCtr"}).when("/rule/addreferral",{templateUrl:"admin/rule/referral/addreferral.html",controller:"addreferralCtr"}).when("/rule/editreferral/:id",{templateUrl:"admin/rule/referral/editreferral.html",controller:"editreferralCtr"}).when("/rule/commission",{templateUrl:"admin/rule/commission/index.html",controller:"commissionCtr"}).when("/rule/addcommission",{templateUrl:"admin/rule/commission/addcommission.html",controller:"addcommissionCtr"}).when("/rule/editcommission/:id",{templateUrl:"admin/rule/commission/editcommission.html",controller:"editcommissionCtr"}).when("/rule/reserve/add2/:activityId",{templateUrl:"admin/rule/reserve/add2.html",controller:"ReserveAdd2Ctr"}).when("/customer/charge/:userId",{templateUrl:"admin/customer/charge.html",controller:"CustomerChargeCtr"}).when("/customer/update/:userId",{templateUrl:"admin/customer/update.html",controller:"CustomerUpdateCtr"}).when("/customer/upgrade/:userId",{templateUrl:"admin/customer/upgrade.html",controller:"CustomerUpgradeCtr"}).when("/customer/point/:userId",{templateUrl:"admin/customer/point.html",controller:"CustomerPointCtr"}).when("/customer/coupon/:userId",{templateUrl:"admin/customer/coupon.html",controller:"CustomerCouponCtr"}).when("/customer/add",{templateUrl:"keeper/customer/add.html",controller:"CustomerAddCtr"}).when("/customer/details/:userId",{templateUrl:"admin/customer/details.html?v=20181105",controller:"CustomerDetailsCtr"}).when("/customer/search/:userId",{templateUrl:"admin/customer/index.html?v=1",controller:"CustomerCtr"}).when("/customer",{templateUrl:"admin/customer/index.html?v=1",controller:"CustomerCtr"}).when("/customer/import",{templateUrl:"admin/customer/import.html",controller:"CustomerImportCtr"}).when("/customer/tag",{templateUrl:"admin/customer/tag.html",controller:"CustomerTagCtr"}).when("/customer/mass",{templateUrl:"admin/customer/mass.html",controller:"CustomerMassCtr"}).when("/customer/mass/add",{templateUrl:"admin/customer/massAdd.html",controller:"CustomerMassAddCtr"}).when("/customer/record",{templateUrl:"admin/customer/record.html",controller:"CustomerRecordCtr"}).when("/customer/trusteeship",{templateUrl:"admin/customer/trusteeship.html",controller:"CustomerTrusteeshipCtr"}).when("/customer/trusteeship/add",{templateUrl:"admin/customer/trusteeshipAdd.html",controller:"CustomerTrusteeshipAddCtr"}).when("/test",{templateUrl:"test.html",controller:"TestCtr"}).when("/mall/dish",{templateUrl:"admin/mall/dish/index.html",controller:"DishCtr"}).when("/mall/dish/add",{templateUrl:"admin/mall/dish/add.html",controller:"DishAddCtr"}).when("/mall/dish/edit/:dishId",{templateUrl:"admin/mall/dish/add.html",controller:"DishAddCtr"}).when("/mall/category",{templateUrl:"admin/mall/category/index.html",controller:"CategoryCtr"}).when("/mall/meal",{templateUrl:"admin/mall/meal/index.html",controller:"MealCtr"}).when("/mall/meal/add",{templateUrl:"admin/mall/meal/add.html",controller:"MealAddCtr"}).when("/mall/meal/edit/:mealId",{templateUrl:"admin/mall/meal/add.html",controller:"MealAddCtr"}).when("/mall/buy",{templateUrl:"admin/mall/buy/index.html",controller:"BuyCtr"}).when("/mall/buy/add",{templateUrl:"admin/mall/buy/add.html",controller:"BuyAddCtr"}).when("/mall/buy/edit/:id",{templateUrl:"admin/mall/buy/add.html",controller:"BuyAddCtr"}).when("/doc",{templateUrl:"admin/doc/index.html?v=20181108",controller:"DocCtr"}).when("/finance",{templateUrl:"admin/finance/index.html",controller:"FinanceCtr"}).when("/finance/search",{templateUrl:"admin/finance/search.html",controller:"FinanceSearchCtr"}).when("/notice",{templateUrl:"admin/notice/index.html",controller:"NoticeCtr"}).when("/notice/praise",{templateUrl:"admin/notice/praise.html",controller:"NoticePraiseCtr"}).when("/notice/groupon",{templateUrl:"admin/notice/groupon.html",controller:"NoticeGrouponCtr"}).when("/notice/validate",{templateUrl:"admin/notice/validate.html",controller:"NoticeValidateCtr"}).when("/notice/expired",{templateUrl:"admin/notice/expired.html",controller:"NoticeExpiredCtr"}).when("/notice/lottery",{templateUrl:"admin/notice/lottery.html",controller:"NoticeLotteryCtr"}).when("/notice/subscribe",{templateUrl:"admin/notice/subscribe.html",controller:"NoticeSubscribeCtr"}).when("/notice/pay",{templateUrl:"admin/notice/pay.html",controller:"NoticePayCtr"}).otherwise({redirectTo:"/shops"})}function getObjectURL(e){var t=null;return void 0!=window.createObjectURL?t=window.createObjectURL(e):void 0!=window.URL?t=window.URL.createObjectURL(e):void 0!=window.webkitURL&&(t=window.webkitURL.createObjectURL(e)),t}appRouteConfig.$inject=["$routeProvider"],angular.module("app").config(appRouteConfig),app.controller("BrandCtr",["$scope","$location","$http",function(e,t,a){e.config.breadset=[{name:"品牌管理",href:indexUrl+"/admin.html#/brand"},{name:"品牌管理"}],e.view={pic:ajaxSendFn({},"/pic/brand","GET").result||[],brand:ajaxSendFn({},"/brand","GET").result||[],video:ajaxSendFn({count:10},"/videos","GET").result||[],vidgroups:ajaxSendFn({},"/videos/group","GET").result||[]},e.tem={uploadTitle:"选择要上传的图片"},e.addIntroduction=function(){$("#introduction").modal("show")},e.addpic=function(){e.tempic="",e.view.materials=ajaxSendFn({count:10},"/materials","GET").result||[],e.view.groups=ajaxSendFn({},"/materials/group","GET").result||[],e.view.select=-1,e.view.leftIndex=-2,$("#addpic").modal("show")},e.introductionFn=function(){var t=ajaxSendFn({content:e.view.brand.introduction},"/brand/introduction","POST");200==t.code?($("#introduction").modal("hide"),alert("修改成功")):errorMsg(t)},e.storyFn=function(){var t=ajaxSendFn({content:e.view.brand.story},"/brand/story","POST");200==t.code?($("#story").modal("hide"),alert("修改成功")):errorMsg(t)},e.addStory=function(){$("#story").modal("show")},e.removeImg=function(t){removere=ajaxSendFn({},"/pic/"+e.view.pic[t].id,"DELETE"),200==removere.code&&e.view.pic.splice(t,1)},e.setCover=function(t){var a=ajaxSendFn({},"/pic/"+t+"/cover","POST");200==a.code?(alert("设置成功"),e.view.pic=ajaxSendFn({},"/pic/brand","GET").result||[]):errorMsg(a)},e.removeCover=function(e){var t=ajaxSendFn({},"/pic/"+e+"/cover","DELETE");200==t.code?alert("成功取消"):errorMsg(t)},e.bigpicshow=function(t){e.view.bigpic=t.substring(0,t.lastIndexOf(".",t))+"_1"+t.substring(t.lastIndexOf(".",t)),$("#bigpic").modal("show")},e.changeFn=function(t){e.view.select==t?e.view.select=-1:e.view.select=t},e.imgUpload=function(t){return t.files[0].size>5242880?void alert("图片不得大于5M，图片格式为png,jpg,jpeg,bmp"):(POSTurl=basicUrl+"/materials?",options={url:POSTurl+sortUrl(),type:"POST",success:function(t){200===t.code?e.$apply(function(){e.view.materials=ajaxSendFn({count:10},"/materials","GET").result,e.view.select=0}):alert(t.message)}},void $("#iimgform").ajaxSubmit(options))},e.groupList=function(t){url="/materials",t>=0&&(url="/materials/group/"+e.view.groups[t].id+"/materials"),t==-1&&(url="/materials/group/materials"),e.view.materials=ajaxSendFn({count:10},url,"GET").result,e.view.leftIndex=t},e.vidgroupList=function(t){url="/videos",t>=0&&(url="/videos/group/"+e.view.groups[t].id+"/videos"),t==-1&&(url="/videos/group/videos"),e.view.video=ajaxSendFn({count:10},url,"GET").result,e.view.leftIndex=t},e.sendGroup=function(){var t=ajaxSendFn({name:e.post.name},"/materials/group","POST");200===t.code?(e.view.checkName=!1,e.view.groups=ajaxSendFn({},"/materials/group","GET").result):alert(t.message)},e.pageChange=function(){url="/materials",e.view.leftIndex>=0&&(url="/materials/group/"+e.view.groups[e.view.leftIndex].id+"/materials"),e.view.leftIndex==-1&&(url="/materials/group/materials");var t={page:e.view.materials.page,count:e.view.materials.count};e.view.materials=ajaxSendFn(t,url,"GET").result},e.vidUpload=function(t){return t.files[0].size>10485760?void alert("视频不得大于10M"):(POSTurl=basicUrl+"/videos?",options={url:POSTurl+sortUrl(),type:"POST",success:function(t){200===t.code?e.$apply(function(){e.view.materials=ajaxSendFn({count:10},"/videos","GET").result,e.view.select=0}):alert(t.message)}},void $("#iimgform").ajaxSubmit(options))},e.submitFn=function(){if(e.view.select>=0){var t=ajaxSendFn({id:e.view.materials.items[e.view.select].id},"/pic/brand","POST");200==t.code?(e.view.pic.push(t.result),$("#addpic").modal("hide")):alert(t.message)}},e.submitVidFn=function(){$("#addvidpic").modal("hide")}}]),app.controller("ShopsCtr",["$scope","$location","$http",function(e,t,a){e.config.breadset=[{name:"门店管理",href:indexUrl+"/admin.html#/shops"},{name:"门店列表"}],e.bussniessTime={1001:"早市",1002:"午市",1003:"下午茶",1004:"晚市",1005:"宵夜"},e.text={1001:"",1002:"提交认证时间：",1003:"认证通过时间：",1004:"提交关闭时间",1005:"停用时间"},e.detailShow=-1;var o=ajaxSendFn({count:10},"/shops/shops","GET");200!=o.code&&t.path("/shops/add"),e.shops=o.result,e.select=function(){var t={};e.active&&(t.state=e.active),e.shops=ajaxSendFn(t,"/shops/shops","GET").result},e.$watch("shops.page",function(t,a){if(t&&a&&t!==a){var o={page:e.shops.page,count:e.shops.count};e.active&&(o.state=e.active),e.shops=ajaxSendFn(o,"/shops/shops","GET").result}}),e.send=function(){e.shops=ajaxSendFn({name:e.name},"/shops/shops","GET").result},e.detail=function(t,a){e.shop=ajaxSendFn({},"/shops/shop/"+t,"GET",1).result,e.detailShow=a},e.qrcodeFn=function(){e.qrcode={};var t=ajaxSendFn({},"/shops/shop/"+e.shops.items[e.detailShow].id+"/qrcode","GET");200==t.code?(e.qrcode=t.result,$("#qrcode").modal("show")):alert("门店还未认证通过")},e.deleteShopFn=function(){if(confirm("是否确定申请关闭?")){var t=ajaxSendFn({},"/shops/"+e.shop.id,"POST");200==t.code?alert("申请关闭成功！"):errorMsg(t)}}}]),app.controller("ShopsAddCtr",["$scope","$location",function(e,t){e.config.breadset=[{name:"门店管理",href:indexUrl+"/admin.html#/shops"},{name:"添加门店"}],e.posts={},e.shopType=[{code:1001,text:"支持桌边付"},{code:1002,text:"不支持桌边付"}],e.posts.shopType=e.shopType[0].code,e.areaJson1=ajaxSendFn({},"/dict/area","GET").result,e.area1change=function(){e.areaJson2=ajaxSendFn({code:e.area.area1},"/dict/area","GET").result||[],e.area.area2=e.areaJson2[0]&&e.areaJson2[0].code,e.areaJson3=!!e.area.area2&&(ajaxSendFn({code:e.area.area2},"/dict/area","GET").result||[]),e.posts.area=e.areaJson3[0]&&e.areaJson3[0].code||e.areaJson2[0]&&e.areaJson2[0].code||e.areaJson1[0]&&e.areaJson1[0].code},e.area2change=function(){e.areaJson3=ajaxSendFn({code:e.area.area2},"/dict/area","GET").result||[],e.posts.area=e.areaJson3[0]&&e.areaJson3[0].code||e.area.area2},e.postSend=function(){if(/[(())]/.test(e.posts.name))return e.config.modalContent="请不要输入带括弧的名称",void $(".modal").modal("show");var a=ajaxSendFn(e.posts,"/shops","POST",1);return 200!=a.code?(e.config.modalContent=a.message,void $(".modal").modal("show")):void t.path("/shops/add2/"+a.result.id)}}]),app.controller("ShopsAdd2Ctr",["$scope","$location","$routeParams",function(e,t,a){e.config.breadset=[{name:"门店管理",href:indexUrl+"/admin.html#/shops"},{name:"添加店长"}],e.posts={},e.postSend=function(){sendJsons={name:e.posts.name,nickname:e.posts.nickname,password:hex_md5(e.posts.password),shopId:a.shopId,roleType:"K"};for(var o in sendJsons)""!=sendJsons[o]&&sendJsons[o]&&null!=sendJsons||delete sendJsons[o];return sendJson=JSON.stringify(sendJsons),postsend=ajaxSendFn(sendJson,constUrlDict.staff,"POST",1),200!=postsend.code?void alert(postsend.message):void t.path("/shops/add3/"+a.shopId)},e.reshpwd=function(){console.log(e.staffadd_form),e.repassword==e.posts.password?e.staffadd_form.repassword.$error.pattern=!1:e.staffadd_form.repassword.$error.pattern=!0}}]),app.controller("ShopsAdd3Ctr",["$scope","$location","$routeParams",function(e,t,a){e.config.breadset=[{name:"门店管理",href:indexUrl+"/admin.html#/shops"},{name:"添加完成"}],shopsget=ajaxSendFn({},"/shops/shop/"+a.shopId,"GET"),e.shopshow=200==shopsget.code&&shopsget.result}]),app.controller("StaffCtr",["$scope","$routeParams",function(e,t){e.config.breadset=[{name:"员工管理",href:indexUrl+"/admin.html#/staff"},{name:"员工列表"}];var a=ajaxSendFn({count:10},constUrlDict["staffs-base"],"GET");if(e.staffs=a.result||[],e.$watch("staffs.page",function(t,a){if(t&&a&&t!==a){var o={page:e.staffs.page,count:e.staffs.count};e.staffs=ajaxSendFn(o,constUrlDict["staffs-base"],"GET").result}}),e.detail=function(t,a){e.staff=ajaxSendFn({shopId:t},constUrlDict["staffs-shop"],"GET",1).result,e.detailShow=a},e.modal=function(t,a){e.staffget=ajaxSendFn({},constUrlDict.staff+"/"+t,"GET").result,$("#"+a).modal("show")},e.delete=function(t){if(!confirm("一旦删除将不可恢复，是否确认删除？"))return!1;var a=ajaxSendFn({},constUrlDict["staffs-base"]+"/"+t,"POST");200==a.code?(alert("删除成功"),e.staff=ajaxSendFn({shopId:e.staffs.items[e.detailShow].id},constUrlDict["staffs-shop"],"GET").result):errorMsg(a)},e.postSend=function(){var t=e.staffget.id;delete e.staffget.id,result=ajaxSendFn(JSON.stringify(e.staffget),"/staffs/staff/"+t,"POST",1),200==result.code?($("#edit").modal("hide"),e.staff=ajaxSendFn({shopId:e.staffget.shopId},constUrlDict["staffs-shop"],"GET",1).result):errorMsg(result)},e.resetPassword=function(){if(!e.staffadd_form.$valid)return void(e.staffadd_form.submitted=!0);var t={};angular.extend(t,e.posts),t.password=hex_md5(e.posts.password),result=ajaxSendFn(t,constUrlDict["staffs-password"]+"/"+e.staffget.id,"POST"),200==result.code?($("#password").modal("hide"),alert("修改成功")):errorMsg(result)},t.shopId)for(var o=0;o<e.staffs.items.length;o++)t.shopId==e.staffs.items[o].id&&e.detail(t.shopId,o)}]),app.controller("StaffAddCtr",["$scope","$location","$routeParams",function(e,t,a){e.show={},e.posts={},e.staffadd_form={},e.config.breadset=[{name:"员工管理",href:indexUrl+"/admin.html#/staff"},{name:"添加员工"}],e.shopsget=ajaxSendFn({},"/shops/shop/"+a.shopId,"GET").result,e.textCheckJson=textCheckJson,e.textCheckErrorJson=textCheckErrorJson,e.staffadd_form.submitted=!1,e.posts.gender=0,e.shopId=a.shopId,e.staffaddsend=function(o){var n={};n=e.posts,n.shopId=a.shopId,n.roleType="keeper"==o?"K":"S",result=ajaxSendFn(JSON.stringify(n),constUrlDict.staff,"POST",1),200==result.code?(alert("添加成功"),t.path("/staff/"+a.shopId)):errorMsg(result)}}]),app.controller("Staffoperation",["$scope","$location","$routeParams",function(e,t,a){e.show={},e.posts={},e.staffadd_form={},e.breadset=[{name:"员工管理",href:indexUrl+"/admin.html#/Staff"},{name:"权限设置"}],e.submit=!0,e.textCheckJson=textCheckJson,e.textCheckErrorJson=textCheckErrorJson,e.posts.gender=0,e.password="",e.authorized=!1,e.switch=!1,e.refund={authorized:!1,object:{901:!1,902:!1,909:!1,920:!1}},e.pay={object:{1e3:!1,1001:!1,1005:!1,1101:!1}},e.staff={object:{ADD:!1,UPDATE:!1,QUERY:!1}},e.activate={object:{ADD:!1,UPDATE:!1,QUERY:!1}},e.duty={object:{UPDATE:!1,QUERY:!1}},e.activity={object:{6001:!1,6002:!1,6004:!1,6033:!1}},e.reserve={object:{ADD:!1,UPDATE:!1,DELETE:!1}},e.benefit={operations:{ADD:!1,UPDATE:!1},object:{1014:!1,1015:!1,1016:!1,1017:!1}},e.profits={operations:{ADD:!1,UPDATE:!1},object:{8002:!1,8010:!1,8011:!1,8012:!1}},e.customer={operations:{ADD:!1,UPDATE:!1,QUERY:!1},object:{}},e.check={authorized:!1,object:{STAGE:!1,"item.id":!1}},e.settime=function(t,a){"ADD"==a?e.customer.operations[t]=!e.customer.operations[t]||null:"STAGE"==a?e.check.object[t]=!e.check.object[t]||null:e.benefit.operations[t]=!e.benefit.operations[t]||null},e.settime2=function(t,a){"ADD"==a?e.customer.operations[t]=!e.customer.operations[t]||null:"STAGE"==a?e.check.object[t]=!e.check.object[t]||null:e.profits.operations[t]=!e.profits.operations[t]||null},e.grade=ajaxSendFn({},"/memberGrade","GET"),e.posts=ajaxSendFn({},"/staffs/staff/"+a.guestid+"/permission","GET"),200==e.posts.code&&(e.authorized=e.posts.result.authorized,e.posts.result.refund&&(console.log(e.posts.result.refund),e.refund.authorized=e.posts.result.refund.authorized,console.log(e.refund.authorized),angular.forEach(e.posts.result.refund.objects,function(t,a){e.refund.object[t]=!0})),e.posts.result.activate&&(e.activate.authorized=e.posts.result.activate.authorized,angular.forEach(e.posts.result.activate.operations,function(t,a){e.activate.object[t]=!0})),e.posts.result.activity&&(e.activity.authorized=e.posts.result.activity.authorized,angular.forEach(e.posts.result.activity.objects,function(t,a){e.activity.object[t]=!0})),e.posts.result.pay&&angular.forEach(e.posts.result.pay.objects,function(t,a){e.pay.object[t]=!0}),e.posts.result.staff&&(e.staff.authorized=e.posts.result.staff.authorized,angular.forEach(e.posts.result.staff.operations,function(t,a){e.staff.object[t]=!0})),e.posts.result.duty&&(e.duty.authorized=e.posts.result.duty.authorized,angular.forEach(e.posts.result.duty.operations,function(t,a){e.duty.object[t]=!0})),e.posts.result.reserve&&(e.reserve.authorized=e.posts.result.reserve.authorized,angular.forEach(e.posts.result.reserve.operations,function(t,a){e.reserve.object[t]=!0})),e.posts.result.benefit&&(e.benefit.authorized=e.posts.result.benefit.authorized,angular.forEach(e.posts.result.benefit.operations,function(t,a){e.benefit.operations[t]=!0}),angular.forEach(e.posts.result.benefit.objects,function(t,a){e.benefit.object[t]=!0})),e.posts.result.profits&&(e.profits.authorized=e.posts.result.profits.authorized,angular.forEach(e.posts.result.profits.operations,function(t,a){e.profits.operations[t]=!0}),angular.forEach(e.posts.result.profits.objects,function(t,a){e.profits.object[t]=!0})),e.posts.result.benefit&&(e.customer.authorized=e.posts.result.customer.authorized,angular.forEach(e.posts.result.customer.operations,function(t,a){e.customer.operations[t]=!0}),angular.forEach(e.posts.result.customer.objects,function(t,a){e.customer.object[t]=!0})),e.posts.result.check&&angular.forEach(e.posts.result.check.objects,function(t,a){e.check.object[t]=!0})),e.changepassword=function(){e.switch=!e.switch,e.switch?document.getElementById("btn").innerText="取消修改":(document.getElementById("btn").innerText="修改密码",document.getElementById("newpass").value=e.password="")},e.checklength=function(){if(document.getElementById("setpass")){if(e.password=document.getElementById("setpass").value,e.password.length>0&&(e.password.length<8||e.password.length>20))return e.submit=!1,void alert("密码长度应为8-20个字符");e.submit=!0}else if(document.getElementById("newpass")&&e.switch){if(e.password=document.getElementById("newpass").value,e.password.length>0&&(e.password.length<8||e.password.length>20))return e.submit=!1,void alert("密码长度应为8-20个字符");e.submit=!0}console.log(e),console.log(e.password)},e.staffaddsend=function(t){var o={password:"",refund:{objects:[],authorized:""},pay:{objects:[],authorized:""},staff:{operations:[],authorized:""},activate:{operations:[],authorized:""},duty:{operations:[],authorized:""},activity:{objects:[],authorized:""},reserve:{operations:[],authorized:""},benefit:{operations:[],objects:[],authorized:""},profits:{operations:[],objects:[],authorized:""},customer:{operations:[],objects:[],authorized:""},check:{objects:[],authorized:""}};if(angular.forEach(e.refund.object,function(e,t){e&&o.refund.objects.push(t)}),e.refund.authorized&&(o.refund.authorized=e.refund.authorized),angular.forEach(e.pay.object,function(e,t){e&&o.pay.objects.push(t)}),angular.forEach(e.staff.object,function(e,t){e&&o.staff.operations.push(t)}),e.staff.authorized&&(o.staff.authorized=e.staff.authorized),angular.forEach(e.activate.object,function(e,t){e&&o.activate.operations.push(t)}),e.activate.authorized&&(o.activate.authorized=e.activate.authorized),angular.forEach(e.duty.object,function(e,t){e&&o.duty.operations.push(t)}),e.duty.authorized&&(o.duty.authorized=e.duty.authorized),angular.forEach(e.activity.object,function(e,t){e&&o.activity.objects.push(t)}),e.activity.authorized&&(o.activity.authorized=e.activity.authorized),angular.forEach(e.reserve.object,function(e,t){e&&o.reserve.operations.push(t)}),e.reserve.authorized&&(o.reserve.authorized=e.reserve.authorized),angular.forEach(e.benefit.operations,function(e,t){e&&o.benefit.operations.push(t)}),e.benefit.authorized&&(o.benefit.authorized=e.benefit.authorized),angular.forEach(e.benefit.object,function(e,t){e&&o.benefit.objects.push(t)}),angular.forEach(e.profits.operations,function(e,t){e&&o.profits.operations.push(t)}),e.profits.authorized&&(o.profits.authorized=e.profits.authorized),angular.forEach(e.profits.object,function(e,t){e&&o.profits.objects.push(t)}),angular.forEach(e.customer.operations,function(e,t){e&&o.customer.operations.push(t)}),e.customer.authorized&&(o.customer.authorized=e.customer.authorized),e.customer.operations.ADD&&angular.forEach(e.customer.object,function(e,t){e&&o.customer.objects.push(t)}),angular.forEach(e.check.object,function(e,t){e&&o.check.objects.push(t)}),e.check.authorized&&(o.check.authorized=e.check.authorized),o.benefit.operations.length>=1&&o.benefit.objects.length<1)return void alert("请选择顾客权益类型");if(o.benefit.operations.length<1&&(console.log(o.benefit.operations),o.benefit.objects=[]),o.profits.operations.length>=1&&o.profits.objects.length<1)return void alert("请选择奖励类型");if(o.profits.operations.length<1&&(console.log(o.profits.operations),o.profits.objects=[]),e.customer.operations.ADD&&o.customer.objects.length<1)return void alert("请选择会员等级");if(!e.authorized||e.password)o.password=hex_md5(e.password),o.refund.authorized=e.refund.authorized,o.activate.authorized=e.activate.authorized,o.pay.authorized=e.pay.authorized,o.check.authorized=e.check.authorized,o.customer.authorized=e.customer.authorized,o.benefit.authorized=e.benefit.authorized,o.profits.authorized=e.profits.authorized,o.duty.authorized=e.duty.authorized,o.activity.authorized=e.activity.authorized,o.reserve.authorized=e.reserve.authorized;else{if(!e.authorized&&!e.password)return void alert("密码应由长度为8-20个字符");console.log("不修改密码"),delete o.password}o=JSON.stringify(o),result=ajaxSendFn(o,"/staffs/staff/"+a.guestid+"/permission","POST",1),200==result.code?(alert("添加成功"),window.location.reload(!0)):errorMsg(result)}}]),app.controller("passwordCtr",["$scope","$location",function(e,t){e.show={},e.posts={},e.staffadd_form={},e.config.breadset=[{name:"修改密码"}],e.staffaddsend=function(){if(!e.staffadd_form.$valid)return void(e.staffadd_form.submitted=!0);if(e.posts.oldPassword===e.posts.password)return void alert("原密码和新密码不能相同");var a={};angular.extend(a,e.posts),a.old=hex_md5(e.posts.oldPassword),a.password=hex_md5(e.posts.password),delete a.oldPassword,result=ajaxSendFn(JSON.stringify(a),constUrlDict["staffs-password"],"POST"),200==result.code?(alert("修改成功"),t.path("/")):errorMsg(result)}}]),app.controller("RuleCtr",["$rootScope","$scope","$location","$filter","$document","$compile",function(e,t,a,o,n,s){t.config.breadset=[{name:"活动管理",href:indexUrl+"/admin.html#/rule",class:"rule"},{name:"活动列表"}];var r=e.lastShow;if("/rule"==a.$$path)var i=ajaxSendFn({},"/activity","GET").result||[];else{var i=ajaxSendFn({isConsume:!0},"/activity","GET").result||[];t.config.breadset[0].class="ruleConsume"}t.view={},t.view.rule=o("orderBy")(i,"createTime",!0),null!=r&&(t.view.rule[r].show=1),t.addFn=function(){"/rule"==a.$$path?a.path("/rule/add"):a.path("/rule/addconsume")},t.pannel=function(e){1==t.view.rule[e].show?t.view.rule[e].show=0:($.each(t.view.rule,function(e){t.view.rule[e].show=0}),t.view.rule[e].show=1)},t.activityOn=function(e,a){re=ajaxSendFn({},"/activity/"+e+"/on","POST"),200==re.code?t.view.rule[a].on=!0:errorMsg(re)},t.activityOff=function(e,a){re=ajaxSendFn({},"/activity/"+e+"/off","POST"),200==re.code?t.view.rule[a].on=!1:console.error(re)},t.activityDel=function(e,a){var o=confirm("确认删除？");o&&(re=ajaxSendFn({},"/activity/"+e,"DELETE"),200==re.code?t.view.rule.splice(a,1):alert(re.message))},t.activeFn=function(e,n){if(re=ajaxSendFn({},"/activity/"+e+"/"+n,"POST"),200==re.code){if("/rule"==a.$$path)var s=ajaxSendFn({},"/activity","GET").result||[];else var s=ajaxSendFn({isConsume:!0},"/activity","GET").result||[];t.view.rule=o("orderBy")(s,"createTime",!0)}else alert(re.message)},t.copyFn=function(t){var a=angular.element('<span id="ngClipboardCopyId">'+t+"</span>"),o=n.find("body").eq(0);o.append(s(a)(e));var r=angular.element(document.getElementById("ngClipboardCopyId")),i=document.createRange();i.selectNode(r[0]),window.getSelection().removeAllRanges(),window.getSelection().addRange(i);var l=document.execCommand("copy"),d=l?"成功":"失败";alert("复制"+d),window.getSelection().removeAllRanges(),a.remove()}}]),app.controller("RuleAddCtr",["$scope","$location","$filter","$routeParams",function(e,t,a,o){e.config.breadset=[{name:"活动管理",href:indexUrl+"/admin.html#/rule"},{name:"设置活动范围"}],e.checkshop={},e.set={times:ajaxSendFn({},"/businesstimes/all","GET").result,list:ajaxSendFn({state:1002},"/shops","GET").result,list2:[],timeType:{1001:"早市",1002:"午市",1003:"下午茶",1004:"晚市",1005:"宵夜"},periods:[]},e.set.time=getSubtimes(e.set.times,e.set.timeType),e.set.list||(alert("目前还没有添加门店"),t.path("/shops")),e.set.nonParticipation=ajaxSendFn({},"/nonParticipation/content","GET").result,e.checkallstr=0,e.posts={periods:[],excludeWeekend:!1,excludeHoliday:!1,shared:[],shops:[]},e.view={data:{},effectDates:{},periods:[],zhiding:e.config.time},o.activityid?e.view.isEdit=!0:e.view.isEdit=!1,"/rule/add"==t.$$path?e.ruleCategory=onlineRuleObj:"/rule/addconsume"==t.$$path?e.ruleCategory=consumeRuleObj:e.ruleCategory=ruleCategory,e.$watch("posts.activityCategory",function(t,a){t&&t!==a&&(e.shareRuleCategory=getShareCategory(t))}),e.filterShared=function(){return arrayFilter(e.posts.shared,function(e){return!!e})},e.checkAllCatagory=function(){e.posts.catagoryAll?angular.forEach(e.shareRuleCategory,function(e,t){this[t]=e.id},e.posts.shared):e.posts.shared=[]},e.categoryName=function(t){var a={};if(t){t.split("_")[0];angular.forEach(e.ruleCategory,function(e,a){e.id===t&&(this.name=e.name)},a)}return a.name||"类型错误"},e.$watch("set.shopAll",function(t,a){t!==a&&(t?angular.forEach(e.set.list,function(e,t){this[t]=e.id},e.posts.shops):e.posts.shops=[])}),e.settime=function(t,a){e.view.periods[t]=e.view.periods[t]?null:a},e.sendJsons=function(){sendtype=o.activityid?"EDIT":"ADD",sendid=o.activityid?o.activityid:"",e.posts.shops=arrRemoveNullFN(e.posts.shops),e.posts.periods=arrRemoveNullFN(e.view.periods);var n={dateRange:{}};if(n.nonParticipationId=e.posts.nonParticipationId,e.posts.way&&(n.way=e.posts.way),n.shared=uniqArr(arrRemoveNullFN(e.posts.shared)),n.name=e.posts.name,n.descriptor=e.posts.descriptor,n.activityCategory=e.posts.activityCategory,n.shops=e.posts.shops,n.additional=e.posts.additional,e.posts.picUrl&&(n.picUrl=e.posts.picUrl),e.posts.allDay?n.allDay=!0:n.periods=e.posts.periods,n.excludeAmount=e.posts.excludeAmount,n.pathway=e.posts.pathway,n.recommend=e.posts.recommend,
n.recommend&&"AUTOMATIC"!==n.recommend.way&&delete n.recommend.proportion,!e.view.data.dateType)return void alert("还未选择有效期！");if(n.dateRangeCategory=e.view.data.dateType,"BIRTHDAY"===e.view.data.dateType&&e.view.data.subType&&(n.dateRangeCategory=e.view.data.subType),"CONTINUOUS"===e.view.data.dateType){if(!e.view.dateRange.startDate||!e.view.dateRange.endDate)return void alert("请填写开始和结束日期!");if(e.view.dateRange.endDate<e.view.dateRange.startDate)return void alert("结束日期不能小于开始日期!");n.dateRange.startDate=a("date")(e.view.dateRange.startDate,"yyyy-MM-dd 00:00:00"),n.dateRange.endDate=a("date")(e.view.dateRange.endDate,"yyyy-MM-dd 23:59:59")}else"BIRTHDAY"===e.view.data.dateType&&"AROUND_FIX_DATE"===e.view.data.subType&&(n.dateRange.beforeDays=e.view.dateRange.beforeDays||0,n.dateRange.afterDays=e.view.dateRange.afterDays||0);if(n.dateRange.selectCategory=e.view.dateRange.selectCategory||"NONE","MANUAL_SELECT"===e.view.dateRange.subType){var s=arrayMap(objectKeys(e.view.dateRange.selectDates),function(e){return e+" 00:00:00"});isEmptyObject(s)||(n.dateRange.selectDates=s)}else if("MONTH_DAYS"===e.view.dateRange.subType){var s=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectDays,notNull)),parseInt);isEmptyObject(s)||(n.dateRange.selectDays=s)}else if("WEEKLY_DAY"===e.view.dateRange.subType){var s=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectWeekDays,notNull)),parseInt);isEmptyObject(s)||(n.dateRange.selectWeekDays=s)}return"SELECTED_DATES"!==n.dateRangeCategory&&"EXCLUDE"===n.dateRange.selectCategory&&1==objectCount(n.dateRange)?void alert("没有指定排除日期！"):"SELECTED_DATES"===n.dateRangeCategory&&1==objectCount(n.dateRange)?void alert("没有指定日期！"):("FIRSTGIFT"==e.posts.activityCategory&&angular.element(document.getElementById("wx"))[0]&&angular.element(document.getElementById("wx"))[0].checked&&(n.followLimit=!0),sendJson=JSON.stringify(n),postsend=ajaxSendFn(sendJson,concatUrl(constUrlDict.activity,sendid),"POST",1),void(200==postsend.code?"ADD"==sendtype?t.path("/rule/add2/"+postsend.result.id):(alert("保存成功"),history.back()):errorMsg(postsend)))},e.addNonParticipation=function(){e.goods="",$("#NonParticipation").modal("show")},e.oldFN=function(){var t=ajaxSendFn({},concatUrl(constUrlDict.activity,o.activityid),"GET").result;if(t){e.posts.name=t.name,e.posts.descriptor=t.descriptor,e.posts.hasRules=t.rules&&t.rules.length>0||!1,e.posts.activityCategory=t.activityCategory,e.posts.additional=t.additional,t.followLimit&&(e.posts.followLimit=t.followLimit),t.pathway&&(e.posts.pathway=t.pathway),e.posts.recommend=t.recommend,t.way&&(e.posts.way=t.way),t.allDay&&(e.posts.allDay=t.allDay),t.picUrl&&(e.posts.picUrl=t.picUrl),e.view.data.dateType=t.dateRangeCategory,"AROUND_FIX_DATE"!==t.dateRangeCategory&&"MONTH_EFFECTIVE"!==t.dateRangeCategory||(e.view.data.dateType="AROUND_FIX_DATE",e.view.data.subType=t.dateRangeCategory),e.view.data[e.view.data.dateType]={dateRange:t.dateRange},e.view.dateRange=e.view.data[e.view.data.dateType].dateRange,t.dateRange&&(t.dateRange.selectDates?(e.view.dateRange.subType="MANUAL_SELECT",e.view.dateRange.selectDates=arrayMap(e.view.dateRange.selectDates,function(e){return e.split(/\s+/)[0]})):t.dateRange.selectDays?e.view.dateRange.subType="MONTH_DAYS":e.view.dateRange.subType="WEEKLY_DAY"),e.posts.activityCategory&&(e.shareRuleCategory=getShareCategory(e.posts.activityCategory)),e.posts.excludeAmount=t.excludeAmount,e.posts.nonParticipationId=t.nonParticipationId;var a={};if(t.shops)for(var n=0,s=t.shops.length||0;n<s;n++)a[t.shops[n]]=1;for(var n=0,s=e.set.list.length||0;n<s;n++)e.set.list[n].id in a&&(e.posts.shops[n]=e.set.list[n].id);angular.forEach(e.set.time,function(e,t){this.push(t)},e.view.periods),angular.forEach(e.view.periods,function(e,a){t.periods&&t.periods.indexOf(e)!=-1||(this[a]=null)},e.view.periods),angular.forEach(e.shareRuleCategory,function(e,a){t.shared&&t.shared.indexOf(e.id)!=-1?this[a]=e.id:this[a]=!1},e.posts.shared)}},o.activityid&&e.oldFN()}]),app.controller("RuleExhibitionAddCtr",["$scope","$location","$filter","$routeParams",function(e,t,a,o){e.config.breadset=[{name:"活动管理",class:"exhibition",href:indexUrl+"/admin.html#/rule/exhibition"},{name:"设置活动范围"}],e.posts={periods:[],excludeWeekend:!1,excludeHoliday:!1,shared:[],shops:[]},e.view={type:[{id:"LINEUP",name:"排队"},{id:"IRREGULAR",name:" 不定期权益"}],data:{},effectDates:{},periods:[],zhiding:e.config.time},o.activityid?e.view.isEdit=!0:e.view.isEdit=!1,e.sendJsons=function(){sendtype=o.activityid?"EDIT":"ADD";var n={dateRange:{}};if(n.name=e.posts.name,n.activityCategory=e.posts.activityCategory,n.additional=e.posts.additional,!e.view.data.dateType)return void alert("还未选择有效期！");if(n.dateRangeCategory=e.view.data.dateType,"BIRTHDAY"===e.view.data.dateType&&e.view.data.subType&&(n.dateRangeCategory=e.view.data.subType),"CONTINUOUS"===e.view.data.dateType){if(!e.view.dateRange.startDate||!e.view.dateRange.endDate)return void alert("请填写开始和结束日期!");if(e.view.dateRange.endDate<e.view.dateRange.startDate)return void alert("结束日期不能小于开始日期!");n.dateRange.startDate=a("date")(e.view.dateRange.startDate,"yyyy-MM-dd 00:00:00"),n.dateRange.endDate=a("date")(e.view.dateRange.endDate,"yyyy-MM-dd 23:59:59")}else"BIRTHDAY"===e.view.data.dateType&&"AROUND_FIX_DATE"===e.view.data.subType&&(n.dateRange.beforeDays=e.view.dateRange.beforeDays||0,n.dateRange.afterDays=e.view.dateRange.afterDays||0);if(n.dateRange.selectCategory=e.view.dateRange.selectCategory||"NONE","MANUAL_SELECT"===e.view.dateRange.subType){var s=arrayMap(objectKeys(e.view.dateRange.selectDates),function(e){return e+" 00:00:00"});isEmptyObject(s)||(n.dateRange.selectDates=s)}else if("MONTH_DAYS"===e.view.dateRange.subType){var s=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectDays,notNull)),parseInt);isEmptyObject(s)||(n.dateRange.selectDays=s)}else if("WEEKLY_DAY"===e.view.dateRange.subType){var s=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectWeekDays,notNull)),parseInt);isEmptyObject(s)||(n.dateRange.selectWeekDays=s)}return"SELECTED_DATES"!==n.dateRangeCategory&&"EXCLUDE"===n.dateRange.selectCategory&&1==objectCount(n.dateRange)?void alert("没有指定排除日期！"):"SELECTED_DATES"===n.dateRangeCategory&&1==objectCount(n.dateRange)?void alert("没有指定日期！"):("ADD"==sendtype?postsend=ajaxSendFn(n,"/activity/exhibition","POST",1):postsend=ajaxSendFn(n,"/activity/exhibition/"+o.activityid,"PUT",1),void(200==postsend.code?"ADD"==sendtype?t.path("activity/exhibition"):(alert("保存成功"),history.back()):errorMsg(postsend)))},e.oldFN=function(){var t=ajaxSendFn({},"/activity/exhibition/"+o.activityid,"GET").result;t&&(e.posts.name=t.name,e.posts.activityCategory=t.activityCategory,e.posts.additional=t.additional,e.view.data.dateType=t.dateRangeCategory,"AROUND_FIX_DATE"!==t.dateRangeCategory&&"MONTH_EFFECTIVE"!==t.dateRangeCategory||(e.view.data.dateType="AROUND_FIX_DATE",e.view.data.subType=t.dateRangeCategory),e.view.data[e.view.data.dateType]={dateRange:t.dateRange},e.view.dateRange=e.view.data[e.view.data.dateType].dateRange,t.dateRange&&(t.dateRange.selectDates?(e.view.dateRange.subType="MANUAL_SELECT",e.view.dateRange.selectDates=arrayMap(e.view.dateRange.selectDates,function(e){return e.split(/\s+/)[0]})):t.dateRange.selectDays?e.view.dateRange.subType="MONTH_DAYS":e.view.dateRange.subType="WEEKLY_DAY"))},o.activityid&&e.oldFN()}]),app.controller("RuleExhibitionShowCtr",["$scope","$location","$filter","$routeParams",function(e,t,a,o){e.config.breadset=[{name:"活动管理",class:"exhibition",href:indexUrl+"/admin.html#/rule/exhibition"},{name:"设置活动范围"}],e.view={exhibition:ajaxSendFn({},"/activity/exhibition","GET").result||[]},e.removeFn=function(t){var a=confirm("确认删除？");if(a){var o=ajaxSendFn({},"/activity/exhibition/"+t,"DELETE");200==o.code?e.view.exhibition=ajaxSendFn({},"/activity/exhibition","GET").result||[]:alert(o.message)}}}]),app.controller("RuleMemberCtr",["$scope","$filter",function(e,t){e.config.breadset=[{name:"活动管理",href:indexUrl+"/admin.html#/rule",class:"member"},{name:"会员规则管理"}],e.plan={add:0},e.upgradeType={CUSTOMER:"CUSTOMER",MEMBER:"MEMBER"};var a=ajaxSendFn({},"/memberUpgrade","GET").result||[];e.view={member:t("orderBy")(a.strategy,"grade",!1)||[],state:a.on,plan:{},isUpdate:!1,maxGrades:6,rules:{}},e.posts=[],e.check={},e.closeModal=function(){e.view.member[e.view.plan.level-1].name=e.oldGradeName,e.view.isUpdate=!1,$("#memberadd").modal("hide")},e.handleClick=function(t){e.view.isUpdate?e.updatePlan(t):e.addplan(t)},e.validateName=function(t,a){var o=!1;return angular.forEach(e.view.member,function(e,n){o||n!=t-1&&a===e.toName&&(o=!0)}),o},e.addnewFn=function(t){e.tem={},e.planform.memberName.$touched=!1,e.view.plan.level=e.view.member.length+1,$("#memberadd").modal("show")},e.updateFn=function(t){e.tem=e.view.member[t-1],e.oldGradeName=e.tem.name,e.view.isUpdate=!0,e.view.plan.level=t,$("#memberadd").modal("show")},e.switchStatus=function(t){var a=t===!0?"on":"off",o=ajaxSendFn({},"/memberUpgrade/"+a,"POST");if(200!=o.code)errorMsg(o);else{e.view.state=t;$("#turn"+a).modal("hide")}},e.addplan=function(t){send=ajaxSendFn({name:e.tem.name},"/memberGrade","POST"),200==send.code?(e.tem.id=send.result,!e.view.member,e.view.member[e.view.member.length]={toName:e.tem.name,toId:e.tem.id,toGrade:e.view.member.length+1},e.view.show={toName:e.tem.name,toGrade:e.view.member.length-1},e.posts=[],$("#memberadd").modal("hide"),e.showFn(e.view.member.length)):errorMsg(send),e.plan={add:1}},e.updatePlan=function(t){return e.validateName(t,e.tem.name)||e.tem.name===e.oldGradeName?void alert("会员名称已被占用"):(send=ajaxSendFn({name:e.tem.name},"/memberGrade/"+e.tem.id,"POST"),void(200==send.code?(e.view.member[t-1].name=e.tem.name,$("#memberadd").modal("hide"),e.view.isUpdate=!1):(e.view.member[t-1].name=e.oldGradeName,errorMsg(send))))},e.closeFn=function(t){e.plan[t]=0},e.showFn=function(t){if(e.view.show=e.view.member[t-1],!e.view.member[t-1].Upgrade){var a=ajaxSendFn({},"/memberUpgrade/toId/"+e.view.member[t-1].toId,"GET");e.view.member[t-1].Upgrade=a.result.strategies||[],e.rules=a.result,e.rules.strategies=[],e.rules.strategies.push({fromId:"CUSTOMER",fromName:"一般顾客"});for(var o=0;o<t-1;o++)e.rules.strategies.push({fromId:e.view.member[o].toId,fromName:e.view.member[o].toName})}e.posts={BUY:[],POINT_EXCHANGE:[],POINT:[],SUM_COST:[],CHARGE:[]},e.check={};for(x in e.view.member[t-1].Upgrade)n=e.view.member[t-1].Upgrade[x].type,e.posts[n]||(e.posts[n]=[{}]),e.posts[n].push({fromId:e.view.member[t-1].Upgrade[x].fromId,value:e.view.member[t-1].Upgrade[x].value,_id:e.view.member[t-1].Upgrade[x]._id}),e.check[n]=!0;for(var n in e.posts)0==e.posts[n].length&&e.posts[n].push({});$("#memberedit").modal("show")},e.addFn=function(t){return t.length>=e.view.show.toGrade?void alert("不可继续增加升级规则"):void t.push({})},e.removeFn=function(e,t){e.splice(t,1)},e.deleteFn=function(t){if(!confirm("一旦删除将不可恢复，是否确认删除？"))return!1;var a=ajaxSendFn({},"/memberGrade/"+e.view.member[t].toId,"DELETE");200==a.code?e.view.member.splice(t,1):alert(a.message)},e.postSend=function(){var t={},a=[];if(toid=e.view.member[e.view.show.toGrade-1].toId,e.validateName(e.view.show.toGrade,e.view.show.toName))return void alert("会员名称已被占用");for(var o in e.posts)if(e.check[o])if("FREE"!=o)for(var n in e.posts[o]){var s={toId:toid,type:o,fromId:e.posts[o][n].fromId};e.posts[o][n].value&&(s.value=e.posts[o][n].value),e.posts[o][n]._id&&(s._id=e.posts[o][n]._id),a.push(s)}else a.push({toId:toid,type:o,fromId:"CUSTOMER"});t.toId=toid,t.toName=e.view.show.toName,t.posterUrl=e.view.show.posterUrl,t.cardUrl=e.view.show.cardUrl,t.backgroundColor=e.view.show.backgroundColor,t.strategies=a,re=ajaxSendFn(JSON.stringify(t),"/memberUpgrade","POST",1),200==re.code?(e.view.member=ajaxSendFn({},"/memberUpgrade","GET").result.strategy||[],e.view.state=!1,$("#memberedit").modal("hide"),e.plan.add=0):errorMsg(re)}}]),app.controller("RuleAdd2Ctr",["$scope","$location","$filter","$routeParams","CouponFactory",function(e,t,a,o,n){e.config.breadset=[{name:"活动管理",href:indexUrl+"/admin.html#/rule"},{name:"修改活动详情"}],e.btnDisable=0,e.today=a("date")(new Date,"yyyy-MM-dd"),e.tem={rules:{}},e.coupon={shared:[],shops:[]},e.posts={coupons:{}},e.tel={inviters:""},e.transferMap={POINT_CONSUME:"POINTCONSUME",COUPON_FREE:"COUPONFREE",CHARGE_CONSUME:"CHARGECONSUME",SPECIAL_PRICE:"SPECIALPRICE",LIMIT_REDUCE:"LIMITREDUCE",SPEND_AS:"SPENDAS",SET_MEAL:"SETMEAL",GIVEN_UPGRADE:"GIVENUPGRADE",CHARGE_FREE:"CHARGEFREE",BIRTH_BENEFIT:"BIRTHBENEFIT",FIRST_GIFT:"FIRSTGIFT"},e.transferMapRev={POINTCONSUME:"POINT_CONSUME",COUPONFREE:"COUPON_FREE",CHARGECONSUME:"CHARGE_CONSUME",SPECIALPRICE:"SPECIAL_PRICE",LIMITREDUCE:"LIMIT_REDUCE",SPENDAS:"SPEND_AS",SETMEAL:"SET_MEAL",GIVENUPGRADE:"GIVEN_UPGRADE",CHARGEFREE:"CHARGE_FREE",BIRTHBENEFIT:"BIRTH_BENEFIT",FIRSTGIFT:"FIRST_GIFT"},e.view={},e.view1={},e.temcoupons2={},e.temcoupons=[],e.ruleCategory=consumeRuleObj,e.ruleCategory1=onlineRuleObj,e.obtainRepeatCategory=obtainRepeatCategory,e.cons=function(e,t){console.log(e),console.log(t)},e.ruleFn={openOrClose:function(){$("#add").modal("show"),e.isOpenOrClose=!0,console.log("22")},testAddOk:function(){$("#add").modal("hide"),e.isOpenOrClose=!1,alert("添加成功"),console.log("33")},testAddFail:function(e){errorMsg(e),console.log("44")},getCpouponFn:function(){e.view1=ajaxSendFn({},"/activity/factor","GET").result||[],e.view.coupons=e.view1.COUPON||[],e.view.rewards=e.view1.REWARD||[],console.log("55")},getCouponType:function(t){console.log("66");for(var a=0;e.view.coupons&&a<e.view.coupons.length;a++)if(e.view.coupons[a].id===t)return e.view.coupons[a].category},changeCoupon:function(t,a){if(console.log("77"),a.id){a.count=1;for(var o=0;o<e.view.coupons.length;o++)if(e.view.coupons[o].id===a.id){a.name=e.view.coupons[o].name;break}}},oldRuleFn:function(){var t=ajaxSendFn({},"/activity/"+o.activityid+"/rule","GET").result;switch(e.view={counponType:{OFFSETCASH:"代金券",DISCOUNT:"折扣券",PHYSICAL:"实物券",GIFT:"礼券",new:"新增券"}},e.ruleFn.getCpouponFn(),e.tem.activityCategory=t.category.split("_")[0],e.tem.activityCategory){case"DISCOUNT":e.view.rules={DISCOUNT:{name:"打折",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addFn,postFunc:e.ruleFn.sendFn,content:{DISCOUNT:[]}}};break;case"SPECIALPRICE":e.view.rules={SPECIALPRICE:{name:"特价",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addCouponFn,dishes:ajaxSendFn({},"/dishes/usable","GET").result||[],postFunc:e.ruleFn.sendFn,content:{SPECIALPRICE:[]}}};break;case"POINT":e.view.rules={POINT:{name:"消费积分",state:"",show:0,addFunc:e.ruleFn.addFn,postFunc:e.ruleFn.sendFn,content:{POINT:[]}}};break;case"POINTCONSUME":e.view.rules={POINTCONSUME:{name:"积分抵现",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addFn,postFunc:e.ruleFn.sendFn,content:{POINTCONSUME:[]}}};break;case"CHARGE":e.view.rules={CHARGE:{name:"充值",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addCouponFn,postFunc:e.ruleFn.sendCouponFn,content:{CHARGE:[]}}};break;case"GIVENUPGRADE":e.view.rules={GIVENUPGRADE:{name:"升级",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addCouponFn,postFunc:e.ruleFn.sendCouponFn,content:{GIVENUPGRADE:[]}}};break;case"CHARGECONSUME":e.view.rules={CHARGECONSUME:{name:"使用充值卡",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addFn,postFunc:e.ruleFn.sendChargeConsumeFn,content:{CHARGECONSUME:[]}}};break;case"COUPON":e.view.rules={COUPON:{name:"返券活动",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addCouponFn,postFunc:e.ruleFn.sendCouponFn,content:{COUPON:[]}}};break;case"COUPONFREE":e.view.rules={COUPONFREE:{name:"送券活动",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addCouponFn,postFunc:e.ruleFn.sendCouponFn,content:{COUPONFREE:[]}}};break;case"FIRSTGIFT":e.view.rules={FIRSTGIFT:{name:"新人礼",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addCouponFn,postFunc:e.ruleFn.sendCouponFn,content:{FIRSTGIFT:[]}}};break;case"BIRTHBENEFIT":e.view.rules={BIRTHBENEFIT:{name:"生日送券活动",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addCouponFn,postFunc:e.ruleFn.sendCouponFn,content:{BIRTHBENEFIT:[]}}};break;case"EXCHANGE":e.view.rules={EXCHANGE:{name:"积分兑换",state:"",show:0,addFunc:e.ruleFn.addCouponFn,postFunc:e.ruleFn.sendCouponFn,content:{EXCHANGE:[]}}};break;case"TICKET":e.view.rules={TICKET:{name:"红票",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addCouponFn,postFunc:e.ruleFn.sendCouponFn,content:{TICKET:[]}}};break;case"LIMITREDUCE":e.view.rules={LIMITREDUCE:{name:"满减",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addFn,postFunc:e.ruleFn.sendFn,content:{LIMITREDUCE:[]}}};break;case"SPENDAS":e.view.rules={SPENDAS:{name:"折扣",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addFn,postFunc:e.ruleFn.sendFn,content:{SPENDAS:[]}}};break;case"SETMEAL":e.view.rules={SETMEAL:{name:"套餐组合",uncheck:!0,state:"",show:0,meals:ajaxSendFn({},"/meals/usable","GET").result||[],addFunc:e.ruleFn.addCouponFn,postFunc:e.ruleFn.sendFn,content:{SETMEAL:[]}}};break;case"CHARGEFREE":e.view.rules={CHARGEFREE:{name:"充值免单",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addFn,postFunc:e.ruleFn.sendFn,content:{CHARGEFREE:[]}}};break;case"FOLLOW":e.view.rules={FOLLOW:{name:"关注有礼",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addCouponFn,postFunc:e.ruleFn.sendCouponFn,content:{FOLLOW_COUPON:[]}}}}console.log("222222"),console.log(e.view.rules),e.view.shop=ajaxSendFn({state:"1002"},"/shops","GET").result||[],e.tem.shops=[];for(var a in e.view.shop)e.tem.shops.push(e.view.shop[a].id);if(t&&t.rules){e.tem.rules={},e.tem.rules[e.tem.rules.type]=e.tem.rules;var n=t.rules;if(n){e.btnDisable=1;var s=n.type;e.transferMap.hasOwnProperty(s)&&(n.type=e.transferMap[s]),e.ruleFn.stateFn(n.type,"show",1,n)}console.log("11")}},stateFn:function(t,a,o,n){console.log("88");var s=t.split("_")[0];if(s in e.view.rules&&(e.view.rules[s].state=a,e.view.rules[s].show=o),"add"==a&&e.ruleFn.buttonFn(t),!n)return void(e.btnDisable=1);var r=n.type;o&&(n.celling&&(n.celling=100*n.celling),e.view.rules[s].content[r]=n)},closeFn:function(t){"edit"==e.view.rules[t].state?e.view.rules[t].state="show":"add"==e.view.rules[t].state&&(e.view.rules[t].state="show")},buttonFn:function(t){if(console.log("99"),console.log(t),"show"==e.view.rules[t].state)e.ruleFn.postFn(t),e.ruleFn.memberFn(),e.view.rules[t].state="edit";else if("edit"==e.view.rules[t].state){var a=e.view.rules[t].postFunc(t);a&&(e.view.rules[t].state="show")}else if("add"==e.view.rules[t].state){for(x in e.view.rules[t].content)e.view.rules[t].addFunc(x);e.view.rules[t].state="edit",$("#showadd").modal("hide")}},memberFn:function(){console.log("1010"),e.view.member=e.tem.member=e.view1.MEMBERGRADE||[],e.view.member1=[],e.view.member=a("orderBy")(e.view.member,"grade"),e.view.member1.push({id:"ALL",name:"全员"}),e.view.member.push({id:"ALL",name:"全员"}),e.view.member.push({id:"MEMBER",name:"任一会员"}),"GIVENUPGRADE"==e.tem.activityCategory&&e.view.member.push({id:"CUSTOMER",name:"非会员"}),"COUPONFREE"==e.tem.activityCategory&&e.view.member.push({id:"FOLLOWED",name:"微信粉丝"}),e.tem.member1=e.view.member},postFn:function(t){console.log("1111"),console.log(t);var a=e.view.rules[t].content;e.posts[t]={};for(x in a){var o=!0;e.posts[t][x]=a[x],a[x]instanceof Array&&(o=!1),e.posts[t][x].check=o,a[x].detail&&Object.keys(a[x].detail).length||e.view.rules[t].addFunc(x)}},addCouponFn:function(t){console.log("1212"),e.ruleFn.addFn(t,function(a,o){var n=e.posts[a][t].detail.ALL;if(n&&n.length>0&&!isEmptyObject(n[0])){var s={};s.value=[{}],e.posts[a][t].detail.ALL.push(s)}else{var s=e.posts[a][t].detail.ALL[0];s.value=[{}]}})},addFn:function(t,a){console.log("1313");var o,n,s=t.split("_");if(s&&s.length>0&&(o=s[0]),s&&s.length>1&&(n=s[1]),!e.posts[o]||!e.posts[o][t]||!e.posts[o][t].detail||isEmptyObject(e.posts[o][t].detail))return e.posts[o]||(e.posts[o]={}),e.posts[o][t]=e.view.rules[o].content[t],e.posts[o][t].detail={ALL:[{}]},void(a&&a(o,n));if(e.posts[o][t].detail.ALL){var r={};a?a(o,n):e.posts[o][t].detail.ALL.push(r)}else e.posts[o][t].detail.ALL=[{}],a&&a(o,n)},removeFn:function(t,a,o){console.log("1414");var n=t.split("_")[0];e.posts[n][t].detail[a][o]&&e.posts[n][t].detail[a].splice(o,1)},checkCouponList:function(t){console.log("1515");for(var a=0;t&&a<t.length-1;a++)for(var o=a+1;o<t.length;o++)if(t[a].id===t[o].id)return!0;for(var a=0;t&&a<t.length-1;a++)for(var n=e.ruleFn.getCouponType(t[a].id),o=1;o<t.length;o++){var s=e.ruleFn.getCouponType(t[o].id);if(n===s)return!0}return!1},sendChargeConsumeFn:function(t){return console.log("1616"),e.ruleFn.sendFn(t,void 0,void 0,function(e){var t=e.detail.ALL[0];t.amount=1,t.currentAmount=t.count=0})},sendCouponFn:function(t){return console.log("1717"),e.ruleFn.sendFn(t,function(t,a){if("COUPON"===t)for(var o in a)if(a[o]&&a[o].length>0&&e.ruleFn.checkCouponList(a[o][0].value))return{message:"券或券类型不能重复"}},function(e,t){if(e&&"COUPON"===e)for(var a in t.detail){var o={};for(var n in t.detail[a]){if(o[a]===t.detail[a][n].value[0].id)return{message:"注意：券不能重复"};o[a]=t.detail[a][n].value[0].id}}})},sendFn:function(t,a,n,s){console.log("1818");var r=e.posts[t],i={};for(var l in r)if(e.view.rules[t].uncheck||r[l].check){e.transferMapRev.hasOwnProperty(l)?i.type=e.transferMapRev[l]:i.type=l,i.detail={},r[l]._id&&(i._id=r[l]._id),r[l].amountLimit&&(i.amountLimit=r[l].amountLimit),r[l].celling&&(i.celling=parseInt(r[l].celling)/100,r[l].firstLimit?i.firstLimit=!0:i.firstLimit=!1),"CHARGE_CONSUME"==i.type&&(r[l].allpurpose?i.allpurpose=!0:i.allpurpose=!1),"number"==typeof r[l].countLimit&&(i.countLimit=r[l].countLimit),r[l].timesLimit&&(i.timesLimit=r[l].timesLimit),r[l].obtainCategory&&(i.obtainCategory=r[l].obtainCategory);var d,c=r[l].detail,u=l.split("_");u&&u.length>1&&(d=u[1]);for(z in c)for(w in c[z]){var p=c[z][w],m={};if(("number"==typeof p.amount||p.amount)&&(m.amount=p.amount),p.score&&(m.score=p.score),p.gradeId&&(m.gradeId=p.gradeId),p.value&&0!=p.value.length){if(m.value=p.value,m.value&&m.value.length)for(var l in m.value)delete m.value[l].$$hashKey}else"CHARGE_CONSUME"==i.type&&(m.value=!1);void 0!==p.limit&&(m.limit=p.limit),p.count&&(m.count=p.count),p.currentAmount&&(m.currentAmount=p.currentAmount),i.detail[p.id]?i.detail[p.id].push(m):i.detail[p.id]=[m]}if("CHARGE"==i.type&&angular.forEach(i.detail.ALL,function(e,t){e.value&&e.value[0].category||delete e.value}),n&&"function"==typeof n&&(obj=n(d,i),obj))return alert(obj.message),!1;s&&"function"==typeof s&&s(i)}if("TICKET"==e.tem.activityCategory){if(!e.tel.inviters)return void alert("请输入邀请码");i.inviters=e.tel.inviters.split(",")}var v=ajaxSendFn(i,"/activity/"+o.activityid+"/rule","POST",1);return 200!=v.code?(errorMsg(v),!1):(e.ruleFn.oldRuleFn(),!0)},addCouponPlanFn:function(t){console.log("1919"),"new"==t&&e.ruleFn.showCouponPlanFn()},addRuleFn:function(){console.log("2020"),e.view.modal={title:"添加活动内容",html:"addrule"},$("#showadd").modal("show")},showCouponPlanFn:function(t){console.log("2121"),e.view.modal={title:"添加券",html:"couponNew"},$("#showadd").modal("show")},put:function(e,t){console.log("2222"),e.value||(e.value=[]),t={},e.value.push(t)},resetCouponCntFn:function(e,t){console.log("2323"),angular.forEach(e.value,function(e,a){e&&e.id===t.id&&this.splice(a,1)},e.value)},containsCoupon:function(e,t){console.log("2424");for(var a=-1,o=0;e.value&&o<e.value.length;o++)if(e.value[o].id===t){a=o;break}return a}},e.checkout=function(){var t=e.tel.inviters.split(",");angular.forEach(t,function(e,t){if(!/^1[3456789]\d{9}$/.test(e))return alert("手机号码格式有误，请重填"),!1})},e.ruleFn.oldRuleFn(),"FOLLOW"==e.tem.activityCategory?e.view.member=[{id:"FOLLOWING",name:"新关注用户"}]:e.ruleFn.memberFn(),e.tem&&e.tem.activityCategory&&isEmptyObject(e.tem.rules)&&e.ruleFn.stateFn(e.tem.activityCategory,"add",1),e.check_all=function(){e.checkallstr=!e.checkallstr,e.checkallstr?e.coupon.shops=e.tem.shops:e.coupon.shops=[]}}]),app.controller("RuleCouponCtr",["$scope","$http","CouponFactory",function(e,t,a){e.config.breadset=[{name:"活动管理",href:indexUrl+"/admin.html#/rule",class:"coupon"},{name:"券管理"}],e.view={coupons:ajaxSendFn({},"/coupon","GET").result||[],type:{901:"代金券",902:"实物券",9021:"套餐券",904:"礼品券",9011:"抵扣券",903:"通用折扣券",9031:"品类折扣券",9012:"满减券"},state:{4001:"待使用",4002:"已使用",4003:"已过期",4005:"核销中",4006:"未到有效期"}},e.openOrClose=function(){$("#add").modal("show"),e.isOpenOrClose=!0},e.testAddOk=function(){$("#add").modal("hide"),e.isOpenOrClose=!1,alert("添加成功"),e.view.coupons=ajaxSendFn({},"/coupon","GET").result||[]},e.testAddFail=function(e){errorMsg(e)},e.detailFn=function(t){delete e.coupon,e.coupon=ajaxSendFn({},"/coupon/"+t,"GET").result,$("#show").modal("show")},e.editFn=function(t){delete e.coupon,e.coupon=ajaxSendFn({},"/coupon/"+t,"GET").result,$("#edit").modal("show")},e.submitFn=function(t){var a=ajaxSendFn(e.coupon,"/coupon/"+e.coupon.id,"PUT");200==a.code?e.view.coupons=ajaxSendFn({},"/coupon","GET").result||[]:alert(a.message),$("#edit").modal("hide")},e.couponDelFn=function(t){if(!confirm("一旦删除将不可恢复，是否确认删除？"))return!1;var a=ajaxSendFn({},"/coupon/"+e.view.coupons.items[t].id,"DELETE");200==a.code?(e.view.coupons.items.splice(t,1),alert("删除成功")):alert(a.message)},e.couponTurn=function(t,a){var o=ajaxSendFn({},"/coupon/"+e.view.coupons.items[t].id+"/"+a,"POST");200==o.code?(alert("操作成功"),e.view.coupons.items[t].on=!e.view.coupons.items[t].on):alert(o.message)},e.pageChange=function(){var t={page:e.view.coupons.page,count:e.view.coupons.count};e.view.coupons=ajaxSendFn(t,"/coupon","GET").result||[]}}]),app.controller("RuleCardsCtr",["$scope","$http","shopFactory",function(e,t,a,o){e.config.breadset=[{name:"活动管理",href:indexUrl+"/admin.html#/rule",class:"cards"},{name:"储值卡管理"}],e.view={cards:ajaxSendFn({},"/cards","GET").result||[],date:""},e.cards={dateRangeCategory:"PERMANENT",dateRange:{selectCategory:"NONE"}},e.shops=ajaxSendFn({state:"1002"},"/shops","GET").result||[],e.cards.shops=[],e.checkAllShop=!1,e.checkAllShops=function(){e.checkAllShop?(angular.forEach(e.shops,function(e,t){this[t]=e.id},e.cards.shops),console.log(e.cards.shops)):e.cards.shops=[]},e.openOrClose=function(){e.cards={dateRangeCategory:"PERMANENT",dateRange:{selectCategory:"NONE"}},e.cards.shops=[],e.shops=ajaxSendFn({state:"1002"},"/shops","GET").result||[],$("#addCard").modal("show")},e.detailFn=function(t){delete e.cards,e.cards=ajaxSendFn({},"/cards/"+t,"GET").result,$("#show").modal("show")},e.editFn=function(t){delete e.cards,e.cards=ajaxSendFn({},"/cards/"+t,"GET").result,$("#edit").modal("show")},e.editOkFn=function(t){e.cards.code&&delete e.cards.code;var a=ajaxSendFn(e.cards,"/cards/"+t,"PUT");200==a.code?e.view.cards=ajaxSendFn({},"/cards","GET").result||[]:alert(a.message),$("#edit").modal("hide")},e.submitFn=function(t){console.log(e.view.date);for(var a=[],o=0;o<e.cards.shops.length;o++)""!=e.cards.shops[o]&&null!=e.cards.shops[o]&&a.push(e.cards.shops[o]);e.cards.shops=a,console.log(e.cards);var n=ajaxSendFn(e.cards,"/cards","POST");200==n.code?(e.view.cards=ajaxSendFn({},"/cards","GET").result||[],$("#addCard").modal("hide")):alert(n.message)},e.cardsDelFn=function(t){if(!confirm("一旦删除将不可恢复，是否确认删除？"))return!1;var a=ajaxSendFn({},"/cards/"+e.view.cards.items[t].id,"DELETE");200==a.code?(e.view.cards.items.splice(t,1),alert("删除成功")):alert(a.message)},e.cardsTurn=function(t,a){var o=ajaxSendFn({},"/cards/"+e.view.cards.items[t].id+"/"+a,"POST");200==o.code?(alert("操作成功"),e.view.cards.items[t].on=!e.view.cards.items[t].on):alert(o.message)},e.pageChange=function(){var t={page:e.view.cards.page,count:e.view.cards.count};e.view.cards=ajaxSendFn(t,"/cards","GET").result||[]}}]),app.controller("RuleAllocateCtr",["$scope","$http","shopFactory","CouponFactory",function(e,t,a,o){e.config.breadset=[{name:"活动管理",href:indexUrl+"/admin.html#/rule",class:"allocate"},{name:"分账规则"}],e.view={coupons:ajaxSendFn({},"/allocate","GET").result||[],type:{GRATUITY:"打赏",CHARGE:"充值",UPGRADE:"入会"},state:{ONLINE:"线上",OFFLINE:"线下"}},e.posts={shops:[],minAmount:0,maxAmount:0,activities:[],actions:[],name:""},e.set={list:ajaxSendFn({state:1002},"/shops","GET").result,activities:{GRATUITY:"",CHARGE:"",UPGRADE:""},list2:[],action:{ONLINE:"",OFFLINE:""},shopAll:!1,rule:ajaxSendFn({},"/allocate","GET").result||[]},e.openOrClose=function(){$("#add").modal("show"),e.isOpenOrClose=!0},e.$watch("set.shopAll",function(t,a){t!==a&&(t?angular.forEach(e.set.list,function(e,t){this[t]=e.id},e.posts.shops):e.posts.shops=[])}),e.submitFn1=function(){angular.forEach(e.set.activities,function(t,a){t&&e.posts.activities.push(a)}),angular.forEach(e.set.action,function(t,a){t&&e.posts.actions.push(a)});var t=[];angular.forEach(e.posts.shops,function(e,a){0==e||null==e||void 0==e||t.push(e)});var a=e.posts;if(a.shops=t,a.activities.length<1)return void alert("至少选择一个活动类型!");a.minAmount||(a.minAmount=0),a.maxAmount||(a.maxAmount=0);var o=ajaxSendFn(a,"/allocate","POST");200==o.code&&($("#add").modal("hide"),e.isOpenOrClose=!1,alert("添加成功"),location.reload())},e.couponDelFn=function(t){if(!confirm("一旦删除将不可恢复，是否确认删除？"))return!1;var a=ajaxSendFn({},"/allocate/"+t,"DELETE");200==a.code?(e.view.coupons=ajaxSendFn({},"/allocate","GET").result||[],alert("删除成功")):alert(a.message)},e.pageChange=function(){var t={page:e.view.coupons.page,count:e.view.coupons.count};e.view.coupons=ajaxSendFn(t,"/coupon","GET").result||[]}}]),app.controller("RuleRewardCtr",["$scope","$http","CouponFactory",function(e,t,a){e.config.breadset=[{name:"活动管理",href:indexUrl+"/admin.html#/rule",class:"reward"},{name:"代用币管理"}],e.view={reward:ajaxSendFn({},"/reward","GET").result||[]},e.post={},e.openOrClose=function(){$("#add").modal("show"),e.isOpenOrClose=!0},e.testAddOk=function(){$("#add").modal("hide"),e.isOpenOrClose=!1,alert("添加成功"),e.view.reward=ajaxSendFn({},"/reward","GET").result||[]},e.couponDelFn=function(t){if(!confirm("一旦删除将不可恢复，是否确认删除？"))return!1;var a=ajaxSendFn({},"/reward/"+e.view.reward.items[t].id,"DELETE");200==a.code?(e.view.reward.items.splice(t,1),alert("删除成功")):alert(a.message)},e.couponTurn=function(t,a){var o=ajaxSendFn({},"/reward/"+e.view.reward.items[t].id+"/"+a,"POST");200==o.code?(alert("操作成功"),e.view.reward.items[t].on=!e.view.reward.items[t].on):alert(o.message)},e.pageChange=function(){var t={page:e.view.reward.page,count:e.view.reward.count};e.view.reward=ajaxSendFn(t,"/reward","GET").result||[]},e.submitFn=function(){var t=ajaxSendFn(e.post,"/reward","POST");200==t.code?e.testAddOk():errorMsg(t)}}]),app.controller("RuleBargainCtr",["$scope","$http","$filter",function(e,t,a){e.config.breadset=[{name:"买单砍价",href:indexUrl+"/admin.html#/rule/bargain",class:"bargain"},{name:"买单砍价"}],e.set={times:ajaxSendFn({},"/businesstimes/all","GET").result,timeType:{1001:"早市",1002:"午市",1003:"下午茶",1004:"晚市",1005:"宵夜"},periods:[]},e.set.time=getSubtimes(e.set.times,e.set.timeType),e.init=function(){var t=e.view;e.view.data={},e.view.data.dateType=t.dateRangeCategory,"AROUND_FIX_DATE"!==t.dateRangeCategory&&"MONTH_EFFECTIVE"!==t.dateRangeCategory||(e.view.data.dateType="AROUND_FIX_DATE",e.view.data.subType=t.dateRangeCategory),e.view.data[e.view.data.dateType]={dateRange:t.dateRange},e.view.dateRange=e.view.data[e.view.data.dateType].dateRange,t.dateRange&&(t.dateRange.selectDates?(e.view.dateRange.subType="MANUAL_SELECT",e.view.dateRange.selectDates=arrayMap(e.view.dateRange.selectDates,function(e){return e.split(/\s+/)[0]})):t.dateRange.selectDays?e.view.dateRange.subType="MONTH_DAYS":e.view.dateRange.subType="WEEKLY_DAY")},e.operate=function(t){return t?void e.view.rule.detail.ALL.splice(t,1):void e.view.rule.detail.ALL.push({})},e.settime=function(t,a){e.view.periods[t]=e.view.periods[t]?null:a},e.sendJsons=function(){var t={dateRange:{}};if(e.posts.allDay?t.allDay=!0:t.periods=arrRemoveNullFN(angular.copy(e.view.periods)),t.rule=angular.copy(e.view.rule),t.dateRangeCategory=e.view.data.dateType,t.on=e.view.on,!e.view.data.dateType)return void alert("还未选择有效期！");if("BIRTHDAY"===e.view.data.dateType&&e.view.data.subType&&(t.dateRangeCategory=e.view.data.subType),"CONTINUOUS"===e.view.data.dateType){if(!e.view.dateRange.startDate||!e.view.dateRange.endDate)return void alert("请填写开始和结束日期!");if(e.view.dateRange.endDate<e.view.dateRange.startDate)return void alert("结束日期不能小于开始日期!");t.dateRange.startDate=a("date")(e.view.dateRange.startDate,"yyyy-MM-dd 00:00:00"),
t.dateRange.endDate=a("date")(e.view.dateRange.endDate,"yyyy-MM-dd 23:59:59")}else"BIRTHDAY"===e.view.data.dateType&&"AROUND_FIX_DATE"===e.view.data.subType&&(t.dateRange.beforeDays=e.view.dateRange.beforeDays||0,t.dateRange.afterDays=e.view.dateRange.afterDays||0);if(t.dateRange.selectCategory=e.view.dateRange.selectCategory||"NONE","MANUAL_SELECT"===e.view.dateRange.subType){var o=arrayMap(objectKeys(e.view.dateRange.selectDates),function(e){return e+" 00:00:00"});isEmptyObject(o)?delete t.dateRange.selectDates:t.dateRange.selectDates=o}else if("MONTH_DAYS"===e.view.dateRange.subType){var o=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectDays,notNull)),parseInt);isEmptyObject(o)?delete t.dateRange.selectDays:t.dateRange.selectDays=o}else if("WEEKLY_DAY"===e.view.dateRange.subType){var o=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectWeekDays,notNull)),parseInt);isEmptyObject(o)?delete t.dateRange.selectWeekDays:t.dateRange.selectWeekDays=o}if("SELECTED_DATES"!==t.dateRangeCategory&&"EXCLUDE"===t.dateRange.selectCategory&&1==objectCount(t.dateRange))return void alert("没有指定排除日期！");if("SELECTED_DATES"===t.dateRangeCategory&&1==objectCount(t.dateRange))return void alert("没有指定日期！");for(var n=0;n<t.rule.detail.ALL.length;n++)delete t.rule.detail.ALL[n].$$hashKey;var s=ajaxSendFn(t,"/activity/bargain","POST");200==s.code?alert("保存成功"):alert(s.message)};var o=ajaxSendFn({},"/activity/bargain","GET");200==o.code?(e.view=o.result,e.set.periods=angular.copy(e.view.periods),e.view.periods=[],e.view.allDay?(e.view.periods=[],e.posts={allDay:!0}):angular.forEach(e.set.time,function(t,a){e.set.periods&&e.set.periods.indexOf(a)!=-1?this.push(a):this.push(null)},e.view.periods),e.init()):(e.view={data:{},rule:{detail:{ALL:[]}},periods:[]},e.operate())}]),app.controller("RuleGrouponAddCtr",["$scope","$http","$routeParams","$filter","$location",function(e,t,a,o,n){e.config.breadset=[{name:"在线砍价",href:indexUrl+"/admin.html#/rule/groupon",class:"groupon"},{name:"在线砍价"}],a.id?(e.post=ajaxSendFn({},"/activity/groupon/"+a.id,"GET").result||[],e.post.startTime=new Date(e.post.startTime),e.post.endTime=new Date(e.post.endTime),e.post.buyMinimum===!1&&(e.post.buyMinimum="false")):e.post={buyMinimum:!0,selfBuy:!0,rule:{value:[{count:1}]},startTime:new Date,picUrls:[{}]},e.view={coupons:ajaxSendFn({},"/coupon/usable","GET").result,initTime:o("date")(new Date,"yyyy-MM-dd")+"T00:00"},e.addFn=function(){e.post.rule.value.push({count:1})},e.removeFn=function(t){e.post.rule.value.splice(t,1)},e.changeCoupon=function(t){if(t.id)for(var a=0;a<e.view.coupons.length;a++)if(e.view.coupons[a].id===t.id){t.name=e.view.coupons[a].name,t.category="COUPON";break}},e.sendJsons=function(){if(!e.post.picUrl)return void alert("请先上传图片");var t=angular.copy(e.post),s=t.startTime;if(s.setDate(s.getDate()+30)<t.endTime)return void alert("时间期限不超过三十天");e.view.check||delete t.rule.min,t.startTime=o("date")(e.post.startTime.setSeconds(0),"yyyy-MM-dd HH:mm:ss"),t.endTime=o("date")(e.post.endTime.setSeconds(0),"yyyy-MM-dd HH:mm:ss"),t.advertisement&&!t.advertisement.id&&delete t.advertisement;var r="/activity/groupon";a.id&&(r+="/"+a.id);var i=ajaxSendFn(t,r,"POST");200==i.code?(alert("操作成功"),n.path("/rule/groupon")):alert(i.message)}}]),app.controller("RuleGrouponCtr",["$scope","$http","$filter","$document","$compile","$rootScope",function(e,t,a,o,n,s){e.config.breadset=[{name:"在线砍价",href:indexUrl+"/admin.html#/rule/groupon",class:"groupon"},{name:"在线砍价"}],e.view={list:ajaxSendFn({},"/activity/groupon","GET").result||[]},e.stopFn=function(t){var a=confirm("确认停止此活动？");if(a){var o=ajaxSendFn({},"/activity/groupon/"+t+"/stop","POST");200==o.code?e.view.list=ajaxSendFn({},"/activity/groupon","GET").result||[]:alert(o.message)}},e.removeFn=function(t){var a=confirm("确认删除？");if(a){var o=ajaxSendFn({},"/activity/groupon/"+t,"DELETE");200==o.code?e.view.list=ajaxSendFn({},"/activity/groupon","GET").result||[]:alert(o.message)}},e.copyFn=function(e){var t=angular.element('<span id="ngClipboardCopyId">'+e+"</span>"),a=o.find("body").eq(0);a.append(n(t)(s));var r=angular.element(document.getElementById("ngClipboardCopyId"));console.log(r);var i=document.createRange();i.selectNode(r[0]),window.getSelection().removeAllRanges(),window.getSelection().addRange(i);var l=document.execCommand("copy"),d=l?"成功":"失败";alert("复制"+d),window.getSelection().removeAllRanges(),t.remove()}}]),app.controller("RuleCommentAddCtr",["$scope","$http","$routeParams","$filter","$location",function(e,t,a,o,n){if(e.config.breadset=[{name:"评赏管理",href:indexUrl+"/admin.html#/rule/comment",class:"comment"},{name:"评赏管理"}],a.id){if(e.post=ajaxSendFn({},"/activity/praise/"+a.id,"GET").result||[],e.post.startTime=new Date(e.post.startTime),e.post.endTime=new Date(e.post.endTime),e.post.rule)for(var s=0;s<e.post.rule.length;s++)e.post.rule[s].limit&&(e.post.rule[s].limit="1"),e.post.rule[s].participants||(e.post.rule[s].participants=[{}]),e.post.rule[s].value||(e.post.rule[s].value=[{}]);else e.post.rule=[{participants:[{}],value:[{}]}];e.post.redEnvelopes?e.post.redEnvelopes.limit&&(e.post.redEnvelopes.limit="1"):e.post.redEnvelopes={value:[{}]},e.post.prize||(e.post.prize={prizes:[{value:[{}]}]})}else e.post={rule:[{participants:[{}],value:[{}]}],prize:{prizes:[{value:[{}]}]},redEnvelopes:{value:[{}]},shareDays:1};e.view={coupons:ajaxSendFn({},"/coupon/usable","GET").result||[],rewards:ajaxSendFn({},"/reward/usable","GET").result||[],initTime:o("date")(new Date,"yyyy-MM-dd"),category:[],adsCategory:[{id:"COUPONFREE",name:"免费领券"},{id:"LOTTERY",name:"抽奖"}]},e.view.coupons.length&&e.view.category.push({id:"COUPON",name:"优惠券"}),e.view.rewards.length&&e.view.category.push({id:"REWARD",name:"代用币"}),e.addFn=function(t){return t?void e.post.prize.prizes.push({value:[{}]}):void e.post.rule.push({participants:[{}],value:[{}]})},e.removeFn=function(t,a){return a?void e.post.prize.prizes.splice(t,1):void e.post.rule.splice(t,1)},e.addImgFn=function(){e.post.picUrls.push({})},e.removeImgFn=function(t){e.post.picUrls.splice(t,1)},e.addCouponFn=function(e){e.push({})},e.removeCouponFn=function(e,t){e.splice(t,1)},e.changeCoupon=function(t){if(t.id)for(var a=0;a<e.view.coupons.length;a++)if(e.view.coupons[a].id===t.id){t.name=e.view.coupons[a].name,t.category="COUPON",t.count=1;break}},e.changeReward=function(t){if(t.id)for(var a=0;a<e.view.rewards.length;a++)if(e.view.rewards[a].id===t.id){t.name=e.view.rewards[a].name,t.category="REWARD",t.count=1;break}},e.sendJsons=function(){if(!e.post.picUrl)return void alert("请先上传图片");var t=angular.copy(e.post);if('[{"participants":[{}],"value":[{}]}]'==JSON.stringify(t.rule)&&'[{"value":[{}]}]'==JSON.stringify(t.prizes)&&'{"value":[{}]}'==JSON.stringify(t.redEnvelopes))return void alert("请先选择赠送的奖励");if('[{"participants":[{}],"value":[{}]}]'==JSON.stringify(t.rule))delete t.rule;else for(var s=0;s<e.post.rule.length;s++)e.post.rule[s].participants[0].count||delete t.rule[s].participants,e.post.rule[s].value[0].count||delete t.rule[s].value;'[{"value":[{}]}]'==JSON.stringify(t.prize.prizes)&&delete t.prize,e.post.all&&'{"value":[{}]}'!=JSON.stringify(t.redEnvelopes)||delete t.redEnvelopes,t.startTime&&(t.startTime=o("date")(e.post.startTime,"yyyy-MM-dd")+" 00:00:00"),t.endTime&&(t.endTime=o("date")(e.post.endTime,"yyyy-MM-dd")+" 00:00:00"),t.prize;var r="/activity/praise";a.id&&(r+="/"+a.id);var i=ajaxSendFn(t,r,"POST");200==i.code?(alert("操作成功"),n.path("/rule/comment")):alert(i.message)}}]),app.controller("RuleCommentCtr",["$scope","$http","$filter","$document","$compile","$rootScope",function(e,t,a,o,n,s){e.config.breadset=[{name:"评赏管理",href:indexUrl+"/admin.html#/rule/comment",class:"comment"},{name:"评赏管理"}],e.view={list:ajaxSendFn({},"/activity/praise","GET").result||[]},e.stopFn=function(t){var a=confirm("确认停止此活动？");if(a){var o=ajaxSendFn({},"/activity/praise/"+t+"/stop","POST");200==o.code?e.view.list=ajaxSendFn({},"/activity/praise","GET").result||[]:alert(o.message)}},e.removeFn=function(t){var a=confirm("确认删除？");if(a){var o=ajaxSendFn({},"/activity/praise/"+t,"DELETE");200==o.code?e.view.list=ajaxSendFn({},"/activity/praise","GET").result||[]:alert(o.message)}},e.copyFn=function(e){var t=angular.element('<span id="ngClipboardCopyId">'+e+"</span>"),a=o.find("body").eq(0);a.append(n(t)(s));var r=angular.element(document.getElementById("ngClipboardCopyId")),i=document.createRange();i.selectNode(r[0]),window.getSelection().removeAllRanges(),window.getSelection().addRange(i);var l=document.execCommand("copy"),d=l?"成功":"失败";alert("复制"+d),window.getSelection().removeAllRanges(),t.remove()}}]),app.controller("RuleLotteryAddCtr",["$scope","$http","$routeParams","$filter","$location",function(e,t,a,o,n){e.config.breadset=[{name:"抽奖管理",href:indexUrl+"/admin.html#/rule/lottery",class:"lottery"},{name:"抽奖管理"}],e.view={coupons:ajaxSendFn({},"/coupon/usable","GET").result||[],rewards:ajaxSendFn({},"/reward/usable","GET").result||[],category:[],date:{},dateRange:{},type:[{id:"LIMIT",name:"满人抽奖",text:"* 购买人数达活动要求后，即刻开奖"}]},a.id?(e.post=ajaxSendFn({},"/activity/lottery/"+a.id,"GET").result||[],e.post.tags||(e.post.tags=[]),e.view.date.dateType=e.post.dateRangeCategory,"AROUND_FIX_DATE"!==e.post.dateRangeCategory&&"MONTH_EFFECTIVE"!==e.post.dateRangeCategory||(e.view.date.dateType="AROUND_FIX_DATE",e.view.date.subType=e.post.dateRangeCategory),e.view.date[e.view.date.dateType]={dateRange:e.post.dateRange},e.view.dateRange=e.view.date[e.view.date.dateType].dateRange,e.post.dateRange&&(e.post.dateRange.selectDates?(e.view.dateRange.subType="MANUAL_SELECT",e.view.dateRange.selectDates=arrayMap(e.view.dateRange.selectDates,function(e){return e.split(/\s+/)[0]})):e.post.dateRange.selectDays?e.view.dateRange.subType="MONTH_DAYS":e.post.dateRange.selectWeeks&&(e.view.dateRange.subType="WEEKLY_DAY"))):e.post={lotteryCategory:"LIMIT",followLimit:!0,tags:[],rule:{detail:{ALL:[{value:[{}],participants:[{}]}]}},prize:{prizes:[{sequence:1,value:[{}]}]}},e.view.coupons.length&&e.view.category.push({id:"COUPON",name:"优惠券"}),e.view.rewards.length&&e.view.category.push({id:"REWARD",name:"代用币"}),e.addFn=function(){e.post.prize.prizes.push({sequence:e.post.prize.prizes.length+1,value:[{}]})},e.removeFn=function(t){e.post.prize.prizes.splice(t,1)},e.tagSend=function(){e.view.text.length<6&&e.view.text.length>2?(e.post.tags.push(e.view.text),e.view.text="",e.view.error=""):e.view.error="三到五个字符之间"},e.addCouponFn=function(e){e.push({})},e.removeCouponFn=function(e,t){e.splice(t,1)},e.changeCoupon=function(t){if(t.id)for(var a=0;a<e.view.coupons.length;a++)if(e.view.coupons[a].id===t.id){t.name=e.view.coupons[a].name,t.category="COUPON",t.count=1;break}},e.changeReward=function(t){if(t.id)for(var a=0;a<e.view.rewards.length;a++)if(e.view.rewards[a].id===t.id){t.name=e.view.rewards[a].name,t.category="REWARD",t.count=1;break}},e.sendJsons=function(){if(!e.post.picUrl)return void alert("请先上传图片");var t=angular.copy(e.post);if(t.dateRange={},t.dateRangeCategory=e.view.date.dateType,"CONTINUOUS"===e.view.date.dateType){if(!e.view.dateRange.startDate||!e.view.dateRange.endDate)return void alert("请填写开始和结束日期!");if(e.view.dateRange.endDate<e.view.dateRange.startDate)return void alert("结束日期不能小于开始日期!");t.dateRange.startDate=o("date")(e.view.dateRange.startDate,"yyyy-MM-dd 00:00:00"),t.dateRange.endDate=o("date")(e.view.dateRange.endDate,"yyyy-MM-dd 23:59:59")}else"BIRTHDAY"===e.view.date.dateType&&"AROUND_FIX_DATE"===e.view.date.subType&&(t.dateRange.beforeDays=e.view.dateRange.beforeDays||0,t.dateRange.afterDays=e.view.dateRange.afterDays||0);if(t.dateRange.selectCategory=e.view.dateRange.selectCategory||"NONE","MANUAL_SELECT"===e.view.dateRange.subType){var s=arrayMap(objectKeys(e.view.dateRange.selectDates),function(e){return e+" 00:00:00"});isEmptyObject(s)||(t.dateRange.selectDates=s)}else if("MONTH_DAYS"===e.view.dateRange.subType){var s=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectDays,notNull)),parseInt);isEmptyObject(s)||(t.dateRange.selectDays=s)}else if("WEEKLY_DAY"===e.view.dateRange.subType){var s=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectWeekDays,notNull)),parseInt);isEmptyObject(s)||(t.dateRange.selectWeekDays=s)}if("SELECTED_DATES"!==t.dateRangeCategory&&"EXCLUDE"===t.dateRange.selectCategory&&1==objectCount(t.dateRange))return void alert("没有指定排除日期！");if("SELECTED_DATES"===t.dateRangeCategory&&1==objectCount(t.dateRange))return void alert("没有指定日期！");if('[{ "sequence": 1,"value":[{}]}]'==JSON.stringify(t.prize.prizes))return void alert("请先选择赠送的奖励");t.advertisement&&!t.advertisement.id&&delete t.advertisement;var r="/activity/lottery";a.id&&(r+="/"+a.id);var i=ajaxSendFn(t,r,"POST");200==i.code?(alert("操作成功"),n.path("/rule/lottery")):alert(i.message)}}]),app.controller("RuleLotteryCtr",["$scope","$http","$filter","$document","$compile","$rootScope",function(e,t,a,o,n,s){e.config.breadset=[{name:"抽奖管理",href:indexUrl+"/admin.html#/rule/lottery",class:"lottery"},{name:"抽奖管理"}],e.view={list:ajaxSendFn({},"/activity/lottery","GET").result||[]},e.stateFn=function(t,a){var o=confirm("确认停止此活动？");if(o){var n=ajaxSendFn({},"/activity/lottery/"+t+"/"+a,"POST");200==n.code?e.view.list=ajaxSendFn({},"/activity/lottery","GET").result||[]:alert(n.message)}},e.removeFn=function(t){var a=confirm("确认删除？");if(a){var o=ajaxSendFn({},"/activity/lottery/"+t,"DELETE");200==o.code?e.view.list=ajaxSendFn({},"/activity/lottery","GET").result||[]:alert(o.message)}},e.copyFn=function(e){var t=angular.element('<span id="ngClipboardCopyId">'+e+"</span>"),a=o.find("body").eq(0);a.append(n(t)(s));var r=angular.element(document.getElementById("ngClipboardCopyId")),i=document.createRange();i.selectNode(r[0]),window.getSelection().removeAllRanges(),window.getSelection().addRange(i);var l=document.execCommand("copy"),d=l?"成功":"失败";alert("复制"+d),window.getSelection().removeAllRanges(),t.remove()}}]),app.controller("RuleGratuityAddCtr",["$scope","$http","$routeParams","$filter","$location",function(e,t,a,o,n){if(e.config.breadset=[{name:"打赏管理",href:indexUrl+"/admin.html#/rule/gratuity",class:"gratuity"},{name:"打赏管理"}],e.view={gratuities:ajaxSendFn({},"/activity/gratuity/gratuities","GET").result,shops:ajaxSendFn({state:1002},"/shops","GET").result,factor:ajaxSendFn({},"/activity/factor","GET").result,allocate:ajaxSendFn({},"/activity/allocate/8002","GET").result||[],category:[],date:{},dateRange:{}},e.view.factor||(alert("没有可用的券"),e.view.factor={}),e.view.factor.MEMBERGRADE||(e.view.factor.MEMBERGRADE=[]),e.view.factor.MEMBERGRADE.push({id:"MEMBER",name:"任一会员"}),e.view.factor.MEMBERGRADE.push({id:"ALL",name:"全员"}),a.id){e.post=ajaxSendFn({},"/activity/gratuity/"+a.id,"GET").result||[];Object.keys(e.post.rule.detail);e.view.date.dateType=e.post.dateRangeCategory,"AROUND_FIX_DATE"!==e.post.dateRangeCategory&&"MONTH_EFFECTIVE"!==e.post.dateRangeCategory||(e.view.date.dateType="AROUND_FIX_DATE",e.view.date.subType=e.post.dateRangeCategory),e.view.date[e.view.date.dateType]={dateRange:e.post.dateRange},e.view.dateRange=e.view.date[e.view.date.dateType].dateRange,e.post.dateRange&&(e.post.dateRange.selectDates?(e.view.dateRange.subType="MANUAL_SELECT",e.view.dateRange.selectDates=arrayMap(e.view.dateRange.selectDates,function(e){return e.split(/\s+/)[0]})):e.post.dateRange.selectDays?e.view.dateRange.subType="MONTH_DAYS":e.post.dateRange.selectWeeks&&(e.view.dateRange.subType="WEEKLY_DAY"));var s=[];if(e.post.rule.detail){for(var r in e.post.rule.detail){var i={};i.id=r,i.value=e.post.rule.detail[r][0],i.value.allocates||(i.value.allocates=[{}]),s.push(i)}e.post.rule.detail=s}else e.post.rule={detail:[{id:"ALL",value:{participants:[{}],value:[{}],allocates:[{}]}}]};var l=[];for(var r in e.view.shops)e.post.shops.includes(e.view.shops[r].id)?l.push(e.view.shops[r].id):l.push(null);e.post.shops=l}else e.post={rule:{detail:[{id:"ALL",value:{participants:[{}],value:[{}],allocates:[{}]}}]},shops:[]};e.$watch("view.shopAll",function(t,a){t!==a&&(t?angular.forEach(e.view.shops,function(e,t){this[t]=e.id},e.post.shops):e.post.shops=[])}),e.view.factor.COUPON&&e.view.category.push({id:"COUPON",name:"优惠券"}),e.view.factor.REWARD&&e.view.category.push({id:"REWARD",name:"代用币"}),e.addFn=function(){e.post.rule.detail.push({id:"",value:{participants:[{}],value:[{}]}})},e.removeFn=function(t){e.post.rule.detail.splice(t,1)},e.addCouponFn=function(e){e.push({})},e.removeCouponFn=function(e,t){e.splice(t,1)},e.changeCoupon=function(t){if(t.id)for(var a=0;a<e.view.factor.COUPON.length;a++)if(e.view.factor.COUPON[a].id===t.id){t.name=e.view.factor.COUPON[a].name,t.category="COUPON",t.count=1;break}},e.changeReward=function(t){if(t.id)for(var a=0;a<e.view.factor.REWARD.length;a++)if(e.view.factor.REWARD[a].id===t.id){t.name=e.view.factor.REWARD[a].name,t.category="REWARD",t.count=1;break}},e.sendJsons=function(){var t=angular.copy(e.post);if(t.dateRange={},t.dateRangeCategory=e.view.date.dateType,"CONTINUOUS"===e.view.date.dateType){if(!e.view.dateRange.startDate||!e.view.dateRange.endDate)return void alert("请填写开始和结束日期!");if(e.view.dateRange.endDate<e.view.dateRange.startDate)return void alert("结束日期不能小于开始日期!");t.dateRange.startDate=o("date")(e.view.dateRange.startDate,"yyyy-MM-dd 00:00:00"),t.dateRange.endDate=o("date")(e.view.dateRange.endDate,"yyyy-MM-dd 23:59:59")}else"BIRTHDAY"===e.view.date.dateType&&"AROUND_FIX_DATE"===e.view.date.subType&&(t.dateRange.beforeDays=e.view.dateRange.beforeDays||0,t.dateRange.afterDays=e.view.dateRange.afterDays||0);if(t.dateRange.selectCategory=e.view.dateRange.selectCategory||"NONE","MANUAL_SELECT"===e.view.dateRange.subType){var s=arrayMap(objectKeys(e.view.dateRange.selectDates),function(e){return e+" 00:00:00"});isEmptyObject(s)||(t.dateRange.selectDates=s)}else if("MONTH_DAYS"===e.view.dateRange.subType){var s=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectDays,notNull)),parseInt);isEmptyObject(s)||(t.dateRange.selectDays=s)}else if("WEEKLY_DAY"===e.view.dateRange.subType){var s=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectWeekDays,notNull)),parseInt);isEmptyObject(s)||(t.dateRange.selectWeekDays=s)}if("SELECTED_DATES"!==t.dateRangeCategory&&"EXCLUDE"===t.dateRange.selectCategory&&1==objectCount(t.dateRange))return void alert("没有指定排除日期！");if("SELECTED_DATES"===t.dateRangeCategory&&1==objectCount(t.dateRange))return void alert("没有指定日期！");var r={};console.log(t.rule.detail);for(var i in t.rule.detail)r[t.rule.detail[i].id]=[t.rule.detail[i].value];t.rule.detail=r,t.shops=arrRemoveNullFN(e.post.shops);var l="/activity/gratuity";a.id&&(l+="/"+a.id);var d=ajaxSendFn(t,l,"POST");200==d.code?(alert("操作成功"),n.path("/rule/gratuity")):alert(d.message)}}]),app.controller("RuleGratuityCtr",["$scope","$http","$filter","$document","$compile","$rootScope",function(e,t,a,o,n,s){e.config.breadset=[{name:"打赏管理",href:indexUrl+"/admin.html#/rule/gratuity",class:"gratuity"},{name:"打赏管理"}],e.view={list:ajaxSendFn({},"/activity/gratuity","GET").result||{}},e.stateFn=function(t,a){var o=confirm("确认"+("on"==a?"上线":"下线")+"此活动？");if(o){var n=ajaxSendFn({},"/activity/gratuity/"+t+"/"+a,"POST");200==n.code?e.view.list=ajaxSendFn({},"/activity/gratuity","GET").result||[]:alert(n.message)}},e.removeFn=function(t){var a=confirm("确认删除？");if(a){var o=ajaxSendFn({},"/activity/gratuity/"+t,"DELETE");200==o.code?e.view.list=ajaxSendFn({},"/activity/gratuity","GET").result||[]:alert(o.message)}},e.copyFn=function(e){var t=angular.element('<span id="ngClipboardCopyId">'+e+"</span>"),a=o.find("body").eq(0);a.append(n(t)(s));var r=angular.element(document.getElementById("ngClipboardCopyId")),i=document.createRange();i.selectNode(r[0]),window.getSelection().removeAllRanges(),window.getSelection().addRange(i);var l=document.execCommand("copy"),d=l?"成功":"失败";alert("复制"+d),window.getSelection().removeAllRanges(),t.remove()},e.pageChange=function(){var t={page:e.view.list.page,count:e.view.list.count};e.view.list=ajaxSendFn(t,"/activity/gratuity","GET").result||{}}}]),app.controller("RuleAdsCtr",["$scope","$http","$filter","$document","$compile","$rootScope",function(e,t,a,o,n,s){e.config.breadset=[{name:"广告管理",href:indexUrl+"/admin.html#/rule/ads",class:"ads"},{name:"广告管理"}],e.view={list:ajaxSendFn({},"/placards","GET").result||[],type:ConsumeTypeCategory},e.pageChange=function(){var t={page:e.view.list.page,count:e.view.list.count};e.view.list=ajaxSendFn(t,"/placards","GET").result||[]},e.remove=function(t){if(!confirm("一旦删除将不可恢复，是否确认删除？"))return!1;var a=ajaxSendFn({},"/placards/"+e.view.list.items[t].id,"DELETE");200==a.code?e.view.list.items.splice(t,1):alert(a.message)}}]),app.controller("RuleAdsAddCtr",["$scope","$http","$routeParams","$filter","$location",function(e,t,a,o,n){e.config.breadset=[{name:"广告管理",href:indexUrl+"/admin.html#/rule/ads",class:"ads"},{name:"广告管理"}],e.view={type:{6004:"送券",6015:"套餐",6006:"特价",6012:"抵扣",6014:"满减",6005:"打折",6041:"砍价",6007:"消费返券",6002:"充值",6001:"入会及升级",6003:"积分兑换",6050:"评赏",6051:"抽奖"}},a.id&&(e.post=ajaxSendFn({},"/placards/"+a.id,"GET").result,e.view.rules=ajaxSendFn({},"/placards/activity/category/"+e.post.activityCategory,"GET").result||[],e.post.activityId?(e.view.rules=ajaxSendFn({},"/placards/activity/category/"+e.post.activityCategory,"GET").result||[],e.view.check="false"):e.view.check="true"),e.changeFn=function(t){e.view.rules=ajaxSendFn({},"/placards/activity/category/"+t,"GET").result||[]},e.sendJsons=function(){var t=angular.copy(e.post);return"200"==t.type&&(delete t.activityId,delete t.activityCategory),t.transversePicUrl?"100"!=t.type||t.activityCategory&&t.activityId?(delete t.$$hashKey,a.id?postsend=ajaxSendFn(t,"/placards/"+e.post.id,"PUT",1):postsend=ajaxSendFn(t,"/placards","POST",1),void(200==postsend.code?(alert("保存成功"),n.path("/rule/ads")):alert(postsend.message))):void alert("请先选择活动"):void alert("请先选择图片")}}]),app.controller("RuleGratuitiesCtr",["$scope","$http","$filter","$document","$compile","$rootScope",function(e,t,a,o,n,s){e.config.breadset=[{name:"打赏管理",href:indexUrl+"/admin.html#/rule/gratuities",class:"gratuities"},{name:"打赏管理"}],e.view={list:ajaxSendFn({},"/gratuities","GET").result||{}},e.post={},e.pageChange=function(){var t={page:e.view.list.page,count:e.view.list.count};e.view.list=ajaxSendFn(t,"/gratuities","GET").result||[]},e.remove=function(t){if(!confirm("一旦删除将不可恢复，是否确认删除？"))return!1;var a=ajaxSendFn({},"/gratuities/gratuity/"+e.view.list.items[t].id,"DELETE");200==a.code?e.view.list.items.splice(t,1):alert(a.message)},e.openFn=function(t){"number"==typeof t?e.post=e.view.list.items[t]:e.post={},$("#gratuities").modal("show")},e.sendJsons=function(){var t=angular.copy(e.post);return t.ico?(delete t.$$hashKey,e.post.id?postsend=ajaxSendFn(t,"/gratuities/gratuity/"+e.post.id,"PUT",1):postsend=ajaxSendFn(t,"/gratuities","POST",1),void(200==postsend.code?($("#gratuities").modal("hide"),e.view.list=ajaxSendFn({page:e.view.list.page,count:e.view.list.count},"/gratuities","GET").result||[]):alert(postsend.message))):void alert("请先选择图片")}}]),app.controller("RuleTagsCtr",["$scope","$http","$filter","$document","$compile","$rootScope",function(e,t,a,o,n,s){e.config.breadset=[{name:"评价标签管理",href:indexUrl+"/admin.html#/rule/tags",class:"tags"},{name:"打赏管理"}],e.view={list:ajaxSendFn({},"/comments/tag/902","GET").result||{}},e.view.list.items&&(e.view.list.items=a("orderBy")(e.view.list.items,"-score")),e.post={},e.pageChange=function(){var t={page:e.view.list.page,count:e.view.list.count};e.view.list=ajaxSendFn(t,"/comments/tag/902","GET").result||[]},e.remove=function(t){if(!confirm("一旦删除将不可恢复，是否确认删除？"))return!1;var a=ajaxSendFn({},"/comments/tag/"+e.view.list.items[t].id,"DELETE");200==a.code?e.view.list.items.splice(t,1):alert(a.message)},e.openFn=function(t){"number"==typeof t?e.post=e.view.list.items[t]:e.post={},$("#tags").modal("show")},e.sendJsons=function(){var t=angular.copy(e.post);e.post.id?postsend=ajaxSendFn(t,"/comments/tag/"+e.post.id,"PUT",1):postsend=ajaxSendFn(t,"/comments/tag/902","POST",1),200==postsend.code?($("#tags").modal("hide"),e.view.list=ajaxSendFn({},"/comments/tag/902","GET").result||[]):alert(postsend.message)}}]),app.controller("tasksCtr",["$scope","$http","$filter","$document","$compile","$rootScope",function(e,t,a,o,n,s){e.config.breadset=[{name:"任务管理",href:indexUrl+"/admin.html#/rule/tasks",class:"tasks"},{name:"任务管理"}],e.shops=ajaxSendFn({state:"1002"},"/shops","GET").result||[],e.view={list:ajaxSendFn({},"/tasks","GET").result||{},coupons:""},e.coupons=ajaxSendFn({},"/coupon/usable","GET").result||{};for(var r=0;r<e.shops.length;r++)for(var i=0;i<e.view.list.length;i++)e.view.list[i].shopId==e.shops[r].id&&(e.view.list[i].shopName=e.shops[r].name);e.view.list.items&&(e.view.list.items=a("orderBy")(e.view.list.items,"-score")),e.post={},e.pageChange=function(){var t={page:e.view.list.page,count:e.view.list.count};e.view.list=ajaxSendFn(t,"/comments/tag/902","GET").result||[]},e.remove=function(t){if(!confirm("一旦删除将不可恢复，是否确认删除？"))return!1;var a=ajaxSendFn({},"/tasks/"+e.view.list.items[t].id,"DELETE");200==a.code?e.view.list.items.splice(t,1):alert(a.message)},e.tasksTurn=function(t,a){var o=ajaxSendFn({},"/tasks/"+e.view.list.items[t].id+"/"+a,"POST");200==o.code?(alert("操作成功"),e.view.list.items[t].on=!e.view.list.items[t].on):alert(o.message)},e.openFn=function(e){$("#addtasks").modal("show")},e.editFn=function(t){e.post=t,console.log(e.post);for(var a=0;a<e.coupons.length;a++)e.coupons[a].id==e.post.redEnvelope.benefits[0].id&&(e.view.coupons=e.coupons[a],console.log(e.coupons[a]));console.log(e.coupons),$("#edittasks").modal("show")},e.detailFn=function(t){e.post=t,console.log(e.post);for(var a=0;a<e.coupons.length;a++)e.coupons[a].id==e.post.redEnvelope.benefits[0].id&&(e.view.coupons=e.coupons[a],console.log(e.coupons[a]));console.log(e.coupons),$("#detailtasks").modal("show")},e.sendJsons=function(t){delete e.view.coupons.alias,delete e.view.coupons.code,e.view.coupons.category="COUPON",e.view.coupons.count=1,e.post.redEnvelope={benefits:[e.view.coupons]};var a=angular.copy(e.post);if(t)var o=ajaxSendFn(a,"/tasks/"+t,"PUT");else var o=ajaxSendFn(a,"/tasks","POST");200==o.code?(alert("操作成功"),$("#addtasks").modal("hide"),$("#edittasks").modal("hide"),e.view.list=ajaxSendFn({},"/tasks","GET").result||[]):alert(o.message)}}]),app.controller("RuleNonParticipationCtr",["$scope","$http","$filter","$document","$compile","$rootScope",function(e,t,a,o,n,s){e.config.breadset=[{name:"非参与项管理",href:indexUrl+"/admin.html#/rule/nonParticipation",class:"nonParticipation"},{name:"非参与项"}],e.view={},e.view.nonParticipation=ajaxSendFn({},"/nonParticipation","GET").result,e.view.factor=ajaxSendFn({},"/nonParticipation/factor","GET").result,e.view.category=[],e.view.factor&&(e.view.factor.CATEGORY&&e.view.category.push({id:"CATEGORY",name:"品类"}),e.view.factor.DISHES&&e.view.category.push({id:"DISHES",name:"菜品"}),e.view.factor.SETMEAL&&e.view.category.push({id:"SETMEAL",name:"套餐"})),e.openFn=function(){e.view.nonParticipation?(e.post=e.view.nonParticipation,e.post.items||(e.post.items=[{}])):e.post={items:[{}]},$("#add").modal("show")},e.addFn=function(){e.post.items.push({})},e.removeFn=function(t){e.post.items.splice(t,1)},e.sendJsons=function(){var t="/nonParticipation",a="POST",o={};o.content=e.post.content,e.post.items.length&&(o.items=[],angular.forEach(e.post.items,function(e,t){this.push({type:e.type,id:e.id})},o.items)),"[{}]"==JSON.stringify(o.items)&&delete o.items,e.post._id&&(t+="/"+e.post._id,a="PUT");var n=ajaxSendFn(o,t,a);200==n.code?(e.view.nonParticipation=ajaxSendFn({},"/nonParticipation","GET").result,$("#add").modal("hide")):alert(n.message)},e.remove=function(t){if(!confirm("一旦删除将不可恢复，是否确认删除？"))return!1;var a=ajaxSendFn({},"/comments/tag/"+e.view.list.items[t].id,"DELETE");200==a.code?e.view.list.items.splice(t,1):alert(a.message)}}]),app.controller("RuleFrontCtr",["$scope","$http","$filter","$document","$compile","$rootScope",function(e,t,a,o,n,s){e.config.breadset=[{name:"广告管理",href:indexUrl+"/admin.html#/rule/ads",class:"front"},{name:"广告管理"}],e.init=function(){e.view={list:new Array(5)};var t=ajaxSendFn({},"/placards/front","GET").result||[];if(t)for(var a=0;a<t.length;a++)e.view.list[t[a].place-1]=t[a]},e.init(),e.post={},e.removeFn=function(t){if(!confirm("一旦删除将不可恢复，是否确认删除？"))return!1;var a=ajaxSendFn({},"/placards/front/"+e.view.list[t].id,"DELETE");200==a.code?e.view.list[t]="":alert(a.message)},e.openFn=function(t){$("#ad-select").modal("show"),e.view.ads=ajaxSendFn({count:10},"/placards","GET").result||[],e.view.index=t,e.view.select=-1},e.changeFn=function(t){e.view.select==t?e.view.select=-1:e.view.select=t},e.coverFn=function(t,a){var o;o="on"==a?ajaxSendFn({},"/placards/front/"+t+"/cover","POST"):ajaxSendFn({},"/placards/front/"+t+"/cover","DELETE"),200==o.code?(alert("操作成功！"),e.init()):alert(o.message)},e.pageChange=function(){var t={page:e.view.ads.page,count:e.view.ads.count};e.view.ads=ajaxSendFn(t,"/placards","GET").result},e.submitFn=function(){var t={};if(e.view.select>=0){t.adsId=e.view.ads.items[e.view.select].id,t.place=e.view.index+1;var a;a=e.view.list[e.view.index]?ajaxSendFn(t,"/placards/front/"+e.view.list[e.view.index].id,"PUT"):ajaxSendFn(t,"/placards/front","POST"),200==a.code?e.init():alert(a.message)}$("#ad-select").modal("hide"),e.init()}}]),app.controller("RuleMaterialCtr",["$scope","$location","$http",function(e,t,a){e.config.breadset=[{name:"素材管理",href:indexUrl+"/admin.html#/rule/material",class:"material"},{name:"素材列表"}],e.post={},e.posts={materials:[]},e.view={materials:ajaxSendFn({},"/materials","GET").result||[],groups:ajaxSendFn({},"/materials/group","GET").result||[],leftIndex:-2},e.submitFn=function(){var t=ajaxSendFn({name:e.post.name},"/materials/group","POST");200===t.code?(e.view.groups=ajaxSendFn({},"/materials/group","GET").result,e.view.checkName=!1):alert(t.message)},e.groupList=function(t){url="/materials",t>=0&&(url="/materials/group/"+e.view.groups[t].id+"/materials"),t==-1&&(url="/materials/group/materials"),e.view.materials=ajaxSendFn({},url,"GET").result,e.view.leftIndex=t},e.separateGroup=function(t,a){var o=ajaxSendFn({ids:a},"/materials/group/"+e.view.groups[t].id+"/materials","PUT");200===o.code?alert("操作成功"):alert(o.message)},e.pageChange=function(){url="/materials",e.view.leftIndex>=0&&(url="/materials/group/"+e.view.groups[e.view.leftIndex].id+"/materials"),e.view.leftIndex==-1&&(url="/materials/group/materials");var t={page:e.view.materials.page,count:e.view.materials.count};e.view.materials=ajaxSendFn(t,url,"GET").result},e.temimgshow=function(t){if(t.files[0].size>5242880)return void alert("图片不得大于5M，图片格式为png,jpg,jpeg,bmp");var a="/materials";e.view.leftIndex>=0&&(a="/materials/group/"+e.view.groups[e.view.leftIndex].id+"/material"),POSTurl=basicUrl+a+"?",options={url:POSTurl+sortUrl(),type:"POST",success:function(t){200===t.code?e.$apply(function(){a="/materials",e.view.leftIndex>=0&&(a="/materials/group/"+e.view.groups[e.view.leftIndex].id+"/materials"),e.view.leftIndex==-1&&(a="/materials/group/materials"),e.view.materials=ajaxSendFn({count:10},a,"GET").result}):alert(t.message)}},$("#iimgform").ajaxSubmit(options)},e.remove=function(t){if(!confirm("一旦删除将不可恢复，是否确认删除？"))return!1;var a=ajaxSendFn({},"/materials/"+e.view.materials.items[t].id,"DELETE");200==a.code?e.view.materials.items.splice(t,1):alert(a.message)},e.removeAll=function(){if(!e.posts.dishes.length)return void alert("请先选择要删除的图片！");if(!confirm("一旦删除将不可恢复，是否确认删除？"))return!1;var t=ajaxSendFn(e.posts.dishes,"/dishes/ids","DELETE");200==t.code?(e.post={},e.view.materials=ajaxSendFn({},"/material","GET").result):alert(t.message)},e.checkAllDishes=function(){e.materialAll?e.posts.materials=[]:angular.forEach(e.view.materials.items,function(e,t){this[t]=e.id},e.post)}}]),app.controller("ReserveCtr",["$scope","$location","$routeParams","$filter",function(e,t,a,o){e.config.breadset=[{name:"预定管理",href:indexUrl+"/keeper.html#/table/reserve",class:"reserve"},{name:"预定设置"}],e.view={list:ajaxSendFn({},"/activity/reserve","GET").result||{}},e.stateFn=function(t,a){var o=confirm("确认"+("on"==a?"上线":"下线")+"此活动？");
if(o){var n=ajaxSendFn({},"/activity/reserve/"+t+"/"+a,"POST");200==n.code?e.view.list=ajaxSendFn({},"/activity/reserve","GET").result||[]:alert(n.message)}},e.removeFn=function(t){var a=confirm("确认删除？");if(a){var o=ajaxSendFn({},"/activity/reserve/"+t,"DELETE");200==o.code?e.view.list=ajaxSendFn({},"/activity/reserve","GET").result||[]:alert(o.message)}},e.pageChange=function(){var t={page:e.view.list.page,count:e.view.list.count};e.view.list=ajaxSendFn(t,"/activity/reserve","GET").result||{}}}]),app.controller("ReserveAddCtr",["$scope","$http","$routeParams","$filter","$location",function(e,t,a,o,n){if(e.config.breadset=[{name:"预定管理",href:indexUrl+"/keeper.html#/staff/reserve",class:"reserve"},{name:"预定设置"}],e.view={times:ajaxSendFn({},"/businesstimes/all","GET").result,shops:ajaxSendFn({state:1002},"/shops","GET").result,timeType:{1001:"早市",1002:"午市",1003:"下午茶",1004:"晚市",1005:"宵夜"},date:{},dateRange:{}},a.activityId){e.view.id=a.activityId,e.post=ajaxSendFn({},"/activity/reserve/"+a.activityId,"GET").result||[],e.view.date.dateType=e.post.dateRangeCategory,"AROUND_FIX_DATE"!==e.post.dateRangeCategory&&"MONTH_EFFECTIVE"!==e.post.dateRangeCategory||(e.view.date.dateType="AROUND_FIX_DATE",e.view.date.subType=e.post.dateRangeCategory),e.view.date[e.view.date.dateType]={dateRange:e.post.dateRange},e.view.dateRange=e.view.date[e.view.date.dateType].dateRange,e.post.dateRange&&(e.post.dateRange.selectDates?(e.view.dateRange.subType="MANUAL_SELECT",e.view.dateRange.selectDates=arrayMap(e.view.dateRange.selectDates,function(e){return e.split(/\s+/)[0]})):e.post.dateRange.selectDays?e.view.dateRange.subType="MONTH_DAYS":e.post.dateRange.selectWeeks&&(e.view.dateRange.subType="WEEKLY_DAY"));for(var s in e.post.reserveTimes)e.post.reserveTimes[s]&&(e.post.reserveTimes[s]=new Date("1900-01-01 "+e.post.reserveTimes[s]));var r=[];if(e.view.shops)for(var i=0;i<e.view.shops.length;i++)r[e.view.shops[i].id]=1;var l=angular.copy(e.post.shops);e.post.shops=[];for(var i=0;i<e.view.shops.length;i++)l.includes(e.view.shops[i].id)&&(e.post.shops[i]=e.view.shops[i].id)}else e.post={dateRange:{},reserveTimes:{},shops:[]};e.$watch("view.shopAll",function(t,a){t!==a&&(t?angular.forEach(e.view.shops,function(e,t){this[t]=e.id},e.post.shops):e.post.shops=[])}),e.settime=function(t){e.post.reserveTimes[t]?delete e.post.reserveTimes[t]:e.post.reserveTimes[t]=""},e.sendJsons=function(){var t=angular.copy(e.post);t.dateRange={},t.dateRangeCategory=e.view.date.dateType;for(var s in t.reserveTimes)t.reserveTimes[s]&&(t.reserveTimes[s]=o("date")(t.reserveTimes[s],"HH:mm"));if(t.shops=arrRemoveNullFN(t.shops),"CONTINUOUS"===e.view.date.dateType){if(!e.view.dateRange.startDate||!e.view.dateRange.endDate)return void alert("请填写开始和结束日期!");if(e.view.dateRange.endDate<e.view.dateRange.startDate)return void alert("结束日期不能小于开始日期!");t.dateRange.startDate=o("date")(e.view.dateRange.startDate,"yyyy-MM-dd 00:00:00"),t.dateRange.endDate=o("date")(e.view.dateRange.endDate,"yyyy-MM-dd 23:59:59")}else"BIRTHDAY"===e.view.date.dateType&&"AROUND_FIX_DATE"===e.view.date.subType&&(t.dateRange.beforeDays=e.view.dateRange.beforeDays||0,t.dateRange.afterDays=e.view.dateRange.afterDays||0);if(t.dateRange.selectCategory=e.view.dateRange.selectCategory||"NONE","MANUAL_SELECT"===e.view.dateRange.subType){var r=arrayMap(objectKeys(e.view.dateRange.selectDates),function(e){return e+" 00:00:00"});isEmptyObject(r)||(t.dateRange.selectDates=r)}else if("MONTH_DAYS"===e.view.dateRange.subType){var r=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectDays,notNull)),parseInt);isEmptyObject(r)||(t.dateRange.selectDays=r)}else if("WEEKLY_DAY"===e.view.dateRange.subType){var r=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectWeekDays,notNull)),parseInt);isEmptyObject(r)||(t.dateRange.selectWeekDays=r)}if("SELECTED_DATES"!==t.dateRangeCategory&&"EXCLUDE"===t.dateRange.selectCategory&&1==objectCount(t.dateRange))return void alert("没有指定排除日期！");if("SELECTED_DATES"===t.dateRangeCategory&&1==objectCount(t.dateRange))return void alert("没有指定日期！");var i="/activity/reserve",l="POST";a.activityId&&(i+="/"+a.activityId,l="PUT");var d=ajaxSendFn(t,i,l);200==d.code?(alert("操作成功"),"PUT"==l?n.path("/rule/reserve"):n.path("/rule/reserve/add2/"+d.result.id)):alert(d.message)}}]),app.controller("ReserveAdd2Ctr",["$scope","$http","$routeParams","$filter","$location",function(e,t,a,o,n){if(e.config.breadset=[{name:"预定管理",href:indexUrl+"/keeper.html#/staff/reserve",class:"reserve"},{name:"预定设置"}],e.view={times:ajaxSendFn({},"/businesstimes/all","GET").result,factor:ajaxSendFn({},"/activity/reserve/"+a.activityId+"/factor","GET").result,category:[],timeType:{1001:"早市",1002:"午市",1003:"下午茶",1004:"晚市",1005:"宵夜"}},e.post={detail:{}},a.activityId&&e.view.factor){e.view.id=a.activityId;var s=ajaxSendFn({},"/activity/reserve/"+a.activityId+"/rule","GET").result||"";s?e.post=s:e.post.detail.ALL=[{value:[{}]}]}else history.back();e.view.factor.COUPON&&e.view.category.push({id:"COUPON",name:"优惠券"}),e.view.factor.REWARD&&e.view.category.push({id:"REWARD",name:"代用币"}),e.addFn=function(e){e.push({value:[{}]})},e.addCouponFn=function(e){e.push({})},e.removeCouponFn=function(e,t){e.splice(t,1)},e.changeCoupon=function(t){if(t.id)for(var a=0;a<e.view.factor.COUPON.length;a++)if(e.view.factor.COUPON[a].id===t.id){t.name=e.view.factor.COUPON[a].name,t.category="COUPON",t.count=1;break}},e.changeReward=function(t){if(t.id)for(var a=0;a<e.view.factor.REWARD.length;a++)if(e.view.factor.REWARD[a].id===t.id){t.name=e.view.factor.REWARD[a].name,t.category="REWARD",t.count=1;break}},e.sendJsons=function(){var t=angular.copy(e.post);for(var a in t.detail)for(var o in t.detail[a])"[{}]"==JSON.stringify(t.detail[a][o].value)&&delete t.detail[a][o].value;var s="/activity/reserve/"+e.view.id+"/rule",r="POST",i=ajaxSendFn(t,s,r);200==i.code?(alert("操作成功"),n.path("/rule/reserve")):alert(i.message)}}]),app.controller("redpacketsCtr",["$scope","$http","$filter","$document","$compile","$rootScope",function(e,t,a,o,n,s){e.config.breadset=[{name:"红包管理",href:indexUrl+"/admin.html#/rule/redpackets",class:"redpackets"},{name:"红包管理"}],e.view={list:ajaxSendFn({},"/activity/packet","GET").result||[]},e.offFn=function(t){var a=confirm("确认下线此活动？");if(a){var o=ajaxSendFn({},"/activity/packet/"+t+"/off","POST");200==o.code?e.view.list=ajaxSendFn({},"/activity/packet","GET").result||[]:alert(o.message)}},e.dianjiFn=function(e){var t=ajaxSendFn({},"/activity/packet/"+e,"GET").result;console.log(t)},e.onFn=function(t){var a=confirm("确认上线此活动？");if(a){var o=ajaxSendFn({},"/activity/packet/"+t+"/on","POST");200==o.code?e.view.list=ajaxSendFn({},"/activity/packet","GET").result||[]:alert(o.message)}},e.removeFn=function(t){var a=confirm("确认删除？");if(a){var o=ajaxSendFn({},"/activity/packet/"+t,"DELETE");200==o.code?e.view.list=ajaxSendFn({},"/activity/packet","GET").result||[]:alert(o.message)}}}]),app.controller("addpacketsCtr",["$scope","$http","$routeParams","$filter","$location","CouponFactory",function(e,t,a,o,n,s){e.config.breadset=[{name:"红包管理",href:indexUrl+"/admin.html#/rule/addpackets",class:"addpackets"},{name:"红包管理"}],e.view={category:[]},e.view1={},e.transferMap={POINT_CONSUME:"POINTCONSUME",COUPON_FREE:"COUPONFREE",CHARGE_CONSUME:"CHARGECONSUME",SPECIAL_PRICE:"SPECIALPRICE",LIMIT_REDUCE:"LIMITREDUCE",SPEND_AS:"SPENDAS",SET_MEAL:"SETMEAL",GIVEN_UPGRADE:"GIVENUPGRADE",CHARGE_FREE:"CHARGEFREE",BIRTH_BENEFIT:"BIRTHBENEFIT",FIRST_GIFT:"FIRSTGIFT"},e.transferMapRev={POINTCONSUME:"POINT_CONSUME",COUPONFREE:"COUPON_FREE",CHARGECONSUME:"CHARGE_CONSUME",SPECIALPRICE:"SPECIAL_PRICE",LIMITREDUCE:"LIMIT_REDUCE",SPENDAS:"SPEND_AS",SETMEAL:"SET_MEAL",GIVENUPGRADE:"GIVEN_UPGRADE",CHARGEFREE:"CHARGE_FREE",BIRTHBENEFIT:"BIRTH_BENEFIT",FIRSTGIFT:"FIRST_GIFT"},e.tem={rules:{}},e.allShop=!1,e.set={times:ajaxSendFn({},"/businesstimes/all","GET").result,list:ajaxSendFn({state:1002},"/shops","GET").result,list2:[],shops:[]},e.set.list||(alert("目前还没有添加门店"),n.path("/shops")),e.set.nonParticipation=ajaxSendFn({},"/nonParticipation/content","GET").result,e.checkallstr=0,e.posts={shops:[],allDay:!1},e.coupon={shared:[],shops:[]},e.temcoupons2={},e.temcoupons=[],e.ruleCategory=consumeRuleObj,e.ruleCategory1=onlineRuleObj,e.obtainRepeatCategory=obtainRepeatCategory,e.ruleFn={openOrClose:function(){$("#add").modal("show"),e.isOpenOrClose=!0},testAddOk:function(){$("#add").modal("hide"),e.isOpenOrClose=!1,alert("添加成功")},testAddFail:function(e){errorMsg(e)},getCpouponFn:function(){console.log(e.view),e.view1=ajaxSendFn({},"/activity/factor","GET").result||[],e.view.coupons=e.view1.COUPON||[],e.view.rewards=e.view1.REWARD||[],console.log("1111"),console.log(e.view)},getCouponType:function(t){for(var a=0;e.view.coupons&&a<e.view.coupons.length;a++)if(e.view.coupons[a].id===t)return e.view.coupons[a].category},changeCoupon:function(t,a){if(a.id){a.count=1;for(var o=0;o<e.view.coupons.length;o++)if(e.view.coupons[o].id===a.id){a.name=e.view.coupons[o].name;break}}},oldRuleFn:function(){e.view={counponType:{OFFSETCASH:"代金券",DISCOUNT:"折扣券",PHYSICAL:"实物券",GIFT:"礼券",new:"新增券"}},console.log(e.view),e.ruleFn.getCpouponFn(),e.view.rules={CHARGE:{name:"充值",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addCouponFn,postFunc:e.ruleFn.sendCouponFn,content:{CHARGE:[]}}},console.log("222222"),console.log(e.view.rules),e.view.shop=ajaxSendFn({state:"1002"},"/shops","GET").result||[],e.tem.shops=[];for(var t in e.view.shop)e.tem.shops.push(e.view.shop[t].id);e.tem.rules={},e.tem.rules[e.tem.rules.type]=e.tem.rules},stateFn:function(t,a,o,n){var s=t.split("_")[0];if(s in e.view.rules&&(e.view.rules[s].state=a,e.view.rules[s].show=o),"add"==a&&e.ruleFn.buttonFn(t),!n)return void(e.btnDisable=1);var r=n.type;o&&(n.celling&&(n.celling=100*n.celling),e.view.rules[s].content[r]=n)},closeFn:function(t){"edit"==e.view.rules[t].state?e.view.rules[t].state="show":"add"==e.view.rules[t].state&&(e.view.rules[t].state="show")},buttonFn:function(t){if("show"==e.view.rules[t].state)e.ruleFn.postFn(t),e.ruleFn.memberFn(),e.view.rules[t].state="edit";else if("edit"==e.view.rules[t].state){var a=e.ruleFn.sendCouponFn();a&&(e.view.rules[t].state="show")}else if("add"==e.view.rules[t].state){for(x in e.view.rules[t].content)e.view.rules[t].addFunc(x);e.view.rules[t].state="edit",$("#showadd").modal("hide")}},memberFn:function(){e.view.member=e.tem.member=e.view1.MEMBERGRADE||[],e.view.member1=[],e.view.member=o("orderBy")(e.view.member,"grade"),e.view.member1.push({id:"ALL",name:"全员"}),e.view.member.push({id:"ALL",name:"全员"}),e.view.member.push({id:"MEMBER",name:"任一会员"}),"GIVENUPGRADE"==e.tem.activityCategory&&e.view.member.push({id:"CUSTOMER",name:"非会员"}),"COUPONFREE"==e.tem.activityCategory&&e.view.member.push({id:"FOLLOWED",name:"微信粉丝"}),e.tem.member1=e.view.member},postFn:function(t){var a=e.view.rules[t].content;console.log(a),e.posts[t]={};for(x in a){var o=!0;e.posts[t][x]=a[x],a[x]instanceof Array&&(o=!1),e.posts[t][x].check=o,a[x].detail&&Object.keys(a[x].detail).length||e.view.rules[t].addFunc(x)}},addCouponFn:function(t){e.ruleFn.addFn(t,function(a,o){var n=e.posts[a][t].detail.ALL;if(n&&n.length>0&&!isEmptyObject(n[0])){var s={};s.value=[{}],e.posts[a][t].detail.ALL.push(s),console.log("obj1"),console.log(s)}else{var s=e.posts[a][t].detail.ALL[0];delete s.id,console.log("obj2"),console.log(s),s.value=[{}]}console.log("$$hashKey"),console.log(e.posts[a][t].detail.ALL)})},addFn:function(t,a){var o,n,s=t.split("_");if(s&&s.length>0&&(o=s[0]),s&&s.length>1&&(n=s[1]),!e.posts[o]||!e.posts[o][t]||!e.posts[o][t].detail||isEmptyObject(e.posts[o][t].detail))return e.posts[o]||(e.posts[o]={}),e.posts[o][t]=e.view.rules[o].content[t],e.posts[o][t].detail={ALL:[{}]},void(a&&a(o,n));if(e.posts[o][t].detail.ALL){var r={};a?a(o,n):e.posts[o][t].detail.ALL.push(r)}else e.posts[o][t].detail.ALL=[{}],a&&a(o,n);console.log("$$hashKey"),console.log(e.posts[o][t].detail.ALL)},removeFn:function(t,a,o){var n=t.split("_")[0];e.posts[n][t].detail[a][o]&&e.posts[n][t].detail[a].splice(o,1)},checkCouponList:function(t){for(var a=0;t&&a<t.length-1;a++)for(var o=a+1;o<t.length;o++)if(t[a].id===t[o].id)return!0;for(var a=0;t&&a<t.length-1;a++)for(var n=e.ruleFn.getCouponType(t[a].id),o=1;o<t.length;o++){var s=e.ruleFn.getCouponType(t[o].id);if(n===s)return!0}return!1},sendChargeConsumeFn:function(t){return e.ruleFn.sendFn(t,void 0,void 0,function(e){var t=e.detail.ALL[0];t.amount=1,t.currentAmount=t.count=0})},sendCouponFn:function(t){return e.ruleFn.sendFn(t,function(t,a){if("COUPON"===t)for(var o in a)if(a[o]&&a[o].length>0&&e.ruleFn.checkCouponList(a[o][0].value))return{message:"券或券类型不能重复"}},function(e,t){if(e&&"COUPON"===e)for(var a in t.detail){var o={};for(var n in t.detail[a]){if(o[a]===t.detail[a][n].value[0].id)return{message:"注意：券不能重复"};o[a]=t.detail[a][n].value[0].id}}})},sendFn:function(t,o,n,s){var r=e.posts[t],i={};for(var l in r)if(e.view.rules[t].uncheck||r[l].check){e.transferMapRev.hasOwnProperty(l)?i.type=e.transferMapRev[l]:i.type=l,i.detail={},r[l]._id&&(i._id=r[l]._id),r[l].amountLimit&&(i.amountLimit=r[l].amountLimit),r[l].celling&&(i.celling=parseInt(r[l].celling)/100,r[l].firstLimit?i.firstLimit=!0:i.firstLimit=!1),"CHARGE_CONSUME"==i.type&&(r[l].allpurpose?i.allpurpose=!0:i.allpurpose=!1),"number"==typeof r[l].countLimit&&(i.countLimit=r[l].countLimit),r[l].timesLimit&&(i.timesLimit=r[l].timesLimit),r[l].obtainCategory&&(i.obtainCategory=r[l].obtainCategory);var d,c=r[l].detail,u=l.split("_");u&&u.length>1&&(d=u[1]);for(z in c)for(w in c[z]){var p=c[z][w],m={};if(("number"==typeof p.amount||p.amount)&&(m.amount=p.amount),p.score&&(m.score=p.score),p.gradeId&&(m.gradeId=p.gradeId),p.value&&0!=p.value.length){if(m.value=p.value,m.value&&m.value.length)for(var l in m.value)delete m.value[l].$$hashKey}else"CHARGE_CONSUME"==i.type&&(m.value=!1);void 0!==p.limit&&(m.limit=p.limit),p.count&&(m.count=p.count),p.currentAmount&&(m.currentAmount=p.currentAmount),i.detail[p.id]?i.detail[p.id].push(m):i.detail[p.id]=[m]}if("CHARGE"==i.type&&angular.forEach(i.detail.ALL,function(e,t){e.value&&e.value[0].category||delete e.value}),n&&"function"==typeof n&&(obj=n(d,i),obj))return alert(obj.message),!1;s&&"function"==typeof s&&s(i)}if("TICKET"==e.tem.activityCategory){if(!e.tel.inviters)return void alert("请输入邀请码");i.inviters=e.tel.inviters.split(",")}var v=ajaxSendFn(i,"/activity/"+a.activityid+"/rule","POST",1);return 200!=v.code?(errorMsg(v),!1):(e.ruleFn.oldRuleFn(),!0)},addCouponPlanFn:function(t){"new"==t&&e.ruleFn.showCouponPlanFn()},addRuleFn:function(){e.view.modal={title:"添加活动内容",html:"addrule"},$("#showadd").modal("show")},showCouponPlanFn:function(t){e.view.modal={title:"添加券",html:"couponNew"},$("#showadd").modal("show")},put:function(e,t){e.value||(e.value=[]),t={},e.value.push(t)},resetCouponCntFn:function(e,t){angular.forEach(e.value,function(e,a){e&&e.id===t.id&&this.splice(a,1)},e.value)},containsCoupon:function(e,t){for(var a=-1,o=0;e.value&&o<e.value.length;o++)if(e.value[o].id===t){a=o;break}return a}},console.log(e.view),e.ruleFn.oldRuleFn(),e.sendJsons=function(){if(console.log(e.posts),!e.posts.picUrl)return void alert("请先上传图片");e.posts.shops=e.set.shops.filter(function(e){return e&&e.trim()});var t=angular.copy(e.posts);delete t.CHARGE,t.rule.detail={};for(var a=angular.copy(e.posts.CHARGE.CHARGE.detail.ALL),s=0;s<a.length;s++){var r=a[s].id;t.rule.detail[r]=[{amount:a[s].amount,value:a[s].value}]}if(console.log(t),t.dateRange={},t.dateRangeCategory=e.view.date.dateType,"CONTINUOUS"===e.view.date.dateType){if(!e.view.dateRange.startDate||!e.view.dateRange.endDate)return void alert("请填写开始和结束日期!");if(e.view.dateRange.endDate<e.view.dateRange.startDate)return void alert("结束日期不能小于开始日期!");t.dateRange.startDate=o("date")(e.view.dateRange.startDate,"yyyy-MM-dd 00:00:00"),t.dateRange.endDate=o("date")(e.view.dateRange.endDate,"yyyy-MM-dd 23:59:59")}else"BIRTHDAY"===e.view.date.dateType&&"AROUND_FIX_DATE"===e.view.date.subType&&(t.dateRange.beforeDays=e.view.dateRange.beforeDays||0,t.dateRange.afterDays=e.view.dateRange.afterDays||0);if(t.dateRange.selectCategory=e.view.dateRange.selectCategory||"NONE","MANUAL_SELECT"===e.view.dateRange.subType){var i=arrayMap(objectKeys(e.view.dateRange.selectDates),function(e){return e+" 00:00:00"});isEmptyObject(i)||(t.dateRange.selectDates=i)}else if("MONTH_DAYS"===e.view.dateRange.subType){var i=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectDays,notNull)),parseInt);isEmptyObject(i)||(t.dateRange.selectDays=i)}else if("WEEKLY_DAY"===e.view.dateRange.subType){var i=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectWeekDays,notNull)),parseInt);isEmptyObject(i)||(t.dateRange.selectWeekDays=i)}if("SELECTED_DATES"!==t.dateRangeCategory&&"EXCLUDE"===t.dateRange.selectCategory&&1==objectCount(t.dateRange))return void alert("没有指定排除日期！");if("SELECTED_DATES"===t.dateRangeCategory&&1==objectCount(t.dateRange))return void alert("没有指定日期！");t.advertisement&&!t.advertisement.id&&delete t.advertisement,console.log(t);var l="/activity/packet",d=ajaxSendFn(t,l,"POST");200==d.code?(alert("操作成功"),n.path("/rule/addpackets")):alert(d.message)},e.ruleFn.memberFn(),e.ruleFn.postFn("CHARGE"),e.tem&&e.tem.activityCategory&&isEmptyObject(e.tem.rules)&&e.ruleFn.stateFn(e.tem.activityCategory,"add",1),e.checkAllShops=function(){if(console.log(e.posts.allShop),e.posts.allShop){for(var t=[],a=0;a<e.set.list.length;a++)t.push(e.set.list[a].id);e.set.shops=t}else e.set.shops=[],e.posts.shops=[]},e.checkShops=function(t){0==t&&(delete t,e.posts.allShop=!1);var a=e.set.shops.filter(function(e){return e&&e.trim()});a.length==e.set.list.length?e.posts.allShop=!0:e.posts.allShop=!1}}]),app.controller("editpacketsCtr",["$scope","$http","$routeParams","$filter","$location","CouponFactory",function(e,t,a,o,n,s){e.config.breadset=[{name:"红包管理",href:indexUrl+"/admin.html#/rule/editpackets",class:"editpackets"},{name:"红包管理"}],e.view={category:[],date:{}},e.view1={},e.posts={shops:[],rule:{detail:[]},allDay:!1},e.tem={rules:{}},e.allShop=!1,e.set={times:ajaxSendFn({},"/businesstimes/all","GET").result,list:ajaxSendFn({state:1002},"/shops","GET").result,list2:[],shops:[]},e.set.list||(alert("目前还没有添加门店"),n.path("/shops")),e.set.nonParticipation=ajaxSendFn({},"/nonParticipation/content","GET").result,e.checkallstr=0,e.coupon={shared:[],shops:[]},e.temcoupons2={},e.temcoupons=[],e.ruleCategory=consumeRuleObj,e.ruleCategory1=onlineRuleObj,e.obtainRepeatCategory=obtainRepeatCategory,e.ruleFn={getCpouponFn:function(){console.log(e.view),e.view1=ajaxSendFn({},"/activity/factor","GET").result||[],e.view.coupons=e.view1.COUPON||[],e.view.rewards=e.view1.REWARD||[],console.log("1111"),console.log(e.view)},getCouponType:function(t){for(var a=0;e.view.coupons&&a<e.view.coupons.length;a++)if(e.view.coupons[a].id===t)return e.view.coupons[a].category},changeCoupon:function(t,a){if(a.id){a.count=1;for(var o=0;o<e.view.coupons.length;o++)if(e.view.coupons[o].id===a.id){a.name=e.view.coupons[o].name;break}}},oldRuleFn:function(){e.view={counponType:{OFFSETCASH:"代金券",DISCOUNT:"折扣券",PHYSICAL:"实物券",GIFT:"礼券",new:"新增券"}},console.log(e.view),e.ruleFn.getCpouponFn(),e.view.rules={name:"充值",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addCouponFn,postFunc:e.ruleFn.sendCouponFn,content:{CHARGE:[]}},console.log("222222"),console.log(e.view.rules),e.view.shop=ajaxSendFn({state:"1002"},"/shops","GET").result||[],e.tem.shops=[];for(var t in e.view.shop)e.tem.shops.push(e.view.shop[t].id)},closeFn:function(t){"edit"==e.view.rules[t].state?e.view.rules[t].state="show":"add"==e.view.rules[t].state&&(e.view.rules[t].state="show")},memberFn:function(){e.view.member=e.tem.member=e.view1.MEMBERGRADE||[],e.view.member1=[],e.view.member=o("orderBy")(e.view.member,"grade"),e.view.member1.push({id:"ALL",name:"全员"}),e.view.member.push({id:"ALL",name:"全员"}),e.view.member.push({id:"MEMBER",name:"任一会员"}),"GIVENUPGRADE"==e.tem.activityCategory&&e.view.member.push({id:"CUSTOMER",name:"非会员"}),"COUPONFREE"==e.tem.activityCategory&&e.view.member.push({id:"FOLLOWED",name:"微信粉丝"}),e.tem.member1=e.view.member},postFn:function(){var t=e.view.rules.content;console.log(t),e.ruleFn.addCouponFn()},addCouponFn:function(){var t={};t.value=[{}],e.posts.rule.detail&&e.posts.rule.detail.ALL?e.posts.rule.detail.ALL.push(t):e.posts.rule.detail={ALL:[{}]},console.log("obj1"),console.log(t)},removeFn:function(t,a){e.posts.rule.detail[t][a]&&e.posts.rule.detail[t].splice(a,1)},checkCouponList:function(t){for(var a=0;t&&a<t.length-1;a++)for(var o=a+1;o<t.length;o++)if(t[a].id===t[o].id)return!0;for(var a=0;t&&a<t.length-1;a++)for(var n=e.ruleFn.getCouponType(t[a].id),o=1;o<t.length;o++){var s=e.ruleFn.getCouponType(t[o].id);if(n===s)return!0}return!1},sendChargeConsumeFn:function(t){return e.ruleFn.sendFn(t,void 0,void 0,function(e){var t=e.detail.ALL[0];t.amount=1,t.currentAmount=t.count=0})},sendCouponFn:function(t){return e.ruleFn.sendFn(t,function(t,a){if("COUPON"===t)for(var o in a)if(a[o]&&a[o].length>0&&e.ruleFn.checkCouponList(a[o][0].value))return{message:"券或券类型不能重复"}},function(e,t){if(e&&"COUPON"===e)for(var a in t.detail){var o={};for(var n in t.detail[a]){if(o[a]===t.detail[a][n].value[0].id)return{message:"注意：券不能重复"};o[a]=t.detail[a][n].value[0].id}}})},sendFn:function(t,o,n,s){var r=e.posts[t],i={};for(var l in r)if(e.view.rules[t].uncheck||r[l].check){e.transferMapRev.hasOwnProperty(l)?i.type=e.transferMapRev[l]:i.type=l,i.detail={},r[l]._id&&(i._id=r[l]._id),r[l].amountLimit&&(i.amountLimit=r[l].amountLimit),r[l].celling&&(i.celling=parseInt(r[l].celling)/100,r[l].firstLimit?i.firstLimit=!0:i.firstLimit=!1),"CHARGE_CONSUME"==i.type&&(r[l].allpurpose?i.allpurpose=!0:i.allpurpose=!1),"number"==typeof r[l].countLimit&&(i.countLimit=r[l].countLimit),r[l].timesLimit&&(i.timesLimit=r[l].timesLimit),r[l].obtainCategory&&(i.obtainCategory=r[l].obtainCategory);var d,c=r[l].detail,u=l.split("_");u&&u.length>1&&(d=u[1]);for(z in c)for(w in c[z]){var p=c[z][w],m={};if(("number"==typeof p.amount||p.amount)&&(m.amount=p.amount),p.score&&(m.score=p.score),p.gradeId&&(m.gradeId=p.gradeId),p.value&&0!=p.value.length){if(m.value=p.value,m.value&&m.value.length)for(var l in m.value)delete m.value[l].$$hashKey}else"CHARGE_CONSUME"==i.type&&(m.value=!1);void 0!==p.limit&&(m.limit=p.limit),p.count&&(m.count=p.count),p.currentAmount&&(m.currentAmount=p.currentAmount),i.detail[p.id]?i.detail[p.id].push(m):i.detail[p.id]=[m]}if("CHARGE"==i.type&&angular.forEach(i.detail.ALL,function(e,t){e.value&&e.value[0].category||delete e.value}),n&&"function"==typeof n&&(obj=n(d,i),obj))return alert(obj.message),!1;s&&"function"==typeof s&&s(i)}if("TICKET"==e.tem.activityCategory){if(!e.tel.inviters)return void alert("请输入邀请码");i.inviters=e.tel.inviters.split(",")}var v=ajaxSendFn(i,"/activity/"+a.activityid+"/rule","POST",1);return 200!=v.code?(errorMsg(v),!1):(e.ruleFn.oldRuleFn(),!0)},addCouponPlanFn:function(t){"new"==t&&e.ruleFn.showCouponPlanFn()},addRuleFn:function(){e.view.modal={title:"添加活动内容",html:"addrule"},$("#showadd").modal("show")},showCouponPlanFn:function(t){e.view.modal={title:"添加券",html:"couponNew"},$("#showadd").modal("show")},put:function(e,t){e.value||(e.value=[]),t={},e.value.push(t)},resetCouponCntFn:function(e,t){angular.forEach(e.value,function(e,a){e&&e.id===t.id&&this.splice(a,1)},e.value)},containsCoupon:function(e,t){for(var a=-1,o=0;e.value&&o<e.value.length;o++)if(e.value[o].id===t){a=o;break}return a}},e.ruleFn.oldRuleFn(),e.ruleFn.memberFn(),e.ruleFn.postFn("CHARGE"),e.cbdata=ajaxSendFn({},"/activity/packet/"+a.id,"GET").result,e.posts=angular.copy(e.cbdata),delete e.posts.createTime,delete e.posts.id,delete e.posts.offTime,delete e.posts.onTime,delete e.posts.dateRange,delete e.posts.text,delete e.posts.rule.detail.ALL.text;for(var r=0;r<e.set.list.length;r++)for(var i=0;i<e.posts.shops.length;i++)e.set.list[r].id==e.posts.shops[i]&&(e.set.shops[r]=e.posts.shops[i]);e.posts.rule.detail={},e.posts.rule.detail.ALL=[];for(var l=e.cbdata.rule.detail,d=Object.keys(l),r=0;r<d.length;r++){var c=d[r];delete l[c][0].text,e.posts.rule.detail.ALL.push(l[c][0]),console.log(l[c])}console.log("$scope.posts"),console.log(e.posts),e.view.date={},e.view.dateRange=e.cbdata.dateRange;var u=e.posts.dateRangeCategory;e.view.date[u]=e.cbdata.dateRange,e.view.date.dateType=u,console.log(e.view),e.sendJsons=function(){if(console.log(e.posts),!e.posts.picUrl)return void alert("请先上传图片");e.posts.shops=e.set.shops.filter(function(e){return e&&e.trim()});var t=angular.copy(e.posts);t.rule.detail={};for(var n=angular.copy(e.posts.rule.detail.ALL),s=0;s<n.length;s++){var r=n[s].id;t.rule.detail[r]=[{amount:n[s].amount,value:n[s].value}]}if(console.log(t),t.dateRange={},t.dateRangeCategory=e.view.date.dateType,"CONTINUOUS"===e.view.date.dateType){if(!e.view.dateRange.startDate||!e.view.dateRange.endDate)return void alert("请填写开始和结束日期!");if(e.view.dateRange.endDate<e.view.dateRange.startDate)return void alert("结束日期不能小于开始日期!");t.dateRange.startDate=o("date")(e.view.dateRange.startDate,"yyyy-MM-dd 00:00:00"),t.dateRange.endDate=o("date")(e.view.dateRange.endDate,"yyyy-MM-dd 23:59:59")}else"BIRTHDAY"===e.view.date.dateType&&"AROUND_FIX_DATE"===e.view.date.subType&&(t.dateRange.beforeDays=e.view.dateRange.beforeDays||0,t.dateRange.afterDays=e.view.dateRange.afterDays||0);if(t.dateRange.selectCategory=e.view.dateRange.selectCategory||"NONE","MANUAL_SELECT"===e.view.dateRange.subType){var i=arrayMap(objectKeys(e.view.dateRange.selectDates),function(e){return e+" 00:00:00"});isEmptyObject(i)||(t.dateRange.selectDates=i)}else if("MONTH_DAYS"===e.view.dateRange.subType){var i=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectDays,notNull)),parseInt);isEmptyObject(i)||(t.dateRange.selectDays=i)}else if("WEEKLY_DAY"===e.view.dateRange.subType){var i=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectWeekDays,notNull)),parseInt);isEmptyObject(i)||(t.dateRange.selectWeekDays=i)}if("SELECTED_DATES"!==t.dateRangeCategory&&"EXCLUDE"===t.dateRange.selectCategory&&1==objectCount(t.dateRange))return void alert("没有指定排除日期！");if("SELECTED_DATES"===t.dateRangeCategory&&1==objectCount(t.dateRange))return void alert("没有指定日期！");t.advertisement&&!t.advertisement.id&&delete t.advertisement,console.log(t);var l="/activity/packet/"+a.id,d=ajaxSendFn(t,l,"POST");200==d.code?alert("操作成功"):alert(d.message)},e.checkAllShops=function(){if(console.log(e.posts.allShop),e.posts.allShop){for(var t=[],a=0;a<e.set.list.length;a++)t.push(e.set.list[a].id);e.set.shops=t}else e.set.shops=[],e.posts.shops=[]},e.checkShops=function(t){0==t&&(delete t,e.posts.allShop=!1);var a=e.set.shops.filter(function(e){return e&&e.trim()});a.length==e.set.list.length?e.posts.allShop=!0:e.posts.allShop=!1}}]),app.controller("commissionCtr",["$scope","$http","$filter","$document","$compile","$rootScope",function(e,t,a,o,n,s){e.config.breadset=[{name:"返佣管理",href:indexUrl+"/admin.html#/rule/commission",class:"commission"},{name:"返佣管理"}],e.view={list:ajaxSendFn({},"/activity/commision","GET").result||[]},e.offFn=function(t){var a=confirm("确认下线此活动？");if(a){var o=ajaxSendFn({},"/activity/commision/"+t+"/off","POST");200==o.code?e.view.list=ajaxSendFn({},"/activity/commision","GET").result||[]:alert(o.message)}},e.onFn=function(t){var a=confirm("确认上线此活动？");if(a){var o=ajaxSendFn({},"/activity/commision/"+t+"/on","POST");200==o.code?e.view.list=ajaxSendFn({},"/activity/commision","GET").result||[]:alert(o.message)}},e.removeFn=function(t){var a=confirm("确认删除？");if(a){var o=ajaxSendFn({},"/activity/commision/"+t,"DELETE");200==o.code?e.view.list=ajaxSendFn({},"/activity/commision","GET").result||[]:alert(o.message)}}}]),app.controller("addcommissionCtr",["$scope","$http","$routeParams","$filter","$location","CouponFactory",function(e,t,a,o,n,s){e.config.breadset=[{name:"返佣管理",href:indexUrl+"/admin.html#/rule/addcommission",class:"addcommission"},{name:"返佣管理"}],e.view={category:[]},e.view1={},e.transferMap={POINT_CONSUME:"POINTCONSUME",COUPON_FREE:"COUPONFREE",CHARGE_CONSUME:"CHARGECONSUME",SPECIAL_PRICE:"SPECIALPRICE",LIMIT_REDUCE:"LIMITREDUCE",SPEND_AS:"SPENDAS",SET_MEAL:"SETMEAL",GIVEN_UPGRADE:"GIVENUPGRADE",CHARGE_FREE:"CHARGEFREE",BIRTH_BENEFIT:"BIRTHBENEFIT",FIRST_GIFT:"FIRSTGIFT"},e.transferMapRev={POINTCONSUME:"POINT_CONSUME",COUPONFREE:"COUPON_FREE",CHARGECONSUME:"CHARGE_CONSUME",SPECIALPRICE:"SPECIAL_PRICE",LIMITREDUCE:"LIMIT_REDUCE",SPENDAS:"SPEND_AS",SETMEAL:"SET_MEAL",GIVENUPGRADE:"GIVEN_UPGRADE",CHARGEFREE:"CHARGE_FREE",BIRTHBENEFIT:"BIRTH_BENEFIT",FIRSTGIFT:"FIRST_GIFT"},e.tem={rules:{}},e.allShop=!1,e.set={times:ajaxSendFn({},"/businesstimes/all","GET").result,list:ajaxSendFn({state:1002},"/shops","GET").result,allocate:ajaxSendFn({},"/activity/allocate/8003","GET").result||[],allocates:[],shops:[]},console.log(e.set.times),e.set.list||(alert("目前还没有添加门店"),n.path("/shops")),e.set.nonParticipation=ajaxSendFn({},"/nonParticipation/content","GET").result,e.checkallstr=0,e.posts={shops:[]},e.coupon={shared:[],shops:[]},e.cons=function(e){console.log("highest"),console.log(e)},e.temcoupons2={},e.temcoupons=[],e.ruleCategory=consumeRuleObj,e.ruleCategory1=onlineRuleObj,e.obtainRepeatCategory=obtainRepeatCategory,e.ruleFn={openOrClose:function(){$("#add").modal("show"),e.isOpenOrClose=!0},testAddOk:function(){$("#add").modal("hide"),e.isOpenOrClose=!1,alert("添加成功")},testAddFail:function(e){errorMsg(e)},getCpouponFn:function(){console.log(e.view),e.view1=ajaxSendFn({},"/activity/factor","GET").result||[],e.view.coupons=e.view1.COUPON||[],e.view.rewards=e.view1.REWARD||[],console.log("1111"),console.log(e.view)},getCouponType:function(t){for(var a=0;e.view.coupons&&a<e.view.coupons.length;a++)if(e.view.coupons[a].id===t)return e.view.coupons[a].category},changeCoupon:function(t,a){if(a.id){a.count=1;for(var o=0;o<e.view.coupons.length;o++)if(e.view.coupons[o].id===a.id){a.name=e.view.coupons[o].name;break}}},oldRuleFn:function(){e.ruleFn.getCpouponFn(),e.view.rules={CHARGE:{name:"充值",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addCouponFn,postFunc:e.ruleFn.sendCouponFn,content:{CHARGE:[]}}},console.log("222222"),console.log(e.view.rules),e.view.shop=ajaxSendFn({state:"1002"},"/shops","GET").result||[],e.tem.shops=[];for(var t in e.view.shop)e.tem.shops.push(e.view.shop[t].id);e.tem.rules={},e.tem.rules[e.tem.rules.type]=e.tem.rules},stateFn:function(t,a,o,n){var s=t.split("_")[0];if(s in e.view.rules&&(e.view.rules[s].state=a,e.view.rules[s].show=o),"add"==a&&e.ruleFn.buttonFn(t),!n)return void(e.btnDisable=1);var r=n.type;o&&(n.celling&&(n.celling=100*n.celling),e.view.rules[s].content[r]=n)},closeFn:function(t){"edit"==e.view.rules[t].state?e.view.rules[t].state="show":"add"==e.view.rules[t].state&&(e.view.rules[t].state="show")},buttonFn:function(t){if("show"==e.view.rules[t].state)e.ruleFn.postFn(t),e.ruleFn.memberFn(),e.view.rules[t].state="edit";else if("edit"==e.view.rules[t].state){var a=e.ruleFn.sendCouponFn();a&&(e.view.rules[t].state="show")}else if("add"==e.view.rules[t].state){for(x in e.view.rules[t].content)e.view.rules[t].addFunc(x);e.view.rules[t].state="edit",$("#showadd").modal("hide")}},postFn:function(t){var a=e.view.rules[t].content;console.log(a),e.posts[t]={};for(x in a){var o=!0;e.posts[t][x]=a[x],a[x]instanceof Array&&(o=!1),e.posts[t][x].check=o,a[x].detail&&Object.keys(a[x].detail).length||e.view.rules[t].addFunc(x)}},addCouponFn:function(t){e.ruleFn.addFn(t,function(a,o){if(void 0!=e.posts[a][t].detail)if(void 0!=e.posts[a][t].detail.ALL)var n=e.posts[a][t].detail.ALL;else e.posts[a][t].detail.ALL=[];else e.posts[a][t].detail={},e.posts[a][t].detail.ALL=[];if(n&&n.length>0&&!isEmptyObject(n[0])){var s={};s.value={},s.allocates=[];for(var r=0;r<e.set.list.length;r++)s.allocates[r]={highest:"false",id:""};e.posts[a][t].detail.ALL.push(s),console.log("obj1"),console.log(s)}else{var s={};s.value={},s.allocates=[];for(var r=0;r<e.set.list.length;r++)s.allocates[r]={highest:"false",id:""};e.posts[a][t].detail.ALL.push(s),console.log("obj2"),console.log(s)}console.log("$$hashKey"),console.log(e.posts[a][t].detail.ALL);
})},addFn:function(t,a){var o,n,s=t.split("_");return s&&s.length>0&&(o=s[0]),s&&s.length>1&&(n=s[1]),e.posts[o]&&e.posts[o][t]&&e.posts[o][t].detail&&!isEmptyObject(e.posts[o][t].detail)?(e.posts[o][t].detail.ALL?a&&a(o,n):a&&a(o,n),console.log("$$hashKey"),void console.log(e.posts[o][t].detail.ALL)):(e.posts[o]||(e.posts[o]={}),e.posts[o][t]=e.view.rules[o].content[t],void(a&&a(o,n)))},removeFn:function(t,a,o){var n=t.split("_")[0];e.posts[n][t].detail[a][o]&&e.posts[n][t].detail[a].splice(o,1)},sendChargeConsumeFn:function(t){return e.ruleFn.sendFn(t,void 0,void 0,function(e){var t=e.detail.ALL[0];t.amount=1,t.currentAmount=t.count=0})},sendFn:function(t,o,n,s){var r=e.posts[t],i={};for(var l in r)if(e.view.rules[t].uncheck||r[l].check){e.transferMapRev.hasOwnProperty(l)?i.type=e.transferMapRev[l]:i.type=l,i.detail={},r[l]._id&&(i._id=r[l]._id),r[l].amountLimit&&(i.amountLimit=r[l].amountLimit),r[l].celling&&(i.celling=parseInt(r[l].celling)/100,r[l].firstLimit?i.firstLimit=!0:i.firstLimit=!1),"CHARGE_CONSUME"==i.type&&(r[l].allpurpose?i.allpurpose=!0:i.allpurpose=!1),"number"==typeof r[l].countLimit&&(i.countLimit=r[l].countLimit),r[l].timesLimit&&(i.timesLimit=r[l].timesLimit),r[l].obtainCategory&&(i.obtainCategory=r[l].obtainCategory);var d,c=r[l].detail,u=l.split("_");u&&u.length>1&&(d=u[1]);for(z in c)for(w in c[z]){var p=c[z][w],m={};if(("number"==typeof p.amount||p.amount)&&(m.amount=p.amount),p.score&&(m.score=p.score),p.gradeId&&(m.gradeId=p.gradeId),p.value&&0!=p.value.length){if(m.value=p.value,m.value&&m.value.length)for(var l in m.value)delete m.value[l].$$hashKey}else"CHARGE_CONSUME"==i.type&&(m.value=!1);void 0!==p.limit&&(m.limit=p.limit),p.count&&(m.count=p.count),p.currentAmount&&(m.currentAmount=p.currentAmount),i.detail[p.id]?i.detail[p.id].push(m):i.detail[p.id]=[m]}if("CHARGE"==i.type&&angular.forEach(i.detail.ALL,function(e,t){e.value&&e.value[0].category||delete e.value}),n&&"function"==typeof n&&(obj=n(d,i),obj))return alert(obj.message),!1;s&&"function"==typeof s&&s(i)}if("TICKET"==e.tem.activityCategory){if(!e.tel.inviters)return void alert("请输入邀请码");i.inviters=e.tel.inviters.split(",")}var v=ajaxSendFn(i,"/activity/"+a.activityid+"/rule","POST",1);return 200!=v.code?(errorMsg(v),!1):(e.ruleFn.oldRuleFn(),!0)},addRuleFn:function(){e.view.modal={title:"添加活动内容",html:"addrule"},$("#showadd").modal("show")},put:function(e,t){e.value||(e.value={}),t={},e.value.push(t)},resetCouponCntFn:function(e,t){angular.forEach(e.value,function(e,a){e&&e.id===t.id&&this.splice(a,1)},e.value)},containsCoupon:function(e,t){for(var a=-1,o=0;e.value&&o<e.value.length;o++)if(e.value[o].id===t){a=o;break}return a}},e.ruleFn.oldRuleFn(),e.sendJsons=function(){if(console.log(e.posts),!e.posts.picUrl)return void alert("请先上传图片");e.posts.shops=e.set.shops.filter(function(e){return e&&e.trim()});var t=angular.copy(e.posts);delete t.CHARGE,t.rule={},t.rule.detail=angular.copy(e.posts.CHARGE.CHARGE.detail);for(var a=0;a<e.posts.CHARGE.CHARGE.detail.ALL.length;a++){var s=e.posts.CHARGE.CHARGE.detail.ALL[a].allocates;t.rule.detail.ALL[a].allocates=[];for(var r=0;r<s.length;r++)s[r].id&&t.rule.detail.ALL[a].allocates.push(s[r])}if(console.log(t),t.dateRange={},t.dateRangeCategory=e.view.date.dateType,"CONTINUOUS"===e.view.date.dateType){if(!e.view.dateRange.startDate||!e.view.dateRange.endDate)return void alert("请填写开始和结束日期!");if(e.view.dateRange.endDate<e.view.dateRange.startDate)return void alert("结束日期不能小于开始日期!");t.dateRange.startDate=o("date")(e.view.dateRange.startDate,"yyyy-MM-dd 00:00:00"),t.dateRange.endDate=o("date")(e.view.dateRange.endDate,"yyyy-MM-dd 23:59:59")}else"BIRTHDAY"===e.view.date.dateType&&"AROUND_FIX_DATE"===e.view.date.subType&&(t.dateRange.beforeDays=e.view.dateRange.beforeDays||0,t.dateRange.afterDays=e.view.dateRange.afterDays||0);if(t.dateRange.selectCategory=e.view.dateRange.selectCategory||"NONE","MANUAL_SELECT"===e.view.dateRange.subType){var i=arrayMap(objectKeys(e.view.dateRange.selectDates),function(e){return e+" 00:00:00"});isEmptyObject(i)||(t.dateRange.selectDates=i)}else if("MONTH_DAYS"===e.view.dateRange.subType){var i=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectDays,notNull)),parseInt);isEmptyObject(i)||(t.dateRange.selectDays=i)}else if("WEEKLY_DAY"===e.view.dateRange.subType){var i=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectWeekDays,notNull)),parseInt);isEmptyObject(i)||(t.dateRange.selectWeekDays=i)}if("SELECTED_DATES"!==t.dateRangeCategory&&"EXCLUDE"===t.dateRange.selectCategory&&1==objectCount(t.dateRange))return void alert("没有指定排除日期！");if("SELECTED_DATES"===t.dateRangeCategory&&1==objectCount(t.dateRange))return void alert("没有指定日期！");t.advertisement&&!t.advertisement.id&&delete t.advertisement,console.log(t);var l="/activity/commision",d=ajaxSendFn(t,l,"POST");200==d.code?(alert("操作成功"),n.path("/rule/addcommission")):alert(d.message)},e.ruleFn.postFn("CHARGE"),e.tem&&e.tem.activityCategory&&isEmptyObject(e.tem.rules)&&e.ruleFn.stateFn(e.tem.activityCategory,"add",1),e.checkAllShops=function(){if(console.log(e.posts.allShop),e.posts.allShop){for(var t=[],a=0;a<e.set.list.length;a++)t.push(e.set.list[a].id);e.set.shops=t}else e.set.shops=[],e.posts.shops=[]},e.checkShops=function(t){0==t&&(delete t,e.posts.allShop=!1);var a=e.set.shops.filter(function(e){return e&&e.trim()});a.length==e.set.list.length?e.posts.allShop=!0:e.posts.allShop=!1}}]),app.controller("editcommissionCtr",["$scope","$http","$routeParams","$filter","$location","CouponFactory",function(e,t,a,o,n,s){e.config.breadset=[{name:"返佣管理",href:indexUrl+"/admin.html#/rule/editcommission",class:"editcommission"},{name:"返佣管理"}],e.view={category:[]},e.view1={},e.transferMap={POINT_CONSUME:"POINTCONSUME",COUPON_FREE:"COUPONFREE",CHARGE_CONSUME:"CHARGECONSUME",SPECIAL_PRICE:"SPECIALPRICE",LIMIT_REDUCE:"LIMITREDUCE",SPEND_AS:"SPENDAS",SET_MEAL:"SETMEAL",GIVEN_UPGRADE:"GIVENUPGRADE",CHARGE_FREE:"CHARGEFREE",BIRTH_BENEFIT:"BIRTHBENEFIT",FIRST_GIFT:"FIRSTGIFT"},e.transferMapRev={POINTCONSUME:"POINT_CONSUME",COUPONFREE:"COUPON_FREE",CHARGECONSUME:"CHARGE_CONSUME",SPECIALPRICE:"SPECIAL_PRICE",LIMITREDUCE:"LIMIT_REDUCE",SPENDAS:"SPEND_AS",SETMEAL:"SET_MEAL",GIVENUPGRADE:"GIVEN_UPGRADE",CHARGEFREE:"CHARGE_FREE",BIRTHBENEFIT:"BIRTH_BENEFIT",FIRSTGIFT:"FIRST_GIFT"},e.tem={rules:{}},e.allShop=!1,e.set={times:ajaxSendFn({},"/businesstimes/all","GET").result,list:ajaxSendFn({state:1002},"/shops","GET").result,allocate:ajaxSendFn({},"/activity/allocate/8003","GET").result||[],allocates:[],shops:[]},console.log(e.set.times),e.set.list||(alert("目前还没有添加门店"),n.path("/shops")),e.set.nonParticipation=ajaxSendFn({},"/nonParticipation/content","GET").result,e.checkallstr=0,e.posts={shops:[],rule:{detail:[]},allDay:!1},e.coupon={shared:[],shops:[]},e.temcoupons2={},e.temcoupons=[],e.ruleCategory=consumeRuleObj,e.ruleCategory1=onlineRuleObj,e.obtainRepeatCategory=obtainRepeatCategory,e.ruleFn={getCpouponFn:function(){console.log(e.view),e.view1=ajaxSendFn({},"/activity/factor","GET").result||[],e.view.coupons=e.view1.COUPON||[],e.view.rewards=e.view1.REWARD||[],console.log("1111"),console.log(e.view)},getCouponType:function(t){for(var a=0;e.view.coupons&&a<e.view.coupons.length;a++)if(e.view.coupons[a].id===t)return e.view.coupons[a].category},changeCoupon:function(t,a){if(a.id){a.count=1;for(var o=0;o<e.view.coupons.length;o++)if(e.view.coupons[o].id===a.id){a.name=e.view.coupons[o].name;break}}},oldRuleFn:function(){e.ruleFn.getCpouponFn(),e.view.rules={name:"充值",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addCouponFn,postFunc:e.ruleFn.sendCouponFn,content:{CHARGE:[]}},console.log("222222"),console.log(e.view.rules),e.view.shop=ajaxSendFn({state:"1002"},"/shops","GET").result||[],e.tem.shops=[];for(var t in e.view.shop)e.tem.shops.push(e.view.shop[t].id)},closeFn:function(t){"edit"==e.view.rules[t].state?e.view.rules[t].state="show":"add"==e.view.rules[t].state&&(e.view.rules[t].state="show")},postFn:function(){var t=e.view.rules.content;console.log(t),e.ruleFn.addCouponFn()},addCouponFn:function(){var t={};t.value={},t.allocates=[];for(var a=0;a<e.set.list.length;a++)t.allocates[a]={highest:"false",id:""};e.posts.rule.detail&&e.posts.rule.detail.ALL?e.posts.rule.detail.ALL.push(t):e.posts.rule.detail={ALL:[t]}},removeFn:function(t,a,o){e.posts.rule.detail[a][o]&&e.posts.rule.detail[a].splice(o,1)},sendChargeConsumeFn:function(t){return e.ruleFn.sendFn(t,void 0,void 0,function(e){var t=e.detail.ALL[0];t.amount=1,t.currentAmount=t.count=0})},sendFn:function(t,o,n,s){var r=e.posts[t],i={};for(var l in r)if(e.view.rules[t].uncheck||r[l].check){e.transferMapRev.hasOwnProperty(l)?i.type=e.transferMapRev[l]:i.type=l,i.detail={},r[l]._id&&(i._id=r[l]._id),r[l].amountLimit&&(i.amountLimit=r[l].amountLimit),r[l].celling&&(i.celling=parseInt(r[l].celling)/100,r[l].firstLimit?i.firstLimit=!0:i.firstLimit=!1),"CHARGE_CONSUME"==i.type&&(r[l].allpurpose?i.allpurpose=!0:i.allpurpose=!1),"number"==typeof r[l].countLimit&&(i.countLimit=r[l].countLimit),r[l].timesLimit&&(i.timesLimit=r[l].timesLimit),r[l].obtainCategory&&(i.obtainCategory=r[l].obtainCategory);var d,c=r[l].detail,u=l.split("_");u&&u.length>1&&(d=u[1]);for(z in c)for(w in c[z]){var p=c[z][w],m={};if(("number"==typeof p.amount||p.amount)&&(m.amount=p.amount),p.score&&(m.score=p.score),p.gradeId&&(m.gradeId=p.gradeId),p.value&&0!=p.value.length){if(m.value=p.value,m.value&&m.value.length)for(var l in m.value)delete m.value[l].$$hashKey}else"CHARGE_CONSUME"==i.type&&(m.value=!1);void 0!==p.limit&&(m.limit=p.limit),p.count&&(m.count=p.count),p.currentAmount&&(m.currentAmount=p.currentAmount),i.detail[p.id]?i.detail[p.id].push(m):i.detail[p.id]=[m]}if("CHARGE"==i.type&&angular.forEach(i.detail.ALL,function(e,t){e.value&&e.value[0].category||delete e.value}),n&&"function"==typeof n&&(obj=n(d,i),obj))return alert(obj.message),!1;s&&"function"==typeof s&&s(i)}if("TICKET"==e.tem.activityCategory){if(!e.tel.inviters)return void alert("请输入邀请码");i.inviters=e.tel.inviters.split(",")}var v=ajaxSendFn(i,"/activity/"+a.activityid+"/rule","POST",1);return 200!=v.code?(errorMsg(v),!1):(e.ruleFn.oldRuleFn(),!0)},addRuleFn:function(){e.view.modal={title:"添加活动内容",html:"addrule"},$("#showadd").modal("show")},put:function(e,t){e.value||(e.value={}),t={},e.value.push(t)},resetCouponCntFn:function(e,t){angular.forEach(e.value,function(e,a){e&&e.id===t.id&&this.splice(a,1)},e.value)},containsCoupon:function(e,t){for(var a=-1,o=0;e.value&&o<e.value.length;o++)if(e.value[o].id===t){a=o;break}return a}},e.ruleFn.oldRuleFn(),e.ruleFn.postFn("CHARGE"),e.cbdata=ajaxSendFn({},"/activity/commision/"+a.id,"GET").result,e.posts=angular.copy(e.cbdata),delete e.posts.createTime,delete e.posts.id,delete e.posts.offTime,delete e.posts.onTime,delete e.posts.dateRange,delete e.posts.text,delete e.posts.rule.detail.ALL.text;for(var r=0;r<e.set.list.length;r++)for(var i=0;i<e.posts.shops.length;i++)e.set.list[r].id==e.posts.shops[i]&&(e.set.shops[r]=e.posts.shops[i]);for(var r=0;r<e.cbdata.rule.detail.ALL.length;r++){for(var l=e.cbdata.rule.detail.ALL[r].allocates,d=[],i=0;i<l.length;i++)for(var c=0;c<e.set.allocate.length;c++)l[i].id==e.set.allocate[c].id&&(d[c]={},d[c].id=l[i].id,0==l[i].highest?d[c].highest="false":d[c].highest="true");for(var i=0;i<d.length;i++)null==d[i]&&(d[i]={});e.posts.rule.detail.ALL[r].allocates=d}console.log("$scope.posts"),console.log(e.posts),e.view.date={},e.view.dateRange=e.cbdata.dateRange;var u=e.posts.dateRangeCategory;e.view.date[u]=e.cbdata.dateRange,e.view.date.dateType=u,console.log(e.view),e.sendJsons=function(){if(console.log(e.posts),!e.posts.picUrl)return void alert("请先上传图片");e.posts.shops=e.set.shops.filter(function(e){return e&&e.trim()});var t=angular.copy(e.posts);delete t.CHARGE,t.rule={},t.rule.detail=angular.copy(e.posts.rule.detail);for(var n=0;n<e.posts.rule.detail.ALL.length;n++){delete t.rule.detail.ALL[n].text;for(var s=0;s<t.rule.detail.ALL[n].allocates.length;s++)"false"!=t.rule.detail.ALL[n].allocates[s].id&&""!=t.rule.detail.ALL[n].allocates[s].id||t.rule.detail.ALL[n].allocates.splice(s,1)}if(console.log(t),t.dateRange={},t.dateRangeCategory=e.view.date.dateType,"CONTINUOUS"===e.view.date.dateType){if(!e.view.dateRange.startDate||!e.view.dateRange.endDate)return void alert("请填写开始和结束日期!");if(e.view.dateRange.endDate<e.view.dateRange.startDate)return void alert("结束日期不能小于开始日期!");t.dateRange.startDate=o("date")(e.view.dateRange.startDate,"yyyy-MM-dd 00:00:00"),t.dateRange.endDate=o("date")(e.view.dateRange.endDate,"yyyy-MM-dd 23:59:59")}else"BIRTHDAY"===e.view.date.dateType&&"AROUND_FIX_DATE"===e.view.date.subType&&(t.dateRange.beforeDays=e.view.dateRange.beforeDays||0,t.dateRange.afterDays=e.view.dateRange.afterDays||0);if(t.dateRange.selectCategory=e.view.dateRange.selectCategory||"NONE","MANUAL_SELECT"===e.view.dateRange.subType){var r=arrayMap(objectKeys(e.view.dateRange.selectDates),function(e){return e+" 00:00:00"});isEmptyObject(r)||(t.dateRange.selectDates=r)}else if("MONTH_DAYS"===e.view.dateRange.subType){var r=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectDays,notNull)),parseInt);isEmptyObject(r)||(t.dateRange.selectDays=r)}else if("WEEKLY_DAY"===e.view.dateRange.subType){var r=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectWeekDays,notNull)),parseInt);isEmptyObject(r)||(t.dateRange.selectWeekDays=r)}if("SELECTED_DATES"!==t.dateRangeCategory&&"EXCLUDE"===t.dateRange.selectCategory&&1==objectCount(t.dateRange))return void alert("没有指定排除日期！");if("SELECTED_DATES"===t.dateRangeCategory&&1==objectCount(t.dateRange))return void alert("没有指定日期！");t.advertisement&&!t.advertisement.id&&delete t.advertisement,console.log(t);var i="/activity/commision/"+a.id,l=ajaxSendFn(t,i,"POST");200==l.code?alert("操作成功"):alert(l.message)},e.tem&&e.tem.activityCategory&&isEmptyObject(e.tem.rules)&&e.ruleFn.stateFn(e.tem.activityCategory,"add",1),e.checkAllShops=function(){if(console.log(e.posts.allShop),e.posts.allShop){for(var t=[],a=0;a<e.set.list.length;a++)t.push(e.set.list[a].id);e.set.shops=t}else e.set.shops=[],e.posts.shops=[]},e.checkShops=function(t){0==t&&(delete t,e.posts.allShop=!1);var a=e.set.shops.filter(function(e){return e&&e.trim()});a.length==e.set.list.length?e.posts.allShop=!0:e.posts.allShop=!1}}]),app.controller("videoCtr",["$scope","$sce","$location","$http",function(e,t,a,o){e.config.breadset=[{name:"视频管理",href:indexUrl+"/admin.html#/rule/video",class:"video"},{name:"视频列表"}],e.post={},e.posts={materials:[]},e.view={materials:ajaxSendFn({},"/videos","GET").result||[],groups:ajaxSendFn({},"/videos/group","GET").result||[],leftIndex:-2},e.videoUrlFun=function(e){var a=t.trustAsResourceUrl(e);return a},e.submitFn=function(){var t=ajaxSendFn({name:e.post.name},"/videos/group","POST");200===t.code?(e.view.groups=ajaxSendFn({},"/videos/group","GET").result,e.view.checkName=!1):alert(t.message)},e.closepop=function(){e.add=!1},e.groupList=function(t){url="/videos",t>=0&&(url="/videos/group/"+e.view.groups[t].id+"/videos"),t==-1&&(url="/videos/group/videos"),e.view.materials=ajaxSendFn({},url,"GET").result,e.view.leftIndex=t},e.separateGroup=function(t,a){var o=ajaxSendFn({ids:a},"/videos/group/"+e.view.groups[t].id+"/videos","PUT");200===o.code?alert("操作成功"):alert(o.message)},e.pageChange=function(){url="/videos",e.view.leftIndex>=0&&(url="/videos/group/"+e.view.groups[e.view.leftIndex].id+"/videos"),e.view.leftIndex==-1&&(url="/videos/group/videos");var t={page:e.view.materials.page,count:e.view.materials.count};e.view.materials=ajaxSendFn(t,url,"GET").result},e.temimgshow=function(t){console.log("点击");var a=document.getElementById("videoform"),o=new FormData(a);o.append("cover",e.picUrl),o.append("title",e.title),o.append("description",e.description);var n="/videos";e.view.leftIndex>=0&&(n="/videos/group/"+e.view.groups[e.view.leftIndex].id+"/video"),POSTurl=basicUrl+n+"?",options={url:POSTurl+sortUrl(),type:"POST",success:function(t){200===t.code?(alert("操作成功"),e.add=!1,e.$apply(function(){n="/videos",e.view.leftIndex>=0&&(n="/videos/group/"+e.view.groups[e.view.leftIndex].id+"/videos"),e.view.leftIndex==-1&&(n="/videos/group/videos"),e.view.materials=ajaxSendFn({count:10},n,"GET").result})):alert(t.message)}},$("#videoform").ajaxSubmit(options)},e.remove=function(t){if(!confirm("一旦删除将不可恢复，是否确认删除？"))return!1;var a=ajaxSendFn({},"/videos/"+e.view.materials.items[t].id,"DELETE");200==a.code?e.view.materials.items.splice(t,1):alert(a.message)},e.removeAll=function(){if(!e.posts.dishes.length)return void alert("请先选择要删除的图片！");if(!confirm("一旦删除将不可恢复，是否确认删除？"))return!1;var t=ajaxSendFn(e.posts.dishes,"/dishes/ids","DELETE");200==t.code?(e.post={},e.view.materials=ajaxSendFn({},"/material","GET").result):alert(t.message)},e.checkAllDishes=function(){e.materialAll?e.posts.materials=[]:angular.forEach(e.view.materials.items,function(e,t){this[t]=e.id},e.post)}}]),app.controller("referralCtr",["$scope","$http","$filter","$document","$compile","$rootScope",function(e,t,a,o,n,s){e.config.breadset=[{name:"转介绍管理",href:indexUrl+"/admin.html#/rule/referral",class:"referral"},{name:"转介绍管理"}],e.view={list:ajaxSendFn({},"/activity/saler","GET").result||[]},e.offFn=function(t){var a=confirm("确认下线此活动？");if(a){var o=ajaxSendFn({},"/activity/saler/"+t+"/off","POST");200==o.code?e.view.list=ajaxSendFn({},"/activity/saler","GET").result||[]:alert(o.message)}},e.onFn=function(t){var a=confirm("确认上线此活动？");if(a){var o=ajaxSendFn({},"/activity/saler/"+t+"/on","POST");200==o.code?e.view.list=ajaxSendFn({},"/activity/saler","GET").result||[]:alert(o.message)}},e.removeFn=function(t){var a=confirm("确认删除？");if(a){var o=ajaxSendFn({},"/activity/saler/"+t,"DELETE");200==o.code?e.view.list=ajaxSendFn({},"/activity/saler","GET").result||[]:alert(o.message)}}}]),app.controller("addreferralCtr",["$scope","$http","$routeParams","$filter","$location","CouponFactory",function(e,t,a,o,n,s){e.config.breadset=[{name:"转介绍管理",href:indexUrl+"/admin.html#/rule/addreferral",class:"addreferral"},{name:"转介绍管理"}],e.view={category:[]},e.view1={},e.transferMap={POINT_CONSUME:"POINTCONSUME",COUPON_FREE:"COUPONFREE",CHARGE_CONSUME:"CHARGECONSUME",SPECIAL_PRICE:"SPECIALPRICE",LIMIT_REDUCE:"LIMITREDUCE",SPEND_AS:"SPENDAS",SET_MEAL:"SETMEAL",GIVEN_UPGRADE:"GIVENUPGRADE",CHARGE_FREE:"CHARGEFREE",BIRTH_BENEFIT:"BIRTHBENEFIT",FIRST_GIFT:"FIRSTGIFT"},e.transferMapRev={POINTCONSUME:"POINT_CONSUME",COUPONFREE:"COUPON_FREE",CHARGECONSUME:"CHARGE_CONSUME",SPECIALPRICE:"SPECIAL_PRICE",LIMITREDUCE:"LIMIT_REDUCE",SPENDAS:"SPEND_AS",SETMEAL:"SET_MEAL",GIVENUPGRADE:"GIVEN_UPGRADE",CHARGEFREE:"CHARGE_FREE",BIRTHBENEFIT:"BIRTH_BENEFIT",FIRSTGIFT:"FIRST_GIFT"},e.tem={rules:{}},e.allShop=!1,e.set={times:ajaxSendFn({},"/businesstimes/all","GET").result,list:ajaxSendFn({state:1002},"/shops","GET").result,allocate:ajaxSendFn({},"/activity/allocate/8003","GET").result||[],allocates:[],packet:ajaxSendFn({},"/activity/packet/usable","GET").result||[],commision:ajaxSendFn({},"/activity/commision/usable","GET").result||[],list2:[],timeType:{1001:"早市",1002:"午市",1003:"下午茶",1004:"晚市",1005:"宵夜"},shops:[],personLimitDetail:[{amount:"",count:""}]},console.log(e.set.packet),console.log(e.set.commision),e.set.time=getSubtimes(e.set.times,e.set.timeType),e.set.list||(alert("目前还没有添加门店"),n.path("/shops")),e.checkallstr=0,e.posts={shops:[],video:{},packetActId:""},e.coupon={shared:[],shops:[]},e.cons=function(e){console.log("highest"),console.log(e)},console.log(e.vidUrl),e.temcoupons2={},e.temcoupons=[],e.ruleCategory=consumeRuleObj,e.ruleCategory1=onlineRuleObj,e.obtainRepeatCategory=obtainRepeatCategory,e.ruleFn={openOrClose:function(){$("#add").modal("show"),e.isOpenOrClose=!0},testAddOk:function(){$("#add").modal("hide"),e.isOpenOrClose=!1,alert("添加成功")},testAddFail:function(e){errorMsg(e)},getCpouponFn:function(){console.log(e.view),e.view1=ajaxSendFn({},"/activity/factor","GET").result||[],e.view.coupons=e.view1.COUPON||[],e.view.rewards=e.view1.REWARD||[],console.log("1111"),console.log(e.view)},getCouponType:function(t){for(var a=0;e.view.coupons&&a<e.view.coupons.length;a++)if(e.view.coupons[a].id===t)return e.view.coupons[a].category},changeCoupon:function(t,a){if(a.id){a.count=1;for(var o=0;o<e.view.coupons.length;o++)if(e.view.coupons[o].id===a.id){a.name=e.view.coupons[o].name;break}}},oldRuleFn:function(){e.ruleFn.getCpouponFn(),e.view.rules={CHARGE:{name:"充值",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addCouponFn,postFunc:e.ruleFn.sendCouponFn,content:{CHARGE:[]}}},console.log("222222"),console.log(e.view.rules),e.view.shop=ajaxSendFn({state:"1002"},"/shops","GET").result||[],e.tem.shops=[];for(var t in e.view.shop)e.tem.shops.push(e.view.shop[t].id);e.tem.rules={},e.tem.rules[e.tem.rules.type]=e.tem.rules},stateFn:function(t,a,o,n){var s=t.split("_")[0];if(s in e.view.rules&&(e.view.rules[s].state=a,e.view.rules[s].show=o),"add"==a&&e.ruleFn.buttonFn(t),!n)return void(e.btnDisable=1);var r=n.type;o&&(n.celling&&(n.celling=100*n.celling),e.view.rules[s].content[r]=n)},closeFn:function(t){"edit"==e.view.rules[t].state?e.view.rules[t].state="show":"add"==e.view.rules[t].state&&(e.view.rules[t].state="show")},buttonFn:function(t){if("show"==e.view.rules[t].state)e.ruleFn.postFn(t),e.ruleFn.memberFn(),e.view.rules[t].state="edit";else if("edit"==e.view.rules[t].state){var a=e.ruleFn.sendCouponFn();a&&(e.view.rules[t].state="show")}else if("add"==e.view.rules[t].state){for(x in e.view.rules[t].content)e.view.rules[t].addFunc(x);e.view.rules[t].state="edit",$("#showadd").modal("hide")}},postFn:function(t){var a=e.view.rules[t].content;console.log(a),e.posts[t]={};for(x in a){var o=!0;e.posts[t][x]=a[x],a[x]instanceof Array&&(o=!1),e.posts[t][x].check=o,a[x].detail&&Object.keys(a[x].detail).length||e.view.rules[t].addFunc(x)}},addCouponFn:function(t){e.ruleFn.addFn(t,function(a,o){if(void 0!=e.posts[a][t].detail)if(void 0!=e.posts[a][t].detail.ALL)var n=e.posts[a][t].detail.ALL;else e.posts[a][t].detail.ALL=[];else e.posts[a][t].detail={},e.posts[a][t].detail.ALL=[];if(n&&n.length>0&&!isEmptyObject(n[0])){var s={};s.value={},s.allocates=[];for(var r=0;r<e.set.list.length;r++)s.allocates[r]={highest:"false",id:""};e.posts[a][t].detail.ALL.push(s),console.log("obj1"),console.log(s)}else{var s={};s.value={},s.allocates=[];for(var r=0;r<e.set.list.length;r++)s.allocates[r]={highest:"false",id:""};e.posts[a][t].detail.ALL.push(s),console.log("obj2"),console.log(s)}console.log("$$hashKey"),console.log(e.posts[a][t].detail.ALL)})},addFn:function(t,a){var o,n,s=t.split("_");return s&&s.length>0&&(o=s[0]),s&&s.length>1&&(n=s[1]),e.posts[o]&&e.posts[o][t]&&e.posts[o][t].detail&&!isEmptyObject(e.posts[o][t].detail)?(e.posts[o][t].detail.ALL?a&&a(o,n):a&&a(o,n),console.log("$$hashKey"),void console.log(e.posts[o][t].detail.ALL)):(e.posts[o]||(e.posts[o]={}),e.posts[o][t]=e.view.rules[o].content[t],void(a&&a(o,n)))},removeFn:function(t,a,o){var n=t.split("_")[0];e.posts[n][t].detail[a][o]&&e.posts[n][t].detail[a].splice(o,1)},sendChargeConsumeFn:function(t){return e.ruleFn.sendFn(t,void 0,void 0,function(e){var t=e.detail.ALL[0];t.amount=1,t.currentAmount=t.count=0})},sendFn:function(t,o,n,s){var r=e.posts[t],i={};for(var l in r)if(e.view.rules[t].uncheck||r[l].check){e.transferMapRev.hasOwnProperty(l)?i.type=e.transferMapRev[l]:i.type=l,i.detail={},r[l]._id&&(i._id=r[l]._id),r[l].amountLimit&&(i.amountLimit=r[l].amountLimit),r[l].celling&&(i.celling=parseInt(r[l].celling)/100,r[l].firstLimit?i.firstLimit=!0:i.firstLimit=!1),"CHARGE_CONSUME"==i.type&&(r[l].allpurpose?i.allpurpose=!0:i.allpurpose=!1),"number"==typeof r[l].countLimit&&(i.countLimit=r[l].countLimit),r[l].timesLimit&&(i.timesLimit=r[l].timesLimit),r[l].obtainCategory&&(i.obtainCategory=r[l].obtainCategory);var d,c=r[l].detail,u=l.split("_");u&&u.length>1&&(d=u[1]);for(z in c)for(w in c[z]){var p=c[z][w],m={};if(("number"==typeof p.amount||p.amount)&&(m.amount=p.amount),p.score&&(m.score=p.score),p.gradeId&&(m.gradeId=p.gradeId),p.value&&0!=p.value.length){if(m.value=p.value,m.value&&m.value.length)for(var l in m.value)delete m.value[l].$$hashKey}else"CHARGE_CONSUME"==i.type&&(m.value=!1);void 0!==p.limit&&(m.limit=p.limit),p.count&&(m.count=p.count),p.currentAmount&&(m.currentAmount=p.currentAmount),i.detail[p.id]?i.detail[p.id].push(m):i.detail[p.id]=[m]}if("CHARGE"==i.type&&angular.forEach(i.detail.ALL,function(e,t){e.value&&e.value[0].category||delete e.value}),n&&"function"==typeof n&&(obj=n(d,i),obj))return alert(obj.message),!1;s&&"function"==typeof s&&s(i)}if("TICKET"==e.tem.activityCategory){if(!e.tel.inviters)return void alert("请输入邀请码");i.inviters=e.tel.inviters.split(",")}var v=ajaxSendFn(i,"/activity/"+a.activityid+"/rule","POST",1);return 200!=v.code?(errorMsg(v),!1):(e.ruleFn.oldRuleFn(),!0)},addRuleFn:function(){e.view.modal={title:"添加活动内容",html:"addrule"},$("#showadd").modal("show")},put:function(e,t){e.value||(e.value={}),t={},e.value.push(t)},resetCouponCntFn:function(e,t){angular.forEach(e.value,function(e,a){e&&e.id===t.id&&this.splice(a,1)},e.value)},containsCoupon:function(e,t){for(var a=-1,o=0;e.value&&o<e.value.length;o++)if(e.value[o].id===t){a=o;break}return a}},e.addPepFn=function(){e.set.personLimitDetail&&e.set.personLimitDetail.push({amount:"",count:""})},e.removePepFn=function(t){e.set.personLimitDetail[t]&&e.set.personLimitDetail.splice(t,1)},e.ruleFn.oldRuleFn(),e.sendJsons=function(){if(console.log(e.posts),!e.posts.picUrl)return void alert("请先上传图片");e.posts.shops=e.set.shops.filter(function(e){return e&&e.trim()});var t=angular.copy(e.posts);delete t.CHARGE,t.rule={},t.rule.expiredLimit=e.set.expiredLimit,t.rule.personLimit=e.set.personLimit,t.rule.timesLimit=e.set.timesLimit,t.rule.distanceLimit=e.set.distanceLimit,t.rule.allpurpose=e.set.allpurpose,t.rule.personLimitDetail=angular.copy(e.set.personLimitDetail),t.rule.detail=angular.copy(e.posts.CHARGE.CHARGE.detail);for(var a=0;a<e.posts.CHARGE.CHARGE.detail.ALL.length;a++){var s=e.posts.CHARGE.CHARGE.detail.ALL[a].allocates;t.rule.detail.ALL[a].allocates=[];for(var r=0;r<s.length;r++)s[r].id&&t.rule.detail.ALL[a].allocates.push(s[r])}if(console.log(t),t.dateRange={},t.dateRangeCategory=e.view.date.dateType,"CONTINUOUS"===e.view.date.dateType){if(!e.view.dateRange.startDate||!e.view.dateRange.endDate)return void alert("请填写开始和结束日期!");if(e.view.dateRange.endDate<e.view.dateRange.startDate)return void alert("结束日期不能小于开始日期!");t.dateRange.startDate=o("date")(e.view.dateRange.startDate,"yyyy-MM-dd 00:00:00"),t.dateRange.endDate=o("date")(e.view.dateRange.endDate,"yyyy-MM-dd 23:59:59")}else"BIRTHDAY"===e.view.date.dateType&&"AROUND_FIX_DATE"===e.view.date.subType&&(t.dateRange.beforeDays=e.view.dateRange.beforeDays||0,t.dateRange.afterDays=e.view.dateRange.afterDays||0);if(t.dateRange.selectCategory=e.view.dateRange.selectCategory||"NONE","MANUAL_SELECT"===e.view.dateRange.subType){var i=arrayMap(objectKeys(e.view.dateRange.selectDates),function(e){return e+" 00:00:00"});isEmptyObject(i)||(t.dateRange.selectDates=i)}else if("MONTH_DAYS"===e.view.dateRange.subType){var i=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectDays,notNull)),parseInt);isEmptyObject(i)||(t.dateRange.selectDays=i)}else if("WEEKLY_DAY"===e.view.dateRange.subType){var i=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectWeekDays,notNull)),parseInt);isEmptyObject(i)||(t.dateRange.selectWeekDays=i)}if("SELECTED_DATES"!==t.dateRangeCategory&&"EXCLUDE"===t.dateRange.selectCategory&&1==objectCount(t.dateRange))return void alert("没有指定排除日期！");if("SELECTED_DATES"===t.dateRangeCategory&&1==objectCount(t.dateRange))return void alert("没有指定日期！");t.advertisement&&!t.advertisement.id&&delete t.advertisement,console.log(t);var l="/activity/saler",d=ajaxSendFn(t,l,"POST");200==d.code?(alert("操作成功"),n.path("/rule/addcommission")):alert(d.message)},e.ruleFn.postFn("CHARGE"),e.tem&&e.tem.activityCategory&&isEmptyObject(e.tem.rules)&&e.ruleFn.stateFn(e.tem.activityCategory,"add",1),e.checkAllShops=function(){if(console.log(e.posts.allShop),e.posts.allShop){for(var t=[],a=0;a<e.set.list.length;a++)t.push(e.set.list[a].id);e.set.shops=t}else e.set.shops=[],e.posts.shops=[]},e.checkShops=function(t){0==t&&(delete t,e.posts.allShop=!1);var a=e.set.shops.filter(function(e){return e&&e.trim()});a.length==e.set.list.length?e.posts.allShop=!0:e.posts.allShop=!1}}]),app.controller("editreferralCtr",["$scope","$http","$routeParams","$filter","$location","CouponFactory",function(e,t,a,o,n,s){e.config.breadset=[{name:"转介绍管理",href:indexUrl+"/admin.html#/rule/editreferral",class:"editreferral"},{name:"转介绍管理"}],e.view={category:[]},e.view1={},e.transferMap={POINT_CONSUME:"POINTCONSUME",COUPON_FREE:"COUPONFREE",CHARGE_CONSUME:"CHARGECONSUME",SPECIAL_PRICE:"SPECIALPRICE",LIMIT_REDUCE:"LIMITREDUCE",SPEND_AS:"SPENDAS",SET_MEAL:"SETMEAL",GIVEN_UPGRADE:"GIVENUPGRADE",CHARGE_FREE:"CHARGEFREE",BIRTH_BENEFIT:"BIRTHBENEFIT",FIRST_GIFT:"FIRSTGIFT"},e.transferMapRev={POINTCONSUME:"POINT_CONSUME",COUPONFREE:"COUPON_FREE",CHARGECONSUME:"CHARGE_CONSUME",SPECIALPRICE:"SPECIAL_PRICE",LIMITREDUCE:"LIMIT_REDUCE",SPENDAS:"SPEND_AS",SETMEAL:"SET_MEAL",GIVENUPGRADE:"GIVEN_UPGRADE",CHARGEFREE:"CHARGE_FREE",BIRTHBENEFIT:"BIRTH_BENEFIT",FIRSTGIFT:"FIRST_GIFT"},e.tem={rules:{}},e.allShop=!1,e.set={times:ajaxSendFn({},"/businesstimes/all","GET").result,list:ajaxSendFn({state:1002},"/shops","GET").result,allocate:ajaxSendFn({},"/activity/allocate/8003","GET").result||[],packet:ajaxSendFn({},"/activity/packet/usable","GET").result||[],commision:ajaxSendFn({},"/activity/commision/usable","GET").result||[],allocates:[],shops:[],personLimitDetail:[{amount:"",count:""}]},console.log(e.set.times),e.set.list||(alert("目前还没有添加门店"),n.path("/shops")),e.checkallstr=0,e.posts={shops:[],rule:{detail:[]},video:{},packetActId:""},e.coupon={shared:[],shops:[]},e.temcoupons2={},e.temcoupons=[],e.ruleCategory=consumeRuleObj,e.ruleCategory1=onlineRuleObj,e.obtainRepeatCategory=obtainRepeatCategory,e.ruleFn={getCpouponFn:function(){console.log(e.view),e.view1=ajaxSendFn({},"/activity/factor","GET").result||[],e.view.coupons=e.view1.COUPON||[],e.view.rewards=e.view1.REWARD||[],console.log("1111"),console.log(e.view)},getCouponType:function(t){for(var a=0;e.view.coupons&&a<e.view.coupons.length;a++)if(e.view.coupons[a].id===t)return e.view.coupons[a].category},changeCoupon:function(t,a){if(a.id){a.count=1;for(var o=0;o<e.view.coupons.length;o++)if(e.view.coupons[o].id===a.id){a.name=e.view.coupons[o].name;break}}},oldRuleFn:function(){e.ruleFn.getCpouponFn(),e.view.rules={name:"充值",uncheck:!0,state:"",show:0,addFunc:e.ruleFn.addCouponFn,postFunc:e.ruleFn.sendCouponFn,content:{CHARGE:[]}},console.log("222222"),console.log(e.view.rules),e.view.shop=ajaxSendFn({state:"1002"},"/shops","GET").result||[],e.tem.shops=[];for(var t in e.view.shop)e.tem.shops.push(e.view.shop[t].id)},closeFn:function(t){"edit"==e.view.rules[t].state?e.view.rules[t].state="show":"add"==e.view.rules[t].state&&(e.view.rules[t].state="show")},postFn:function(){var t=e.view.rules.content;console.log(t),e.ruleFn.addCouponFn()},addCouponFn:function(){var t={};t.value={},t.allocates=[];for(var a=0;a<e.set.list.length;a++)t.allocates[a]={highest:"false",id:""};e.posts.rule.detail&&e.posts.rule.detail.ALL?e.posts.rule.detail.ALL.push(t):e.posts.rule.detail={ALL:[t]}},removeFn:function(t,a,o){e.posts.rule.detail[a][o]&&e.posts.rule.detail[a].splice(o,1)},sendChargeConsumeFn:function(t){return e.ruleFn.sendFn(t,void 0,void 0,function(e){var t=e.detail.ALL[0];t.amount=1,t.currentAmount=t.count=0})},sendFn:function(t,o,n,s){var r=e.posts[t],i={};for(var l in r)if(e.view.rules[t].uncheck||r[l].check){e.transferMapRev.hasOwnProperty(l)?i.type=e.transferMapRev[l]:i.type=l,i.detail={},r[l]._id&&(i._id=r[l]._id),r[l].amountLimit&&(i.amountLimit=r[l].amountLimit),r[l].celling&&(i.celling=parseInt(r[l].celling)/100,r[l].firstLimit?i.firstLimit=!0:i.firstLimit=!1),"CHARGE_CONSUME"==i.type&&(r[l].allpurpose?i.allpurpose=!0:i.allpurpose=!1),"number"==typeof r[l].countLimit&&(i.countLimit=r[l].countLimit),r[l].timesLimit&&(i.timesLimit=r[l].timesLimit),
r[l].obtainCategory&&(i.obtainCategory=r[l].obtainCategory);var d,c=r[l].detail,u=l.split("_");u&&u.length>1&&(d=u[1]);for(z in c)for(w in c[z]){var p=c[z][w],m={};if(("number"==typeof p.amount||p.amount)&&(m.amount=p.amount),p.score&&(m.score=p.score),p.gradeId&&(m.gradeId=p.gradeId),p.value&&0!=p.value.length){if(m.value=p.value,m.value&&m.value.length)for(var l in m.value)delete m.value[l].$$hashKey}else"CHARGE_CONSUME"==i.type&&(m.value=!1);void 0!==p.limit&&(m.limit=p.limit),p.count&&(m.count=p.count),p.currentAmount&&(m.currentAmount=p.currentAmount),i.detail[p.id]?i.detail[p.id].push(m):i.detail[p.id]=[m]}if("CHARGE"==i.type&&angular.forEach(i.detail.ALL,function(e,t){e.value&&e.value[0].category||delete e.value}),n&&"function"==typeof n&&(obj=n(d,i),obj))return alert(obj.message),!1;s&&"function"==typeof s&&s(i)}if("TICKET"==e.tem.activityCategory){if(!e.tel.inviters)return void alert("请输入邀请码");i.inviters=e.tel.inviters.split(",")}var v=ajaxSendFn(i,"/activity/"+a.activityid+"/rule","POST",1);return 200!=v.code?(errorMsg(v),!1):(e.ruleFn.oldRuleFn(),!0)},addRuleFn:function(){e.view.modal={title:"添加活动内容",html:"addrule"},$("#showadd").modal("show")},put:function(e,t){e.value||(e.value={}),t={},e.value.push(t)},resetCouponCntFn:function(e,t){angular.forEach(e.value,function(e,a){e&&e.id===t.id&&this.splice(a,1)},e.value)},containsCoupon:function(e,t){for(var a=-1,o=0;e.value&&o<e.value.length;o++)if(e.value[o].id===t){a=o;break}return a}},e.ruleFn.oldRuleFn(),e.ruleFn.postFn("CHARGE"),e.cbdata=ajaxSendFn({},"/activity/saler/"+a.id,"GET").result,e.posts=angular.copy(e.cbdata),e.set.expiredLimit=e.posts.rule.expiredLimit,e.set.personLimit=e.posts.rule.personLimit,e.set.allpurpose=e.posts.rule.allpurpose+"",e.set.timesLimit=e.posts.rule.timesLimit,e.set.distanceLimit=e.posts.rule.distanceLimit,e.set.personLimitDetail=e.posts.rule.personLimitDetail,delete e.posts.createTime,delete e.posts.id,delete e.posts.offTime,delete e.posts.onTime,delete e.posts.dateRange,delete e.posts.text,delete e.posts.rule.detail.ALL.text;for(var r=0;r<e.set.list.length;r++)for(var i=0;i<e.posts.shops.length;i++)e.set.list[r].id==e.posts.shops[i]&&(e.set.shops[r]=e.posts.shops[i]);for(var r=0;r<e.cbdata.rule.detail.ALL.length;r++){for(var l=e.cbdata.rule.detail.ALL[r].allocates,d=[],i=0;i<l.length;i++)for(var c=0;c<e.set.allocate.length;c++)l[i].id==e.set.allocate[c].id&&(d[c]={},d[c].id=l[i].id,0==l[i].highest?d[c].highest="false":d[c].highest="true");for(var i=0;i<d.length;i++)null==d[i]&&(d[i]={});e.posts.rule.detail.ALL[r].allocates=d}console.log("$scope.posts"),console.log(e.posts),e.view.date={},e.view.dateRange=e.cbdata.dateRange;var u=e.posts.dateRangeCategory;e.view.date[u]=e.cbdata.dateRange,e.view.date.dateType=u,console.log(e.view),e.addPepFn=function(){e.set.personLimitDetail&&e.set.personLimitDetail.push({amount:"",count:""})},e.removePepFn=function(t){e.set.personLimitDetail[t]&&e.set.personLimitDetail.splice(t,1)},e.sendJsons=function(){if(console.log(e.posts),!e.posts.picUrl)return void alert("请先上传图片");e.posts.shops=e.set.shops.filter(function(e){return e&&e.trim()});var t=angular.copy(e.posts);delete t.CHARGE,t.rule={},t.rule.expiredLimit=e.set.expiredLimit,t.rule.personLimit=e.set.personLimit,t.rule.timesLimit=e.set.timesLimit,t.rule.distanceLimit=e.set.distanceLimit,t.rule.allpurpose=e.set.allpurpose,t.rule.personLimitDetail=angular.copy(e.set.personLimitDetail),t.rule.detail=angular.copy(e.posts.rule.detail);for(var n=0;n<e.posts.rule.detail.ALL.length;n++){delete t.rule.detail.ALL[n].text;for(var s=0;s<t.rule.detail.ALL[n].allocates.length;s++)"false"!=t.rule.detail.ALL[n].allocates[s].id&&""!=t.rule.detail.ALL[n].allocates[s].id||t.rule.detail.ALL[n].allocates.splice(s,1)}if(console.log(t),t.dateRange={},t.dateRangeCategory=e.view.date.dateType,"CONTINUOUS"===e.view.date.dateType){if(!e.view.dateRange.startDate||!e.view.dateRange.endDate)return void alert("请填写开始和结束日期!");if(e.view.dateRange.endDate<e.view.dateRange.startDate)return void alert("结束日期不能小于开始日期!");t.dateRange.startDate=o("date")(e.view.dateRange.startDate,"yyyy-MM-dd 00:00:00"),t.dateRange.endDate=o("date")(e.view.dateRange.endDate,"yyyy-MM-dd 23:59:59")}else"BIRTHDAY"===e.view.date.dateType&&"AROUND_FIX_DATE"===e.view.date.subType&&(t.dateRange.beforeDays=e.view.dateRange.beforeDays||0,t.dateRange.afterDays=e.view.dateRange.afterDays||0);if(t.dateRange.selectCategory=e.view.dateRange.selectCategory||"NONE","MANUAL_SELECT"===e.view.dateRange.subType){var r=arrayMap(objectKeys(e.view.dateRange.selectDates),function(e){return e+" 00:00:00"});isEmptyObject(r)||(t.dateRange.selectDates=r)}else if("MONTH_DAYS"===e.view.dateRange.subType){var r=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectDays,notNull)),parseInt);isEmptyObject(r)||(t.dateRange.selectDays=r)}else if("WEEKLY_DAY"===e.view.dateRange.subType){var r=arrayMap(objectKeys(mapFilter(e.view.dateRange.selectWeekDays,notNull)),parseInt);isEmptyObject(r)||(t.dateRange.selectWeekDays=r)}if("SELECTED_DATES"!==t.dateRangeCategory&&"EXCLUDE"===t.dateRange.selectCategory&&1==objectCount(t.dateRange))return void alert("没有指定排除日期！");if("SELECTED_DATES"===t.dateRangeCategory&&1==objectCount(t.dateRange))return void alert("没有指定日期！");t.advertisement&&!t.advertisement.id&&delete t.advertisement,console.log(t);var i="/activity/saler/"+a.id,l=ajaxSendFn(t,i,"POST");200==l.code?alert("操作成功"):alert(l.message)},e.tem&&e.tem.activityCategory&&isEmptyObject(e.tem.rules)&&e.ruleFn.stateFn(e.tem.activityCategory,"add",1),e.checkAllShops=function(){if(console.log(e.posts.allShop),e.posts.allShop){for(var t=[],a=0;a<e.set.list.length;a++)t.push(e.set.list[a].id);e.set.shops=t}else e.set.shops=[],e.posts.shops=[]},e.checkShops=function(t){0==t&&(delete t,e.posts.allShop=!1);var a=e.set.shops.filter(function(e){return e&&e.trim()});a.length==e.set.list.length?e.posts.allShop=!0:e.posts.allShop=!1}}]),app.controller("sourceCtr",["$scope","$http","$routeParams","$filter","$location","CouponFactory",function(e,t,a,o,n,s){e.config.breadset=[{name:"素材管理",href:indexUrl+"/admin.html#/rule/source",class:"source"},{name:"素材管理"}],e.posts={}}]),app.controller("addsourceCtr",["$scope","$http","$routeParams","$filter","$location","CouponFactory",function(e,t,a,o,n,s){e.config.breadset=[{name:"素材管理",href:indexUrl+"/admin.html#/rule/addsource",class:"addsource"},{name:"素材管理"}],e.posts={},e.sendJsons=function(){if(console.log(e.posts),!e.posts.picUrl)return void alert("请先上传图片");var t=angular.copy(e.posts);console.log(t);var a="/posters",o=ajaxSendFn(t,a,"POST");200==o.code?alert("操作成功"):alert(o.message)}}]),app.controller("CustomerCtr",["$scope","tyFnFactory","$http","$location","$filter","$routeParams",function(e,t,a,o,n,s){if(e.config.breadset=[{name:"顾客管理",href:indexUrl+"/admin.html#/customer",class:"search"},{name:"顾客列表"}],e.view={index:[],sort:{1000:"最近消费",1010:"消费额度",1020:"消费次数",1030:"加入时间",1040:"会员等级",1050:"用户积分",1060:"充值余额",1070:"券张数"}},s.userId){e.search={param:s.userId};var r=ajaxSendFn({param:s.userId},"/customer/search","GET").result;e.view.customer={items:r,page:1,total:r.length}}else e.view.customer=ajaxSendFn({count:50},"/customer","GET").result||[];e.view.memberGrades=ajaxSendFn({},constUrlDict.memberGrade,"GET").result||[],e.view.member=[],e.search={count:50},e.post={genders:[],memberGradeIds:[]},e.tag={name:"",user:[]},e.postSend=function(){console.log(1111),e.view.check="",e.search.param?(e.view.customer.items=ajaxSendFn(e.search,"/customer/search","GET").result||[],e.view.customer.total=e.view.customer.items.length):e.view.customer=ajaxSendFn({count:50},"/customer","GET").result||{count:e.view.customer.count,page:0,total:0}},e.refer=function(e){window.open("admin.html#/"+e,"_blank")},e.searchFn=function(t){e.view.check=!1;var a=angular.copy(e.post);"9001"!=a.type&&delete a.memberGradeIds;for(var o in a){if("memberGradeIds"==o){for(var s="",r=0;r<a.memberGradeIds.length;r++)a.memberGradeIds[r]&&(s=s+a.memberGradeIds[r]+",");s?a.memberGradeIds=s.substr(0,s.length-1):delete a.memberGradeIds}if("genders"==o){var s="";a.genders[0]&&(s=a.genders[0]+","),a.genders[1]&&(s+=a.genders[1]+","),a.genders[2]&&(s+=a.genders[2]+","),s?a.genders=s.substr(0,s.length-1):delete a.genders}a[o]instanceof Date&&("joinStartDate"==o&&(a[o]=n("date")(a[o],"yyyy-MM-dd 00:00:00")),"joinEndDate"==o&&(a[o]=n("date")(a[o],"yyyy-MM-dd 23:59:59"))),a[o]||"number"==typeof a[o]||delete a[o]}t&&(a.page=t),a.count=e.view.customer.count||50,e.view.customer=ajaxSendFn(a,"/customer","GET").result||[]},e.$watch("view.check",function(t,a){t!==a&&(t?angular.forEach(e.view.customer.items,function(e,t){this[t]=e.id},e.tag.user):e.tag.user=[])}),e.tagName=function(){e.view.tagName=ajaxSendFn({},"/tags/name","GET").result||[],$("#tagName").modal("show")},e.tagFn=function(){if(!e.tag.user.length)return void alert("请先选择顾客");var t="/tags";if(e.tag.name);else{if(!e.view.checkName)return void alert("请先选择标签");t+="/"+e.view.checkName}var a=angular.copy(e.tag);for(var o in a.user)a.user[o]||a.user.splice(o,1);var n=ajaxSendFn(a,t,"POST");200==n.code?($("#tagName").modal("hide"),alert("操作成功")):alert(n.message)},e.pageChange=function(){e.view.check=!1,e.searchFn(e.view.customer.page)}}]),app.controller("CustomerImportCtr",["$scope","tyFnFactory","$http","$location","$filter","$routeParams",function(e,t,a,o,n,s){e.config.breadset=[{name:"顾客管理",href:indexUrl+"/admin.html#/customer",class:"import"},{name:"新会员列表"}],e.view={index:[],state:{301:"未同步",302:"已同步"}},e.show={state:{"未同步":"301","已同步":"302","所有":""}},e.posts={state:"",smsText:""},e.tem="选择EXCEL文件",e.view.customer=ajaxSendFn({count:100},"/customer/import","GET").result||[],e.view.memberGrades=ajaxSendFn({},constUrlDict.memberGrade,"GET").result||[],e.view.member=[],e.search={count:100},e.pageChange=function(){var t={page:e.view.customer.page,count:e.view.customer.count};e.view.customer=ajaxSendFn(t,"/customer/import","GET").result||[]},e.openOrClose=function(){$("#add").modal("show"),e.isOpenOrClose=!0},e.sendMessage=function(){if(!e.posts.state)return void alert("请选择状态");var t={state:e.show.state[e.posts.state],content:e.posts.smsText};console.log(t);var a=ajaxSendFn(t,"/customer/import/remind","POST");200==a.code?alert("设置成功"):alert("data.message")},e.checkOut=function(){if(e.posts.smsText.length>200)return alert("短信内容不能超过200个字"),void(e.posts.smsText=e.posts.smsText.substring(0,e.posts.smsText.length-1))},e.temimgshow=function(t){var a=getObjectURL(t.files[0]);a&&e.$apply(function(){e.tem="已选择"})},e.importFn=function(){POSTurl=basicUrl+"/customer/import?",options={url:POSTurl+sortUrl(),type:"POST",success:function(e){200===e.code?alert("文件上传成功"):alert(e.message)}},$("#fileForm").ajaxSubmit(options)},e.postSend=function(){if(e.search.phone){var t=[],a=ajaxSendFn(e.search,"/customer/import/search","GET");200==a.code&&(t[0]=a.result),e.view.customer.items=t,e.view.customer.total=e.view.customer.items.length,console.log(e.view.customer.items)}else e.view.customer=ajaxSendFn({count:100},"/customer/import","GET").result||{count:e.view.customer.count,page:0,total:0}},e.filter=function(){var t={state:e.show.state[e.posts.status]};console.log(t.state),t.state?e.view.customer=ajaxSendFn(t,"/customer/import","GET").result||[]:e.view.customer=ajaxSendFn({},"/customer/import","GET").result||[]}}]),app.controller("CustomerTagCtr",["$scope","tyFnFactory","$http","$location","$filter",function(e,t,a,o,n){e.config.breadset=[{name:"顾客管理",href:indexUrl+"/admin.html#/customer",class:"tag"},{name:"顾客列表"}],e.view={tag:ajaxSendFn({},"/tags","GET").result||[]},e.search={},e.tag={name:"",user:[]},e.postSend=function(){window.open("admin.html#/customer/search/"+e.search.param,"_blank")},e.deleteFn=function(){var t=confirm("确认删除此标签？");if(t){var a=ajaxSendFn({},"/tags/"+e.view.id,"DELETE");200==a.code?(alert("操作成功"),e.view.tag=ajaxSendFn({},"/tags","GET").result||[],e.view.detail=""):alert(a.message)}},e.deleteUser=function(){var t={user:e.tag.user},a=ajaxSendFn(t,"/tags/"+e.view.id+"/customer","POST");200==a.code?(e.view.detail=ajaxSendFn({},"/tags/"+e.view.id,"GET").result||"",e.view.tag=ajaxSendFn({},"/tags","GET").result||[],alert("操作成功")):alert(a.message)},e.tagName=function(){e.view.tagName=ajaxSendFn({},"/tags/name","GET").result||[],$("#tagName").modal("show")},e.tagFn=function(){if(!e.tag.user.length)return void alert("请先选择顾客");var t="/tags";e.tag.name||e.view.checkName&&(t+="/"+e.view.checkName);var a=angular.copy(e.tag);for(var o in a.user)a.user[o]||a.user.splice(o,1);var n=ajaxSendFn(a,t,"POST");200==n.code?($("#tagName").modal("hide"),alert("操作成功"),e.view.tag=ajaxSendFn({},"/tags","GET").result||[]):alert(n.message)},e.detailFn=function(t){e.view.index=t,e.view.id=e.view.tag.items[t].id,e.view.detail=ajaxSendFn({},"/tags/"+e.view.tag.items[t].id,"GET").result||[]},e.pageChange=function(){var t={page:e.view.tag.page,count:e.view.tag.count};e.view.tag=ajaxSendFn(t,"/tags","GET").result||[]},e.pageUserChange=function(){var t={page:e.view.detail.page,count:e.view.detail.count};e.view.detail=ajaxSendFn(t,"/tags/"+e.view.tag.items[e.view.index].id,"GET").result||[],e.tag.user=[]}}]),app.controller("CustomerMassCtr",["$scope","tyFnFactory","$http","$location","$filter",function(e,t,a,o,n){e.config.breadset=[{name:"顾客管理",href:indexUrl+"/admin.html#/customer",class:"mass"},{name:"顾客列表"}],e.view={mass:ajaxSendFn({count:10},"/mass/tag","GET").result||[],type:{POINT:"积分",CHARGE:"充值",COUPON:"优惠券"},coupons:ajaxSendFn({},constUrlDict.coupon,"GET").result||[]},e.setCouponFn=function(){e.post.coupon=angular.copy(e.view.coupons);for(var t=0;t<e.post.coupon.length;t++)e.post.coupon[t].value=e.post.coupon[t].id,delete e.post.coupon[t].id,e.post.coupon[t].category="COUPON",e.post.coupon[t].checked=!1},e.search={},e.post={},e.setCouponFn(),e.single={},e.tag={name:"",user:[]},e.addRuleFn=function(){e.post.picUrls.push({})},e.removeRuleFn=function(t){e.post.picUrls.splice(t,1)},e.postSend=function(){window.open("admin.html#/customer/search/"+e.search.param,"_blank")},e.detailFn=function(t,a){e.view.id=t;var o=ajaxSendFn({},"/mass/"+t,"GET").result||[];o.completion||"IMMEDIATELY"==o.timeCategory?e.usable=!0:e.usable=!1,e.view.detail=o,e.view.checked=e.view.mass.items[a],e.single.timeCategory=e.view.detail.timeCategory,"TIMING"==e.view.detail.timeCategory&&(e.single.date=new Date(e.view.detail.executionTime),e.single.time=new Date(e.view.detail.executionTime)),e.post.coupon=angular.copy(e.view.coupons);for(var n=0;n<e.view.detail.contents.length;n++){var s=e.view.detail.contents[n];if("COUPON"==s.category)for(var r=0;r<e.view.coupons.length;r++)s.value==e.view.coupons[r].id&&(e.post.coupon[r].value=e.post.coupon[r].id,delete e.post.coupon[r].id,e.post.coupon[r].count=1,e.post.coupon[r].checked=!0,e.post.coupon[r].category="COUPON");else s.category=s.category.toLowerCase(),e.post[s.category]=s}e.post.path=e.view.detail.path,e.post.title=e.view.detail.title,e.post.content=e.view.detail.content,e.post.picUrls=e.view.detail.picUrls||[],e.post.picUrls.length?e.view.check="false":e.post.picUrls=[{}],e.post.externalLinks&&(e.view.check="true")},e.add=function(t){e.post[t]?delete e.post[t]:(e.post[t]={},"coupon"==t&&e.setCouponFn())},e.sendJson=function(){var t={timeCategory:e.single.timeCategory,contents:[],path:e.post.path};if("TIMING"===e.single.timeCategory){if(!e.single.time||!e.single.date)return void alert("请先设置发送时间");e.single.date.setHours(e.single.time.getHours()),e.single.date.setMinutes(e.single.time.getMinutes()),t.executionTime=n("date")(e.single.date,"yyyy-MM-dd HH:mm:ss")}var a=angular.copy(e.post);t.contents=[],t.smsText=a.smsText,t.templateText=a.templateText;for(var o in a){if("coupon"==o)for(var s=0;s<a.coupon.length;s++)!isEmptyObject(a.coupon[s])&&a.coupon[s].count&&(delete a.coupon[s].checked,delete a.coupon[s].code,delete a.coupon[s].alias,t.contents.push(a.coupon[s]));"path"==o&&a[o].value&&(a[o].category=o.toUpperCase(),t.contents.push(a[o]))}if(!t.contents.length)return void alert("请先设置活动");if(!e.view.id)return void alert("请先选择标签");if("true"==e.view.check&&a.externalLinks)t.externalLinks=a.externalLinks;else if("false"==e.view.check){t.picUrls=a.picUrls;for(var s=0;s<t.picUrls.length;s++)for(item in t.picUrls[s])t.picUrls[s][item]||delete t.picUrls[s][item]}a.content&&(t.content=a.content),a.title&&(t.title=a.title);var r=ajaxSendFn(t,"/mass/"+e.view.id,"PUT");200==r.code?(alert("操作成功"),$("#new").modal("hide"),e.view.mass=ajaxSendFn({},"/mass/tag","GET").result||[]):alert(r.message)},e.pageChange=function(){var t={page:e.view.mass.page,count:e.view.mass.count};e.view.mass=ajaxSendFn(t,"/mass/tag","GET").result||[]}}]),app.controller("CustomerMassAddCtr",["$scope","tyFnFactory","$http","$location","$filter",function(e,t,a,o,n){e.config.breadset=[{name:"顾客管理",href:indexUrl+"/admin.html#/customer",class:"mass"},{name:"顾客列表"}],e.view={tagName:ajaxSendFn({},"/tags/name","GET").result||[],coupons:ajaxSendFn({},constUrlDict.coupon,"GET").result||[],id:""},e.setCouponFn=function(){e.post.coupon=angular.copy(e.view.coupons);for(var t=0;t<e.post.coupon.length;t++)e.post.coupon[t].value=e.post.coupon[t].id,delete e.post.coupon[t].id,e.post.coupon[t].category="COUPON",e.post.coupon[t].checked=!1},e.post={picUrls:[{}]},e.setCouponFn(),e.single={},e.add=function(t){e.post[t]?delete e.post[t]:(e.post[t]={},"coupon"==t&&e.setCouponFn())},e.addRuleFn=function(){e.post.picUrls.push({})},e.removeRuleFn=function(t){e.post.picUrls.splice(t,1)},e.checkOut=function(){if(e.post.smsText.indexOf("【")!=-1||e.post.smsText.indexOf("】")!=-1)return alert('短信内容不可包含"【" 和 "】"'),void(e.post.smsText=e.post.smsText.substring(0,e.post.smsText.length-1))},e.sendJson=function(){var t={timeCategory:e.single.timeCategory,contents:[],path:e.post.path};if("TIMING"===e.single.timeCategory){if(!e.single.time||!e.single.date)return void alert("请先设置发送时间");e.single.date.setHours(e.single.time.getHours()),e.single.date.setMinutes(e.single.time.getMinutes()),t.executionTime=n("date")(e.single.date,"yyyy-MM-dd HH:mm:ss")}var a=angular.copy(e.post);t.contents=[],t.smsText=a.smsText,t.templateText=a.templateText;for(var s in a){if("coupon"==s)for(var r=0;r<a.coupon.length;r++)!isEmptyObject(a.coupon[r])&&a.coupon[r].count&&(delete a.coupon[r].checked,delete a.coupon[r].code,delete a.coupon[r].alias,t.contents.push(a.coupon[r]));"path"!==s&&a[s].value&&(a[s].category=s.toUpperCase(),t.contents.push(a[s]))}if(!t.contents.length)return void alert("请先设置活动");if(!e.view.id)return void alert("请先选择标签");if("true"==e.view.check&&a.externalLinks)t.externalLinks=a.externalLinks;else if("false"==e.view.check){t.picUrls=a.picUrls;for(var r=0;r<t.picUrls.length;r++)for(item in t.picUrls[r])t.picUrls[r][item]||delete t.picUrls[r][item]}a.content&&(t.content=a.content),a.title&&(t.title=a.title);var i=ajaxSendFn(t,"/mass/"+e.view.id,"POST");200==i.code?(alert("操作成功"),o.path("/customer/mass")):alert(i.message)}}]),app.controller("CustomerTrusteeshipCtr",["$scope","tyFnFactory","$http","$location","$filter",function(e,t,a,o,n){e.config.breadset=[{name:"顾客管理",href:indexUrl+"/admin.html#/customer",class:"trusteeship"},{name:"顾客列表"}],e.view={memberGrades:ajaxSendFn({},constUrlDict.memberGrade,"GET").result||[],mass:ajaxSendFn({},"/mass","GET").result||[],type:{POINT:"积分",CHARGE:"充值",COUPON:"优惠券"},coupons:ajaxSendFn({},constUrlDict.coupon,"GET").result||[]},e.setCouponFn=function(){e.post.coupon=angular.copy(e.view.coupons);for(var t=0;t<e.post.coupon.length;t++)e.post.coupon[t].value=e.post.coupon[t].id,delete e.post.coupon[t].id,e.post.coupon[t].category="COUPON",e.post.coupon[t].checked=!1},e.search={},e.post={},e.setCouponFn(),e.single={},e.postSend=function(){window.open("admin.html#/customer/search/"+e.search.param,"_blank")},e.detailFn=function(t,a){e.view.id=t;var o=ajaxSendFn({},"/mass/"+t,"GET").result||[];if(o.completion)return void alert("群发已结束，无法修改");if(e.view.detail=o,e.view.checked=e.view.mass.items[a],e.view.coupons=ajaxSendFn({},constUrlDict.coupon,"GET").result||[],e.post=angular.copy(e.view.detail),delete e.post.contents,e.post.condition=angular.copy(e.view.detail.conditions),e.post.path=e.view.detail.path,e.single.timeCategory=e.view.detail.timeCategory,e.view.detail.conditions.genders){var n=["M","F","N"];e.post.condition.genders=[],$.each(n,function(t,a){in_array(a,e.view.detail.conditions.genders)?e.post.condition.genders.push(a):e.post.condition.genders.push("")})}e.view.detail.conditions.memberGradeIds&&(e.post.condition.memberGradeIds=[],$.each(e.view.memberGrades,function(t,a){in_array(a.id,e.view.detail.conditions.memberGradeIds)?e.post.condition.memberGradeIds.push(a.id):e.post.condition.memberGradeIds.push("")})),e.post.coupon=angular.copy(e.view.coupons);for(var s=0;s<e.view.detail.contents.length;s++){var r=e.view.detail.contents[s];if("COUPON"==r.category)for(var i=0;i<e.view.coupons.length;i++)r.value==e.view.coupons[i].id&&(e.post.coupon[i].count=1,e.post.coupon[i].checked=!0);else r.category=r.category.toLowerCase(),e.post[r.category]=r}e.post.picUrls=e.view.detail.picUrls||[],e.post.picUrls.length?e.view.check="false":e.post.picUrls=[{}],e.post.externalLinks&&(e.view.check="true")},e.add=function(t){e.post[t]?delete e.post[t]:(e.post[t]={},"coupon"==t&&e.setCouponFn())},e.sendJson=function(){var t=angular.copy(e.post.condition);"9001"!=t.type&&delete t.memberGradeIds;for(var a in t)"memberGradeIds"==a&&(t.memberGradeIds=arrRemoveNullFN(t.memberGradeIds),t.memberGradeIds.length||delete t.memberGradeIds),"genders"==a&&(t.genders=arrRemoveNullFN(t.genders),t.genders.length||delete t.genders),t[a]instanceof Date&&(t[a]=n("date")(t[a],"yyyy-MM-dd")),t[a]||"number"==typeof t[a]||delete t[a];var o={conditions:t,timeCategory:e.single.timeCategory,contents:[],path:e.post.path,day:e.post.day},s=angular.copy(e.post);delete s.condition;for(var r in s)if("coupon"==r)for(var a=0;a<s.coupon.length;a++)!isEmptyObject(s.coupon[a])&&s.coupon[a].count&&(delete s.coupon[a].checked,delete s.coupon[a].code,delete s.coupon[a].alias,o.contents.push(s.coupon[a]));else"path"!==r&&s[r].value&&(s[r].category=r.toUpperCase(),o.contents.push(s[r]));if(!o.contents.length)return void alert("请先设置活动");var i="/mass",l=ajaxSendFn(o,i,"POST");200==l.code?(alert("操作成功"),$("#new").modal("hide"),e.view.mass=ajaxSendFn({},"/mass","GET").result||[]):alert(l.message)},e.pageChange=function(){var t={page:e.view.mass.page,count:e.view.mass.count};e.view.mass=ajaxSendFn(t,"/mass","GET").result||[]}}]),app.controller("CustomerTrusteeshipAddCtr",["$scope","tyFnFactory","$http","$location","$filter",function(e,t,a,o,n){e.config.breadset=[{name:"顾客管理",href:indexUrl+"/admin.html#/customer",class:"trusteeship"},{name:"顾客列表"}],e.view={memberGrades:ajaxSendFn({},constUrlDict.memberGrade,"GET").result||[],type:{POINT:"积分",CHARGE:"充值",COUPON:"优惠券"},coupons:ajaxSendFn({},constUrlDict.coupon,"GET").result||[]},e.setCouponFn=function(){e.post.coupon=angular.copy(e.view.coupons);for(var t=0;t<e.post.coupon.length;t++)e.post.coupon[t].value=e.post.coupon[t].id,delete e.post.coupon[t].id,e.post.coupon[t].category="COUPON",e.post.coupon[t].checked=!1},e.search={},e.post={},e.post.condition={},e.post.condition.memberGradeIds=[],e.setCouponFn(),e.single={},e.add=function(t){e.post[t]?delete e.post[t]:(e.post[t]={},"coupon"==t&&e.setCouponFn())},e.sendJson=function(){var t=angular.copy(e.post.condition);"9001"!=t.type&&delete t.memberGradeIds;for(var a in t)"memberGradeIds"==a&&(t.memberGradeIds=arrRemoveNullFN(t.memberGradeIds),t.memberGradeIds.length||delete t.memberGradeIds),"genders"==a&&(t.genders=arrRemoveNullFN(t.genders),t.genders.length||delete t.genders),t[a]instanceof Date&&(t[a]=n("date")(t[a],"yyyy-MM-dd")),t[a]||"number"==typeof t[a]||delete t[a];var s={conditions:t,timeCategory:e.single.timeCategory,contents:[],path:e.post.path,day:e.post.day},r=angular.copy(e.post);delete r.condition;for(var i in r)if("coupon"==i)for(var a=0;a<r.coupon.length;a++)!isEmptyObject(r.coupon[a])&&r.coupon[a].count&&(delete r.coupon[a].checked,delete r.coupon[a].code,delete r.coupon[a].alias,s.contents.push(r.coupon[a]));else"path"!==i&&r[i].value&&(r[i].category=i.toUpperCase(),s.contents.push(r[i]));if(!s.contents.length)return void alert("请先设置活动");if("true"==e.view.check&&r.externalLinks)s.externalLinks=r.externalLinks;else if("false"==e.view.check){s.picUrls=r.picUrls;for(var a=0;a<s.picUrls.length;a++)for(item in s.picUrls[a])s.picUrls[a][item]||delete s.picUrls[a][item]}r.content&&(s.content=r.content),r.title&&(s.title=r.title);var l="/mass",d=ajaxSendFn(s,l,"POST");200==d.code?(alert("操作成功"),o.path("/customer/trusteeship")):alert(d.message)},e.pageChange=function(){var t={page:e.view.mass.page,count:e.view.mass.count};e.view.mass=ajaxSendFn(t,"/mass","GET").result||[]}}]),app.controller("CustomerRecordCtr",["$scope","tyFnFactory","$http","$location","$filter",function(e,t,a,o,n){e.config.breadset=[{name:"顾客管理",href:indexUrl+"/admin.html#/customer",class:"record"},{name:"顾客列表"}],e.view={mass:ajaxSendFn({},"/mass/record","GET").result||[],type:{POINT:"积分",CHARGE:"充值",COUPON:"优惠券"}},e.search={},e.postSend=function(){e.search.param?(e.view.customer.total=0,e.view.customer.items=ajaxSendFn(e.search,"/customer/search","GET").result||[]):e.view.customer=ajaxSendFn({},"/customer","GET").result||[]},e.pageChange=function(){var t={page:e.view.mass.page,count:e.view.mass.count};e.view.mass=ajaxSendFn(t,"/mass/record","GET").result||[]}}]),app.controller("CustomerChargeCtr",["$scope","$routeParams","$filter","$http",function(e,t,a,o){e.config.breadset=[{name:"顾客管理",href:indexUrl+"/admin.html#/customer"},{name:"顾客充值"}],e.view={},e.posts={type:"PUT"},e.reason={PUT:"使用",POST:"充值"},e.view.user=ajaxSendFn({},constUrlDict.customer+"/"+t.userId,"GET").result||[],e.send=function(){var a={};a.userId=t.userId,a.amount=e.posts.amount,reason=e.reason[e.posts.type],"PUT"==e.posts.type?re=ajaxSendFn(JSON.stringify(a),"/benefit/charge/use","POST",1):re=ajaxSendFn(JSON.stringify(a),"/benefit/charge","POST",1),200==re.code?(e.view.user=ajaxSendFn({},constUrlDict.customer+"/"+t.userId,"GET").result||[],e.posts.amount=0,alert(reason+"成功")):alert(datda.message)}}]),app.controller("CustomerUpdateCtr",["$scope","$routeParams","$filter","$http",function(e,t,a,o){e.config.breadset=[{name:"顾客管理",href:indexUrl+"/admin.html#/customer"},{name:"会员修改"}],e.view={user:{phone:"",currentPoints:"",currentCharge:""}},e.posts={grade:""},e.view={},e.view.member=ajaxSendFn({},"/memberGrade","GET").result||[],e.view.user=ajaxSendFn({},"/customer/import/"+t.userId,"GET").result||[],e.phone=e.view.user.phone,e.send=function(){var a={};return e.view.user.phone===e.phone||/^1[3456789]\d{9}$/.test(e.view.user.phone)?(e.view.user.phone!==e.phone&&(a.phone=e.view.user.phone),a.grade=e.posts.grade,a.currentPoints=e.view.user.currentPoints,a.currentCharge=e.view.user.currentCharge,console.log(a),re=ajaxSendFn(JSON.stringify(a),"/customer/import/"+t.userId,"PUT",1),void(200==re.code?(alert("修改成功"),location.reload()):alert(re.message))):(console.log(e.view.user.phone),alert("手机号码有误，请重填"),!1)}}]),app.controller("CustomerUpgradeCtr",["$scope","$routeParams","$filter","$http",function(e,t,a,o){e.config.breadset=[{name:"顾客管理",href:indexUrl+"/admin.html#/customer"},{name:"顾客升级"}],e.view={member:ajaxSendFn({},"/memberGrade","GET").result||[]},e.posts={},e.view.user=ajaxSendFn({},constUrlDict.customer+"/"+t.userId,"GET").result||[],e.send=function(){var a={};a.userId=t.userId,a.memberGradeId=e.posts.memberGradeId,re=ajaxSendFn(JSON.stringify(a),"/benefit/upgrade","POST",1),200==re.code?(e.view.user=ajaxSendFn({},constUrlDict.customer+"/"+t.userId,"GET").result||[],alert("升级成功")):alert(re.message)}}]),app.controller("CustomerPointCtr",["$scope","$routeParams",function(e,t){e.config.breadset=[{name:"顾客管理",href:indexUrl+"/admin.html#/customer"},{name:"顾客发积分"}],e.view={user:ajaxSendFn({},constUrlDict.customer+"/"+t.userId,"GET").result||[]},e.posts={type:"PUT"},e.reason={PUT:"使用",POST:"发放"},e.send=function(){var a={};a.userId=t.userId,a.amount=e.posts.amount,reason=e.reason[e.posts.type],"PUT"==e.posts.type?re=ajaxSendFn(JSON.stringify(a),"/benefit/point/use","POST",1):re=ajaxSendFn(JSON.stringify(a),"/benefit/point","POST",1),200==re.code?(e.view.user=ajaxSendFn({},constUrlDict.customer+"/"+t.userId,"GET").result||[],e.posts.amount=0,alert(reason+"成功")):errorMsg(re)}}]),app.controller("CustomerCouponCtr",["$scope","$routeParams",function(e,t){e.config.breadset=[{name:"顾客管理",href:indexUrl+"/admin.html#/customer"},{name:"顾客发券"}],e.view={user:ajaxSendFn({},constUrlDict.customer+"/"+t.userId,"GET").result||[]},e.posts={},e.view.coupons=ajaxSendFn({},constUrlDict.coupon,"GET").result||[],e.view.coupons.length>0&&(e.posts.coupons=[{id:e.view.coupons[0].id,count:1}]),e.add=function(){e.view.coupons.length>0&&(e.posts.coupons.push({id:e.view.coupons[0].id,count:1}),console.log(e.posts.coupons))},e.remove=function(t){e.posts.coupons.splice(t,1)},e.canSend=function(){return e.view.coupons&&e.view.coupons.length>0},e.send=function(){if(json={},json.userId=t.userId,e.posts.coupons&&e.posts.coupons.length>0){json.coupons=e.posts.coupons;for(var a in json.coupons)delete json.coupons[a].$$hashKey;re=ajaxSendFn(JSON.stringify(json),"/benefit/coupon","POST",1),200==re.code?alert("赠券成功"):errorMsg(re)}}}]),app.controller("CustomerAddCtr",["$interval","$scope","$location","$filter",function(e,t,a,o){t.config.breadset=[{name:"顾客管理",href:indexUrl+"/admin.html#/customer"},{name:"添加会员"}],t.view={member:ajaxSendFn({},"/memberGrade","GET").result||[],repeats:90},t.posts={birthday:""},t.getValidateCode=function(e){t.posts.phone&&(re=ajaxSendFn({phone:t.posts.phone},"/customer/validate","POST"),200==re.code?console.log("验证码发送成功"):(alert(re.message),a.path("/customer")))},t.send=function(){t.posts.birthday=o("date")(t.posts.birthday,"yyyy-MM-dd"),re=ajaxSendFn(t.posts,"/customer","POST"),200==re.code?(alert("添加成功"),a.path("/customer")):errorMsg(re)}}]),app.controller("CustomerDetailsCtr",["$scope","$routeParams",function($scope,$routeParams){var userId=$routeParams.userId;$scope.view={user:ajaxSendFn({},"/customer/"+$routeParams.userId,"GET").result||[],type:{consume:"/consume",charge:"/charge",point:"/point",reward:"/reward",coupon:"/coupon"}},$scope.view.charts={title:{text:""},options:{credits:{enabled:!1},chart:{type:"line"},tooltip:{},xAxis:{},yAxis:{}},series:[]},$scope.consumeFn=function(e){if($scope.view.tab="consume",$scope.view.consume=ajaxSendFn({page:e||1},"/benefit/"+$routeParams.userId+$scope.view.type[$scope.view.tab],"GET").result||[],0!=$scope.view.consume.length){for(var t=[],a=[],o=[],n=$scope.view.consume.items.length-1;n>=0;n--)t.push($scope.view.consume.items[n].consumptionTime),a.push($scope.view.consume.items[n].amount),o.push($scope.view.consume.items[n].revenue);$scope.view.charts.title.text="顾客近20笔消费记录",$scope.view.charts.options.xAxis={title:{text:"日期"},labels:{formatter:function(){return formatDate(this.value,"MM-dd HH:mm:ss")}},categories:t},$scope.view.charts.options.yAxis={title:{text:"金额"},labels:{formatter:function(){return this.value}}},$scope.view.charts.series=[{name:"原价",color:"#FF9655",data:a,step:"left"},{name:"实付",color:"red",data:o,step:"left"}]}},$scope.chargeFn=function(e){if($scope.view.tab="charge",$scope.view.charge=ajaxSendFn({page:e||1},"/benefit/"+$routeParams.userId+$scope.view.type[$scope.view.tab],"GET").result||[],0!=$scope.view.charge.length){for(var t=[],a=[],o=[],n=$scope.view.charge.items.length-1;n>=0;n--)t.push($scope.view.charge.items[n].time),"601"==$scope.view.charge.items[n].type?(a.push($scope.view.charge.items[n].amount-0),o.push(null)):(a.push(null),o.push($scope.view.charge.items[n].amount-0));$scope.view.charts.title.text="顾客近20笔充值记录",$scope.view.charts.options.xAxis={title:{text:"充值日期"},labels:{},categories:t},$scope.view.charts.options.yAxis={title:{text:"充值金额"},labels:{formatter:function(){return this.value}}},$scope.view.charts.series=[{name:"获得",color:"#FF9655",data:a},{name:"使用",color:"red",data:o}]}},$scope.rewardFn=function(e){if($scope.view.tab="reward",
$scope.view.reward=ajaxSendFn({page:e||1},"/benefit/"+$routeParams.userId+$scope.view.type[$scope.view.tab],"GET").result||[],0!=$scope.view.reward.length){for(var t=[],a=[],o=[],n=$scope.view.reward.items.length-1;n>=0;n--)t.push($scope.view.reward.items[n].time),"601"==$scope.view.reward.items[n].type?(a.push($scope.view.reward.items[n].amount-0),o.push(null)):(a.push(null),o.push($scope.view.reward.items[n].amount-0));$scope.view.charts.title.text="顾客近20笔代用币记录",$scope.view.charts.options.xAxis={title:{text:"日期"},labels:{},categories:t},$scope.view.charts.options.yAxis={title:{text:"金额"},labels:{formatter:function(){return this.value}}},$scope.view.charts.series=[{name:"获得",color:"#FF9655",data:a},{name:"使用",color:"red",data:o}]}},$scope.pointFn=function(e){if($scope.view.tab="point",$scope.view.point=ajaxSendFn({page:e||1},"/benefit/"+$routeParams.userId+$scope.view.type[$scope.view.tab],"GET").result||[],0!=$scope.view.point.length){for(var t=[],a=[],o=[],n=$scope.view.point.items.length-1;n>=0;n--)t.push($scope.view.point.items[n].time),"601"==$scope.view.point.items[n].type?(a.push($scope.view.point.items[n].amount-0),o.push(null)):(a.push(null),o.push($scope.view.point.items[n].amount-0));$scope.view.charts.title.text="顾客近20笔积分记录",$scope.view.charts.options.xAxis={title:{text:"日期"},labels:{formatter:function(){return formatDate(this.value,"MM-dd HH:mm:ss")}},categories:t},$scope.view.charts.options.yAxis={title:{text:"数量"},labels:{formatter:function(){return this.value}}},$scope.view.charts.series=[{name:"获得",color:"#FF9655",data:a,step:"left"},{name:"使用",color:"red",data:o,step:"left"}]}},$scope.consumeFn(),$scope.couponFn=function(e){$scope.view.tab="coupon",$scope.view.coupon=ajaxSendFn({page:e||1},"/benefit/"+$routeParams.userId+$scope.view.type[$scope.view.tab],"GET").result||[]},$scope.pageChange=function(){eval("$scope."+$scope.view.tab+"Fn("+$scope.view[$scope.view.tab].page+")")}}]),app.controller("DishCtr",["$scope","$location","$http",function(e,t,a){e.config.breadset=[{name:"菜品管理",href:indexUrl+"/admin.html#/mall/dish",class:"dish"},{name:"菜品列表"}];var o=ajaxSendFn({},"/dishes","GET");e.posts={dishes:[]},e.view={groups:ajaxSendFn({},"/dishes/kinds","GET").result||[],leftIndex:-2},e.dishes={list:o.result},e.groupList=function(t){var a={};t>=0&&(a.categoryId=e.view.groups[t].id),e.dishes.list=ajaxSendFn(a,"/dishes","GET").result,e.view.leftIndex=t},e.remove=function(t){if(!confirm("一旦删除将不可恢复，是否确认删除？"))return!1;var a=ajaxSendFn({},"/dishes/"+e.dishes.list.items[t].id,"DELETE");200==a.code?(e.dishes.list.items.splice(t,1),alert("删除成功")):alert(a.message)},e.removeAll=function(){if(!e.posts.dishes.length)return void alert("请先选择要删除的菜品！");if(!confirm("一旦删除将不可恢复，是否确认删除？"))return!1;var t=ajaxSendFn(e.posts.dishes,"/dishes/ids","DELETE");200==t.code?(e.posts.dishes=[],e.dishes.list=ajaxSendFn({},"/dishes","GET").result):alert(t.message)},e.checkAllDishes=function(){e.dishesAll?e.posts.dishes=[]:angular.forEach(e.dishes.list.items,function(e,t){this[t]=e.id},e.posts.dishes)},e.pageChange=function(){var t={page:e.dishes.list.page,count:e.dishes.list.count};e.view.leftIndex>=0&&(t.categoryId=e.view.groups[e.view.leftIndex].id),e.dishes.list=ajaxSendFn(t,"/dishes","GET").result||[]}}]),app.controller("DishAddCtr",["$scope","$location","$http","$routeParams",function(e,t,a,o){if(e.config.breadset=[{name:"菜品管理",href:indexUrl+"/admin.html#/mall/dish",class:"dish"},{name:"菜品列表"}],e.posts={},e.view={groups:ajaxSendFn({},"/dishes/kinds","GET").result||[]},o.dishId){var n=ajaxSendFn({},"/dishes/"+o.dishId,"GET");200!=n.code&&t.path("/mall/dish"),e.posts=n.result,delete e.posts.orgPicUrl}e.send=function(){sendJson=angular.copy(e.posts),sendJson.categoryId||delete sendJson.categoryId,e.posts.id?postsend=ajaxSendFn(sendJson,"/dishes/"+e.posts.id,"PUT",1):postsend=ajaxSendFn(sendJson,"/dishes","POST",1),200==postsend.code?(alert("保存成功"),t.path("/mall/dish")):alert(postsend.message)}}]),app.controller("BuyCtr",["$scope","$location","$http","$filter",function(e,t,a,o){e.config.breadset=[{name:"商城管理",href:indexUrl+"/admin.html#/mall/buy",class:"buy"},{name:"购买列表"}],e.obtainRepeatCategory=obtainRepeatCategory,e.view={mall:ajaxSendFn({},"/mall","GET").result||{}},e.view.member=ajaxSendFn({},"/memberGrade","GET").result||[],e.view.member=o("orderBy")(e.view.member,"grade"),e.view.member=[{id:"ALL",name:"全员"},{id:"CUSTOMER",name:"非会员"},{id:"MEMBER",name:"任一会员"}].concat(e.view.member),e.detailFn=function(t){e.view.detail=e.view.mall.items[t],e.view.detail.text=[];for(var a in e.view.detail.detail){var o=e.view.detail.detail[a];for(var n in e.view.member)if(a==e.view.member[n].id){e.view.detail.text.push(e.view.member[n].name+"可花费"+o+"元购买");break}}$("#show").modal("show")},e.turnFn=function(t,a){data=ajaxSendFn({},"/mall/"+e.view.mall.items[t].id+"/"+a,"POST"),200==data.code?e.view.mall.items[t].on=!e.view.mall.items[t].on:alert(data.message)},e.deleteFn=function(t){return!!confirm("一旦删除将不可恢复，是否确认删除？")&&(data=ajaxSendFn({},"/mall/"+e.view.mall.items[t].id,"DELETE"),void(200==data.code?e.view.mall.items.splice(t,1):alert(data.message)))},e.pageChange=function(){var t={page:e.view.mall.page,count:view.mall.count};e.view.mall=ajaxSendFn(t,"/mall","GET").result||[]}}]),app.controller("BuyAddCtr",["$scope","$location","$http","$filter","$routeParams",function(e,t,a,o,n){if(e.config.breadset=[{name:"商城管理",href:indexUrl+"/admin.html#/mall/buy",class:"buy"},{name:"添加商品"}],e.obtainRepeatCategory=obtainRepeatCategory,n.id){e.posts=ajaxSendFn({},"/mall/"+n.id,"GET").result,e.posts.startDate=new Date(e.posts.startDate),e.posts.endDate=new Date(e.posts.endDate),e.posts.details=[];for(var s in e.posts.detail)e.posts.details.push({id:s,value:e.posts.detail[s]});delete e.posts.detail}else e.posts={details:[{}],category:"BOUGHT",picUrls:[{}]};e.view={mall:ajaxSendFn({},"/mall","GET").result||{},coupons:ajaxSendFn({},"/coupon/usable","GET").result||[]},e.view.member=ajaxSendFn({},"/memberGrade","GET").result||[],e.view.member=o("orderBy")(e.view.member,"grade"),e.view.member=[{id:"ALL",name:"全员"},{id:"CUSTOMER",name:"非会员"},{id:"MEMBER",name:"任一会员"}].concat(e.view.member),e.addFn=function(){e.posts.details.push({})},e.removeFn=function(t){e.posts.details.splice(t,1)},e.postSend=function(){if(!e.posts.picUrl)return void alert("请先选择图片");var a=angular.copy(e.posts);a.detail={};for(var s in a.details)a.detail[a.details[s].id]=a.details[s].value;delete a.details,"[{}]"==JSON.stringify(a.picUrls)&&delete a.picUrls;for(var r in e.view.coupons)(e.posts.goods.id=e.view.coupons[r].id)&&(a.goods.name=e.view.coupons[r].name,a.goods.category="COUPON");a.startDate=o("date")(a.startDate,"yyyy-MM-dd HH:mm:ss"),a.endDate=o("date")(a.endDate,"yyyy-MM-dd HH:mm:ss"),n.id?postsend=ajaxSendFn(a,"/mall/"+n.id,"PUT",1):postsend=ajaxSendFn(a,"/mall","POST",1),200==postsend.code?(alert("操作成功"),t.path("/mall/buy")):alert(postsend.message)}}]),app.controller("CategoryCtr",["$scope","$location","$http",function(e,t,a){e.config.breadset=[{name:"品类管理",href:indexUrl+"/admin.html#/mall/category",class:"category"},{name:"品类管理"}],e.view={list:ajaxSendFn({},"/dishes/kinds","GET").result||""},e.openFn=function(t){t?e.posts=ajaxSendFn({},"/dishes/kinds/"+t,"GET").result||{}:e.posts={},$("#add").modal("show")},e.submitFn=function(){e.posts.id?postsend=ajaxSendFn(e.posts,"/dishes/kinds/"+e.posts.id,"PUT",1):postsend=ajaxSendFn(e.posts,"/dishes/kinds","POST",1),200==postsend.code?($("#add").modal("hide"),e.view.list=ajaxSendFn({},"/dishes/kinds","GET").result||""):alert("重试")},e.remove=function(t){if(!confirm("一旦删除将不可恢复，是否确认删除？"))return!1;var a=ajaxSendFn({},"/dishes/kinds/"+e.view.list[t].id,"DELETE");200==a.code?e.view.list.splice(t,1):alert(a.message)}}]),app.controller("MealCtr",["$scope","$location","$http",function(e,t,a){e.config.breadset=[{name:"套餐管理",href:indexUrl+"/admin.html#/mall/meal",class:"meal"},{name:"套餐列表"}];var o=ajaxSendFn({},"/meals","GET");200!=o.code&&t.path("/mall/meal/add"),e.posts={meals:[]},e.view=o.result,e.remove=function(t){if(!confirm("一旦删除将不可恢复，是否确认删除？"))return!1;var a=ajaxSendFn({},"/meals/"+e.view.items[t].id,"DELETE");200==a.code?(e.view.items.splice(t,1),alert("删除成功")):alert(a.message)},e.removeAll=function(){if(!e.posts.meals.length)return void alert("请先选择要删除的套餐！");if(!confirm("一旦删除将不可恢复，是否确认删除？"))return!1;var t=ajaxSendFn(e.posts.meals,"/meals/ids","DELETE");200==t.code?(e.posts.meals=[],e.view=ajaxSendFn({},"/meals","GET").result):alert(t.message)},e.checkAllDishes=function(){e.dishesAll?e.posts.meals=[]:angular.forEach(e.view.items,function(e,t){this[t]=e.id},e.posts.meals)},e.detailFn=function(t){e.meal=e.view.items[t],$("#show").modal("show")},e.pageChange=function(){var t={page:e.view.page,count:e.view.count};e.view=ajaxSendFn(t,"/meals","GET").result||[]}}]),app.controller("MealAddCtr",["$scope","$location","$http","$routeParams",function(e,t,a,o){if(e.config.breadset=[{name:"套餐管理",href:indexUrl+"/admin.html#/mall/meal",class:"meal"},{name:"套餐列表"}],e.view=ajaxSendFn({},"/dishes/usable","GET").result,e.posts={dishess:[{count:1}]},o.mealId){var n=ajaxSendFn({},"/meals/"+o.mealId,"GET");200!=n.code&&t.path("/mall/meal"),e.posts=n.result,delete e.posts.orgPicUrl;for(var s in e.posts.dishess)delete e.posts.dishess[s].orgPicUrl}e.addFn=function(){e.posts.dishess.push({count:1})},e.removeFn=function(t){e.posts.dishess.splice(t,1)},e.send=function(a){for(var o in e.posts.dishess)delete e.posts.dishess[o].$$hashKey;sendJson=JSON.stringify(e.posts),e.posts.id?postsend=ajaxSendFn(sendJson,"/meals/"+e.posts.id,"POST",1):postsend=ajaxSendFn(sendJson,"/meals","POST",1),200==postsend.code?(alert("保存成功"),t.path("/mall/meal")):alert(n.message)}}]),app.controller("DocCtr",["$rootScope","$scope","$location","shopFactory",function(e,t,a,o){t.config.class="doc",t.posts={},t.view={shops:o.getAllShops(),STATISTICS_TEXT:["当前总消费数（笔）","当前总收款数（笔）","当前总余额（元）","当前会员总人数（人）","累计金额（元）","累计金额（元）","累计金额（元）","累计金额（元）","当前总余量（分）","当前总余量（张）","当前总余额（元）","短信余额（条）"],buttons:["惠买单消费报表","快速收款报表","充值报表","会员升级报表","打赏购买","砍价购买","抽奖购买","商城购买","积分报表","优惠券报表","代用币报表","短信使用报表","服务员收益","营销支出","探店储值卡"],coupons:ajaxSendFn({},"/reports/coupon/coupons","GET").result||[],staff:ajaxSendFn({},"/reports/profits/staffs","GET").result||[],business:[{id:"8001",name:"费率分成"},{id:"8002",name:"打赏小红花"},{id:"8003",name:"用户分销赏金"},{id:"8004",name:"用户分销佣金"}],card:ajaxSendFn({},"/reports/card/cards","GET").result||[]},t.sendOrder=function(){window.open("admin.html#/doc/detail/"+t.posts.order,"_blank")}}]),app.controller("FinanceCtr",["$rootScope","$scope","$location","shopFactory","$filter",function(e,t,a,o,n){t.config.class="doc",t.posts={selector:" "},t.view={channels:[{id:" ",name:"全部"}],types:[{id:"901",name:"惠买单消费"},{id:"902",name:"充值"},{id:"904",name:"会员升级"},{id:"905",name:"砍价购买"},{id:"906",name:"抽奖购买"},{id:"907",name:"打赏"},{id:"903",name:"商城购买"}]},t.initTimeFn=function(){var e=new Date;e.setHours(23),e.setMinutes(59),e.setSeconds(59),t.posts.endTime=e;var a=new Date;a.setHours(0),a.setMinutes(0),a.setSeconds(0),a.setDate(e.getDate()-30),t.posts.startTime=a,t.view.initTime=n("date")(new Date,"yyyy-MM-dd")+"T59:59"},t.initTimeFn(),t.searchFn=function(e){if(e&&(t.posts.selector=e),(t.posts.endTime-t.posts.startTime)/864e5>31)return void alert("起止时间不能超过31天");var a={};a.startTime=n("date")(t.posts.startTime,"yyyy-MM-dd HH:mm:ss"),a.endTime=n("date")(t.posts.endTime,"yyyy-MM-dd HH:mm:ss"),t.posts.selector&&(a.reason=t.posts.selector);var o=ajaxSendFn(a,"/finance","GET");t.view.result=o.result||[]},t.detailFn=function(e,a){var o={};o.startTime=n("date")(t.posts.startTime,"yyyy-MM-dd HH:mm:ss"),o.endTime=n("date")(t.posts.endTime,"yyyy-MM-dd HH:mm:ss"),t.posts.selector&&(o.reason=t.posts.selector),e&&(o.shopId=e),a&&(o.channel=a);var s="";for(var r in o)s+=r+"="+o[r]+"&";s=s.substring(0,s.length-1),window.open("admin.html#/finance/search?"+s,"_blank")}}]),app.controller("FinanceSearchCtr",["$rootScope","$scope","$location","shopFactory",function(e,t,a,o){t.config.class="doc",t.view={};var n=a.search();t.view=ajaxSendFn(n,"/finance/detail","GET").result,t.$watch("view.page",function(e,a){e&&a&&e!==a&&(n.page=t.view.page,n.count=t.view.count,t.view=ajaxSendFn(n,"/finance/detail","GET").result)})}]),app.controller("NoticeCtr",["$rootScope","$scope","$location","shopFactory",function(e,t,a,o){t.config.class="notice",t.view=ajaxSendFn({},"/remind/message/NOTIFY","GET").result||[],t.post=[],t.posts={102:{category:"102",path:"",enabled:!1},103:{category:"103",path:"",enabled:!1},104:{category:"104",path:"",enabled:!1},105:{category:"105",path:"",enabled:!1},106:{category:"106",path:"",enabled:!1},107:{category:"107",path:"",enabled:!1},108:{category:"108",path:"",enabled:!1},109:{category:"109",path:"",enabled:!1},113:{category:"113",path:"",enabled:!1},114:{category:"114",path:"",enabled:!1}},t.init=function(){for(var e=0;e<t.view.length;e++)t.posts[t.view[e].category]=t.view[e]},t.init(),t.reverse=function(){var e=[];for(var a in t.posts)t.posts[a].path&&(t.posts[a].enabled=!0,e.push(t.posts[a]));return e},t.postSend=function(){var e=ajaxSendFn(t.reverse(),"/remind/message/NOTIFY","POST");200==e.code?alert("保存成功"):alert(e.message)}}]),app.controller("NoticePraiseCtr",["$rootScope","$scope","$location","shopFactory",function(e,t,a,o){t.config.class="praise",t.view=ajaxSendFn({},"/remind/message/PRAISE","GET").result||[],t.post=[],t.posts={161:{category:"161",path:"",enabled:!1},163:{category:"163",path:"",enabled:!1},165:{category:"165",path:"",enabled:!1}},t.init=function(){for(var e=0;e<t.view.length;e++)t.posts[t.view[e].category]=t.view[e]},t.init(),t.reverse=function(){var e=[];for(var a in t.posts)t.posts[a].path&&(t.posts[a].enabled=!0,e.push(t.posts[a]));return e},t.postSend=function(){var e=ajaxSendFn(t.reverse(),"/remind/message/PRAISE","POST");200==e.code?alert("保存成功"):alert(e.message)}}]),app.controller("NoticeGrouponCtr",["$rootScope","$scope","$location","shopFactory",function(e,t,a,o){t.config.class="groupon",t.view=ajaxSendFn({},"/remind/message/GROUPON","GET").result||[],t.post=[],t.posts={151:{category:"151",path:"",enabled:!1},152:{category:"152",path:"",enabled:!1}},t.init=function(){for(var e=0;e<t.view.length;e++)t.posts[t.view[e].category]=t.view[e]},t.init(),t.reverse=function(){var e=[];for(var a in t.posts)t.posts[a].path&&(t.posts[a].enabled=!0,e.push(t.posts[a]));return e},t.postSend=function(){var e=ajaxSendFn(t.reverse(),"/remind/message/GROUPON","POST");200==e.code?alert("保存成功"):alert(e.message)}}]),app.controller("NoticeLotteryCtr",["$rootScope","$scope","$location","shopFactory",function(e,t,a,o){t.config.class="lottery",t.view=ajaxSendFn({},"/remind/message/RAFFLE","GET").result||[],t.post=[],t.posts={170:{category:"170",path:"",enabled:!1},171:{category:"171",path:"",enabled:!1}},t.init=function(){for(var e=0;e<t.view.length;e++)t.posts[t.view[e].category]=t.view[e]},t.init(),t.reverse=function(){var e=[];for(var a in t.posts)t.posts[a].path&&(t.posts[a].enabled=!0,e.push(t.posts[a]));return e},t.postSend=function(){var e=ajaxSendFn(t.reverse(),"/remind/message/RAFFLE","POST");200==e.code?alert("保存成功"):alert(e.message)}}]),app.controller("NoticeValidateCtr",["$rootScope","$scope","$location","shopFactory",function(e,t,a,o){t.config.class="validate",t.posts={};var n=ajaxSendFn({},"/remind/short","GET");200==n.code&&(t.posts=n.result),t.postSend=function(){var e=t.posts;for(var a in e)e[a]||delete e[a];var o=ajaxSendFn(e,"/remind/short","POST");200==o.code?alert("保存成功"):alert(o.message)}}]),app.controller("NoticeExpiredCtr",["$rootScope","$scope","$location","shopFactory",function(e,t,a,o){t.config.class="expired";var n=ajaxSendFn({},"/remind/expired","GET");if(200==n.code)switch(t.post=n.result,t.post.path){case"102":t.hand_click=!0,t.message=!0,t.wx=!0;break;case"104":t.hand_click=!0,t.message=!0;break;case"103":t.hand_click=!0,t.wx=!0}else t.post={category:"120",path:"",enabled:!1,times:""};t.postSend=function(){if(t.post.path){if(!t.post.times)return void alert("请先选择天数！");t.post.enabled=!0}var e=ajaxSendFn(t.post,"/remind/expired","POST");200==e.code?alert("保存成功"):alert(e.message)},t.change=function(){t.message&&t.wx?t.post.path="102":t.message?t.post.path="104":t.wx?t.post.path="103":t.post.path=""},t.$watch("post.path",function(){"101"==t.post.path&&(t.hand_click="")})}]),app.controller("NoticeSubscribeCtr",["$rootScope","$scope","$location","shopFactory",function(e,t,a,o){t.config.class="subscribe",t.posts={130:{category:"130",path:"103",enabled:!1},131:{category:"131",path:"103",enabled:!1},132:{category:"132",path:"103",enabled:!1}},t.view=ajaxSendFn({},"/remind/subscribe","GET").result||[],t.init=function(){for(var e=0;e<t.view.length;e++)t.posts[t.view[e].category]=t.view[e]},t.init(),t.postSend=function(){var e=[];for(var a in t.posts)t.posts[a].enabled&&e.push(t.posts[a]);var o=ajaxSendFn(e,"/remind/subscribe","POST");200==o.code?alert("保存成功"):alert(o.message)}}]),app.controller("NoticePayCtr",["$rootScope","$scope","$location","shopFactory",function(e,t,a,o){t.config.class="pay",t.posts=ajaxSendFn({},"/remind/remind","GET").result||{category:"190",enabled:!1},t.postSend=function(){var e=ajaxSendFn(t.posts,"/remind/remind","POST");200==e.code?alert("保存成功"):alert(e.message)}}]);